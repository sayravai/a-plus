{% extends "course/course_base.html" %}
{% load i18n %}
{% load course %}
{% load static %}

{% block title %}{% translate "PARTICIPANTS" %} | {{ block.super }}{% endblock %}
{% block view_tag %}participants{% endblock %}

{% block breadcrumblist %}
{{ block.super }}
<li class="active">{% translate "PARTICIPANTS" %}</li>
<!-- DataTables plugin with Bootstrap 5 styling and Buttons/export support -->
<link href="https://cdn.datatables.net/v/bs5/dt-2.2.1/b-3.2.1/b-html5-3.2.1/datatables.min.css" rel="stylesheet">
<style>
	/*
 * Navigation
 */

.nav-tabs>li.active>a,
.nav-tabs>li.active>a:hover,
.nav-tabs>li.active>a:focus {
	background-color: #A9A9A9 !important;
}

/*
 * Table
 */

 #table-participants-div {
	 max-height: calc(100vh - 12em);
	 max-width: 100vw;
	 margin-top: 6px;
	 overflow: auto; /* internal scroll so header can stick and pagination remains in view */
 }

#table-participants {
	margin-top: 0 !important; /* To overwrite DataTable styling and improve scrolling; replaced with div margin */
}

#table-heading th {
	min-width: 6em;
	width: 15vw;
	max-width: calc(12em + 26px);
	/*background-color: white;*/
	position: -webkit-sticky; /* Safari */
	position: sticky;
	top: 0;
	z-index: 2;
}

#table-heading th.student-id {
	max-width: calc(8em + 26px);
}

#table-heading th.select-box,
#table-heading th.actions-container {
	min-width: 2em;
}

#table-heading th.select-box {
	max-width:2em;
}

#table-heading .form-control { /* Search bars in heading cells */
	min-width: 6em;
	width: min(12em, 14vw);
}

#table-heading th.student-id .form-control,
#table-heading th.total .form-control {
	max-width: 8em;
}

#table-heading th.student-id, #table-heading th.student-id input
{
	max-width: 6em;
}

#table-heading th.stick-on-scroll:not(.indicator-heading) {
    left: 0;
    z-index: 3;
}

#table-heading th.stick-on-scroll.indicator-heading {
	left: 0;
}

tbody td.stick-on-scroll {
    position: -webkit-sticky; /* Safari */
    position: sticky;
    left: 0;
    z-index: 1;
}

#table-heading th.stick-on-scroll:nth-child(2),
tbody td.stick-on-scroll:nth-child(2) {
	left: 6em;
}

table#table-points thead td div.ratio {
	text-align: right;
	font-style: italic;
	font-weight: normal;
}
table#table-points thead td div.ratio::after {
	content: "%";
}

.student-id,
.student-name,
#table-heading th.indicator-heading {
    font-weight: bold;
}

div.dt-note {
    padding-top: 8px;
    white-space: nowrap;
	text-align: right;
}

span.colortag.label-xs {
	font-size: 0.75em; /* Bootstrap default badge font size for .badge-xs */
}

</style>
{% endblock %}

{% block columns %}
<div class="col-md-12">

	{% if is_teacher %}
	<p>
		<a class="aplus-button--default aplus-button--sm" role="button" href="{{ instance|url:'enroll-students' }}">
			<i class="bi-person-fill" aria-hidden="true"></i>
			{% translate "ENROLL_STUDENTS" %}
		</a>
	</p>
	{% endif %}
	<p class="filter-users">
		<small class="text-body-secondary">{% trans "FILTER_USERS_BY_TAG" %}:</small>
		{% for tag in tags %}
		<button
			class="btn btn-sm filter-tag"
			style="background-color:{{ tag.color }};color:{{ tag.font_color }};"
			data-tagslug="{{ tag.slug }}"
			data-tagid="{{ tag.id }}"
			data-tagname="{{ tag.name }}"
			data-font-white="{{ tag.font_white|yesno:'1,0' }}"
			data-color="{{ tag.color }}"
			data-font-color="{{ tag.font_color }}"
		>
			<i class="bi-square" aria-hidden="true"></i>
			{{ tag.name }}
		</button>
		{% endfor %}
		<small class="text-body-secondary">{% trans "FILTER_USERS_BY_STATUS" %}:</small>
		{% for status_code, status_label in enrollment_statuses.items %}
		<button class="btn aplus-button--xs aplus-button--secondary filter-status" data-status="{{ status_code }}">
			{% if status_code == 'ACTIVE' %}
			<i class="bi-check-square" aria-hidden="true"></i>
			{% else %}
			<i class="bi-square" aria-hidden="true"></i>
			{% endif %}
			{{ status_label }}
		</button>
		{% endfor %}
	</p>

	<p>
		{% trans "NUMBER_OF_ENROLLED_STUDENTS" %} <strong id="active-participants-number"></strong>
		({% trans "PENDING_STUDENTS" %} <strong id="pending-participants-number"></strong>,
		{% trans "REMOVED_STUDENTS" %} <strong id="removed-participants-number"></strong>,
		{% trans "BANNED_STUDENTS" %} <strong id="banned-participants-number"></strong>).
		{% if is_teacher %}
		{% translate "OF_WHICH_SELECTED" %} <strong id="selected-number">0</strong>
		<button type="button" id="add-tag-selected" class="aplus-button--primary aplus-button--sm ms-2" disabled>
			<i class="bi-tag" aria-hidden="true"></i>
			{% translate "ADD_TAG" %}
		</button>
		{% endif %}
	</p>

	<div id="participants-table-container" class="table-responsive">
		<table id="table-participants" class="table table-sm">
			<thead id="table-heading"></thead>
			<tbody id="participants">
			</tbody>
		</table>
	</div>

</div>

<!-- Add Tag modal -->
<div
	class="modal"
	id="tag-add-modal"
	tabindex="-1"
	role="dialog"
	aria-labelledby="tag-add-modal-label"
>
	<div class="modal-dialog" role="document">
		<div class="modal-content">
			<div class="modal-header">
				<h4 class="modal-title" id="tag-add-modal-label">
					{% translate "ADD_TAG" %}
				</h4>
				<button
					type="button"
					class="btn-close"
					data-bs-dismiss="modal"
					aria-label="close"
				>
				</button>
			</div>
			<div class="modal-body">
				<div class="mb-3">
					<label for="tag-add-select" class="form-label">{% translate "SELECT_TAG" %}</label>
					<select id="tag-add-select" class="form-select">
						<!-- options populated by JS from filter buttons -->
					</select>
				</div>
				<div class="text-body-secondary">
					<span id="tag-add-target-count">0</span>
					{% translate "USERS_SELECTED" %}
				</div>
			</div>
			<div class="modal-footer">
				<button
					type="button"
					class="aplus-button--secondary aplus-button--md"
					data-bs-dismiss="modal"
				>
					{% translate "CANCEL" %}
				</button>
				<button
					type="button"
					class="aplus-button--primary aplus-button--md"
					id="tag-add-confirm"
				>
					{% translate "ADD" %}
				</button>
			</div>
		</div>
	</div>
</div>

<div
	class="modal"
	id="enrollment-remove-modal"
	tabindex="-1"
	role="dialog"
	aria-labelledby="enrollment-remove-modal-label"
>
	<div class="modal-dialog" role="document">
		<div class="modal-content">
			<div class="modal-header">
				<h4 class="modal-title" id="enrollment-remove-modal-label">
					<span id="enrollment-remove-modal-remove-title">
						{% translate "ENROLLMENT_REMOVE_MODAL_REMOVE_TITLE" %}
					</span>
					<span id="enrollment-remove-modal-ban-title">
						{% translate "ENROLLMENT_REMOVE_MODAL_BAN_TITLE" %}
					</span>
				</h4>
				<button
					type="button"
					class="btn-close"
					data-bs-dismiss="modal"
					aria-label="close"
				>
				</button>
			</div>
			<div class="modal-body">
				<div id="enrollment-remove-modal-remove-description">
					{% translate "ENROLLMENT_REMOVE_MODAL_REMOVE_DESCRIPTION" %}
				</div>
				<div id="enrollment-remove-modal-ban-description">
					{% translate "ENROLLMENT_REMOVE_MODAL_BAN_DESCRIPTION" %}
				</div>
				<div>
					<strong id="enrollment-remove-modal-user"></strong>
				</div>
			</div>
			<div class="modal-footer">
				<button
					type="button"
					class="aplus-button--secondary aplus-button--md"
					data-bs-dismiss="modal"
				>
					{% translate "CANCEL" %}
				</button>
				<button
					type="button"
					class="aplus-button--danger aplus-button--md"
					data-bs-dismiss="modal"
					id="enrollment-remove-modal-button"
				>
				</button>
			</div>
		</div>
	</div>
</div>
{% include 'course/staff/_tag_remove_modal.html' %}
{% endblock %}

{% block scripts %}
{{ block.super }}
{% if is_teacher %}
<script src="https://cdn.datatables.net/v/bs5/dt-2.2.1/b-3.2.1/b-html5-3.2.1/datatables.min.js"></script>

<script src="{% static 'django_colortag.js' %}"></script>
<script src="{% static 'add_tagging_dropdown.js' %}"></script>
<script src="{% static 'js/buttons_popover.js' %}"></script>
<script src="{% static 'js/tag_popover.js' %}"></script>
{% endif %}

<script src="{% static 'js/participants.js' %}"></script>
<!--<script src="{% static 'course/usertagdropdown.js' %}"></script>-->
<script>
$(function () {
	const participants = {{ participants|escape_slashes|safe }};
	const api_url = "{% url 'api:course-detail' 2 instance.id %}";
	const is_teacher = {{ is_teacher|yesno:"true,false" }};
	const enrollment_statuses = {{ enrollment_statuses_json|escape_slashes|safe }};
	participants_list(participants, api_url, is_teacher, enrollment_statuses);
});
</script>

{% endblock %}
