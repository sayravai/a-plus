

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>external_services.api.tests &mdash; A+ 1.28 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=3011ec97"></script>
      <script src="../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            A+
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <!-- Local TOC -->
              <div class="local-toc"></div>
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">A+</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">external_services.api.tests</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for external_services.api.tests</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span><span class="w"> </span><span class="nn">datetime</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">django.contrib.auth.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">User</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.utils.formats</span><span class="w"> </span><span class="kn">import</span> <span class="n">date_format</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">timezone</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">lxml</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">oauthlib.oauth1</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">rest_framework</span><span class="w"> </span><span class="kn">import</span> <span class="n">status</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">rest_framework.test</span><span class="w"> </span><span class="kn">import</span> <span class="n">APITestCase</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">course.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">Course</span><span class="p">,</span> <span class="n">CourseInstance</span><span class="p">,</span> <span class="n">CourseModule</span><span class="p">,</span> <span class="n">Enrollment</span><span class="p">,</span> <span class="n">LearningObjectCategory</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">exercise.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">LTIExercise</span><span class="p">,</span> <span class="n">Submission</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">external_services.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">LTIService</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">userprofile.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">UserProfile</span><span class="p">,</span> <span class="n">LTIServiceUser</span>

<span class="c1"># disable logging so that the log messages do not clutter the test output</span>
<span class="n">logging</span><span class="o">.</span><span class="n">disable</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">CRITICAL</span><span class="p">)</span>

<div class="viewcode-block" id="LTIOutcomesBaseTest">
<a class="viewcode-back" href="../../../external_services.api.html#external_services.api.tests.LTIOutcomesBaseTest">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">LTIOutcomesBaseTest</span><span class="p">(</span><span class="n">APITestCase</span><span class="p">):</span>
    <span class="n">OUTCOMES_API_URL</span> <span class="o">=</span> <span class="s1">&#39;/api/v2/lti-outcomes&#39;</span>

    <span class="c1"># XML for a request body</span>
    <span class="n">BASE_OUTCOMES_REQUEST_XML</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="s1">&lt;imsx_POXEnvelopeRequest xmlns=&quot;http://www.imsglobal.org/services/ltiv1p1/xsd/imsoms_v1p0&quot;&gt;</span>
<span class="s1">  &lt;imsx_POXHeader&gt;</span>
<span class="s1">    &lt;imsx_POXRequestHeaderInfo&gt;</span>
<span class="s1">      &lt;imsx_version&gt;V1.0&lt;/imsx_version&gt;</span>
<span class="s1">      &lt;imsx_messageIdentifier&gt;</span><span class="si">{msg_id}</span><span class="s1">&lt;/imsx_messageIdentifier&gt;</span>
<span class="s1">    &lt;/imsx_POXRequestHeaderInfo&gt;</span>
<span class="s1">  &lt;/imsx_POXHeader&gt;</span>
<span class="s1">  &lt;imsx_POXBody&gt;</span>
<span class="s1">    &lt;</span><span class="si">{operation}</span><span class="s1">Request&gt;</span>
<span class="s1">      &lt;resultRecord&gt;</span>
<span class="s1">        &lt;sourcedGUID&gt;</span>
<span class="s1">          &lt;sourcedId&gt;</span><span class="si">{sourced_id}</span><span class="s1">&lt;/sourcedId&gt;</span>
<span class="s1">        &lt;/sourcedGUID&gt;</span>
<span class="s1">        </span><span class="si">{result}</span>
<span class="s1">      &lt;/resultRecord&gt;</span>
<span class="s1">    &lt;/</span><span class="si">{operation}</span><span class="s1">Request&gt;</span>
<span class="s1">  &lt;/imsx_POXBody&gt;</span>
<span class="s1">&lt;/imsx_POXEnvelopeRequest&gt;&#39;&#39;&#39;</span>

    <span class="c1"># replaceResult requests and readResult responses must also include the result</span>
    <span class="n">BASE_RESULT_XML</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;&lt;result&gt;</span>
<span class="s1">          &lt;resultScore&gt;</span>
<span class="s1">            &lt;language&gt;en&lt;/language&gt;</span>
<span class="s1">            &lt;textString&gt;</span><span class="si">{score}</span><span class="s1">&lt;/textString&gt;</span>
<span class="s1">          &lt;/resultScore&gt;</span>
<span class="s1">        &lt;/result&gt;&#39;&#39;&#39;</span>

    <span class="n">BASE_OUTCOMES_RESPONSE_XML</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="s1">&lt;imsx_POXEnvelopeResponse xmlns=&quot;http://www.imsglobal.org/services/ltiv1p1/xsd/imsoms_v1p0&quot;&gt;</span>
<span class="s1">  &lt;imsx_POXHeader&gt;</span>
<span class="s1">    &lt;imsx_POXResponseHeaderInfo&gt;</span>
<span class="s1">      &lt;imsx_version&gt;V1.0&lt;/imsx_version&gt;</span>
<span class="s1">      &lt;imsx_messageIdentifier&gt;</span><span class="si">{msg_id}</span><span class="s1">&lt;/imsx_messageIdentifier&gt;</span>
<span class="s1">      &lt;imsx_statusInfo&gt;</span>
<span class="s1">        &lt;imsx_codeMajor&gt;</span><span class="si">{code_major}</span><span class="s1">&lt;/imsx_codeMajor&gt;</span>
<span class="s1">        &lt;imsx_severity&gt;</span><span class="si">{severity}</span><span class="s1">&lt;/imsx_severity&gt;</span>
<span class="s1">        &lt;imsx_description&gt;</span><span class="si">{description}</span><span class="s1">&lt;/imsx_description&gt;</span>
<span class="s1">        &lt;imsx_messageRefIdentifier&gt;</span><span class="si">{msg_ref_id}</span><span class="s1">&lt;/imsx_messageRefIdentifier&gt;</span>
<span class="s1">        &lt;imsx_operationRefIdentifier&gt;</span><span class="si">{operation_ref}</span><span class="s1">&lt;/imsx_operationRefIdentifier&gt;</span>
<span class="s1">        </span><span class="si">{extra_status}</span>
<span class="s1">      &lt;/imsx_statusInfo&gt;</span>
<span class="s1">    &lt;/imsx_POXResponseHeaderInfo&gt;</span>
<span class="s1">  &lt;/imsx_POXHeader&gt;</span>
<span class="s1">  &lt;imsx_POXBody&gt;</span>
<span class="s1">    </span><span class="si">{body}</span>
<span class="s1">  &lt;/imsx_POXBody&gt;</span>
<span class="s1">&lt;/imsx_POXEnvelopeResponse&gt;&#39;&#39;&#39;</span>

    <span class="c1"># assert method for comparing Outcomes response XML messages</span>
    <span class="c1"># pylint: disable-next=too-many-locals</span>
<div class="viewcode-block" id="LTIOutcomesBaseTest.assertLTIOutcomesResponseXMLEqual">
<a class="viewcode-back" href="../../../external_services.api.html#external_services.api.tests.LTIOutcomesBaseTest.assertLTIOutcomesResponseXMLEqual">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">assertLTIOutcomesResponseXMLEqual</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">got_xml</span><span class="p">,</span> <span class="n">expected_xml</span><span class="p">,</span> <span class="n">ignore_elems</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">got_root</span> <span class="o">=</span> <span class="n">lxml</span><span class="o">.</span><span class="n">etree</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">got_xml</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span> <span class="c1"># pylint: disable=c-extension-no-member</span>
            <span class="n">expected_root</span> <span class="o">=</span> <span class="n">lxml</span><span class="o">.</span><span class="n">etree</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">expected_xml</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span> <span class="c1"># pylint: disable=c-extension-no-member</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s1">&#39;XML parsing failed: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>

        <span class="n">ns</span> <span class="o">=</span> <span class="s1">&#39;{http://www.imsglobal.org/services/ltiv1p1/xsd/imsoms_v1p0}&#39;</span>
        <span class="k">for</span> <span class="n">status_elem</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;imsx_codeMajor&#39;</span><span class="p">,</span> <span class="s1">&#39;imsx_severity&#39;</span><span class="p">,</span> <span class="s1">&#39;imsx_description&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;imsx_messageRefIdentifier&#39;</span><span class="p">,</span> <span class="s1">&#39;imsx_operationRefIdentifier&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;imsx_codeMinor&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">ignore_elems</span> <span class="ow">and</span> <span class="n">status_elem</span> <span class="ow">in</span> <span class="n">ignore_elems</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">query</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{ns}</span><span class="s1">imsx_POXHeader/</span><span class="si">{ns}</span><span class="s1">imsx_POXResponseHeaderInfo/</span><span class="si">{ns}</span><span class="s1">imsx_statusInfo/</span><span class="si">{ns}{status_elem}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">ns</span><span class="o">=</span><span class="n">ns</span><span class="p">,</span> <span class="n">status_elem</span><span class="o">=</span><span class="n">status_elem</span><span class="p">)</span>
            <span class="n">expected_val</span> <span class="o">=</span> <span class="n">expected_root</span><span class="o">.</span><span class="n">findtext</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
            <span class="n">got_val</span> <span class="o">=</span> <span class="n">got_root</span><span class="o">.</span><span class="n">findtext</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">got_val</span><span class="p">,</span> <span class="n">expected_val</span><span class="p">,</span> <span class="n">status_elem</span> <span class="o">+</span> <span class="s1">&#39; not equal&#39;</span><span class="p">)</span>

        <span class="n">query</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{ns}</span><span class="s1">imsx_POXHeader/</span><span class="si">{ns}</span><span class="s1">imsx_POXResponseHeaderInfo/</span><span class="si">{ns}</span><span class="s1">imsx_version&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ns</span><span class="o">=</span><span class="n">ns</span><span class="p">)</span>
        <span class="n">exp_version</span> <span class="o">=</span> <span class="n">expected_root</span><span class="o">.</span><span class="n">findtext</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="n">got_version</span> <span class="o">=</span> <span class="n">got_root</span><span class="o">.</span><span class="n">findtext</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">got_version</span><span class="p">,</span> <span class="n">exp_version</span><span class="p">)</span>

        <span class="c1"># random, can not know beforehand</span>
        <span class="n">got_msg_id</span> <span class="o">=</span> <span class="n">got_root</span><span class="o">.</span><span class="n">findtext</span><span class="p">(</span>
            <span class="s1">&#39;</span><span class="si">{ns}</span><span class="s1">imsx_POXHeader/</span><span class="si">{ns}</span><span class="s1">imsx_POXResponseHeaderInfo/</span><span class="si">{ns}</span><span class="s1">imsx_messageIdentifier&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ns</span><span class="o">=</span><span class="n">ns</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertNotEqual</span><span class="p">(</span><span class="n">got_msg_id</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">got_msg_id</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>

        <span class="n">query</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{ns}</span><span class="s1">imsx_POXBody&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ns</span><span class="o">=</span><span class="n">ns</span><span class="p">)</span>
        <span class="n">exp_body</span> <span class="o">=</span> <span class="n">expected_root</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="n">got_body</span> <span class="o">=</span> <span class="n">got_root</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="c1"># number of children</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">exp_body</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">got_body</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">exp_body</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">exp_body</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tag</span><span class="p">,</span> <span class="n">got_body</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tag</span><span class="p">)</span>
        <span class="c1"># only readResultResponses have some real content in the body</span>
        <span class="n">exp_readResult</span> <span class="o">=</span> <span class="n">expected_root</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{ns}</span><span class="s1">imsx_POXBody/</span><span class="si">{ns}</span><span class="s1">readResultResponse&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ns</span><span class="o">=</span><span class="n">ns</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">exp_readResult</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{ns}</span><span class="s1">imsx_POXBody/</span><span class="si">{ns}</span><span class="s1">readResultResponse/</span><span class="si">{ns}</span><span class="s1">result/</span><span class="si">{ns}</span><span class="s1">resultScore/</span><span class="si">{ns}</span><span class="s1">textString&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ns</span><span class="o">=</span><span class="n">ns</span><span class="p">)</span>
            <span class="n">exp_score</span> <span class="o">=</span> <span class="n">expected_root</span><span class="o">.</span><span class="n">findtext</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
            <span class="n">got_score</span> <span class="o">=</span> <span class="n">got_root</span><span class="o">.</span><span class="n">findtext</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">got_score</span><span class="p">,</span> <span class="n">exp_score</span><span class="p">)</span>

            <span class="n">query</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{ns}</span><span class="s1">imsx_POXBody/</span><span class="si">{ns}</span><span class="s1">readResultResponse/</span><span class="si">{ns}</span><span class="s1">result/</span><span class="si">{ns}</span><span class="s1">resultScore/</span><span class="si">{ns}</span><span class="s1">language&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ns</span><span class="o">=</span><span class="n">ns</span><span class="p">)</span>
            <span class="n">got_lang</span> <span class="o">=</span> <span class="n">got_root</span><span class="o">.</span><span class="n">findtext</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">got_lang</span><span class="p">,</span> <span class="s1">&#39;en&#39;</span><span class="p">)</span> <span class="c1"># specification requires &quot;en&quot;</span></div>


<div class="viewcode-block" id="LTIOutcomesBaseTest.mk_sourced_id">
<a class="viewcode-back" href="../../../external_services.api.html#external_services.api.tests.LTIOutcomesBaseTest.mk_sourced_id">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">mk_sourced_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lti_exercise</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">enrollment</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">enrollment</span> <span class="ow">and</span> <span class="n">lti_exercise</span><span class="o">.</span><span class="n">lti_service</span><span class="o">.</span><span class="n">is_anonymous</span><span class="p">:</span>
            <span class="n">user_id</span> <span class="o">=</span> <span class="s1">&#39;a&#39;</span> <span class="o">+</span> <span class="n">enrollment</span><span class="o">.</span><span class="n">anon_id</span>
        <span class="k">elif</span> <span class="n">user</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">lti_exercise</span><span class="o">.</span><span class="n">lti_service</span><span class="o">.</span><span class="n">is_anonymous</span><span class="p">:</span>
            <span class="n">user_id</span> <span class="o">=</span> <span class="s1">&#39;i&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">user_id</span> <span class="o">=</span> <span class="s1">&#39;unknown&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s1">&#39;mk_sourced_id requires the enrollment argument for anonymous LTI services and user otherwise.&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">-</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">lti_exercise</span><span class="o">.</span><span class="n">pk</span><span class="p">,</span> <span class="n">user_id</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="LTIOutcomesTests">
<a class="viewcode-back" href="../../../external_services.api.html#external_services.api.tests.LTIOutcomesTests">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">LTIOutcomesTests</span><span class="p">(</span><span class="n">LTIOutcomesBaseTest</span><span class="p">):</span>

<div class="viewcode-block" id="LTIOutcomesTests.setUpTestData">
<a class="viewcode-back" href="../../../external_services.api.html#external_services.api.tests.LTIOutcomesTests.setUpTestData">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">setUpTestData</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">now</span> <span class="o">=</span> <span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">year_before</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">now</span> <span class="o">-</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">365</span><span class="p">)</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">year_after</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">now</span> <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">365</span><span class="p">)</span>

        <span class="bp">cls</span><span class="o">.</span><span class="n">student1</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create_user</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s1">&#39;student1&#39;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s1">&#39;123456&#39;</span><span class="p">)</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">student1_profile</span> <span class="o">=</span> <span class="n">UserProfile</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="n">student1</span><span class="p">)</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">student1_profile</span><span class="o">.</span><span class="n">student_id</span> <span class="o">=</span> <span class="s1">&#39;123456&#39;</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">student1_profile</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

        <span class="bp">cls</span><span class="o">.</span><span class="n">lti_service</span> <span class="o">=</span> <span class="n">LTIService</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">url</span><span class="o">=</span><span class="s1">&#39;http://localhost:8080/lti-launch&#39;</span><span class="p">,</span> <span class="c1"># fake URL</span>
            <span class="n">consumer_key</span><span class="o">=</span><span class="s1">&#39;apluskey&#39;</span><span class="p">,</span>
            <span class="n">consumer_secret</span><span class="o">=</span><span class="s1">&#39;aplussecret&#39;</span><span class="p">,</span>
            <span class="n">access_settings</span><span class="o">=</span><span class="n">LTIService</span><span class="o">.</span><span class="n">LTI_ACCESS</span><span class="o">.</span><span class="n">ANON_API_NO</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">course</span> <span class="o">=</span> <span class="n">Course</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Test course&#39;</span><span class="p">,</span>
            <span class="n">code</span><span class="o">=</span><span class="s1">&#39;test&#39;</span><span class="p">,</span>
            <span class="n">url</span><span class="o">=</span><span class="s1">&#39;test&#39;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">course_instance</span> <span class="o">=</span> <span class="n">CourseInstance</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">course</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="n">course</span><span class="p">,</span>
            <span class="n">instance_name</span><span class="o">=</span><span class="s1">&#39;Test&#39;</span><span class="p">,</span>
            <span class="n">url</span><span class="o">=</span><span class="s1">&#39;test&#39;</span><span class="p">,</span>
            <span class="n">starting_time</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="n">year_before</span><span class="p">,</span>
            <span class="n">ending_time</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="n">year_after</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">student1_enrollment</span> <span class="o">=</span> <span class="n">Enrollment</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">course_instance</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="n">course_instance</span><span class="p">,</span>
            <span class="n">user_profile</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="n">student1_profile</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">course_module</span> <span class="o">=</span> <span class="n">CourseModule</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Module 1&#39;</span><span class="p">,</span>
            <span class="n">url</span><span class="o">=</span><span class="s1">&#39;module1&#39;</span><span class="p">,</span>
            <span class="n">course_instance</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="n">course_instance</span><span class="p">,</span>
            <span class="n">opening_time</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="n">year_before</span><span class="p">,</span>
            <span class="n">closing_time</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="n">year_after</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">category</span> <span class="o">=</span> <span class="n">LearningObjectCategory</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;LTI exercises&#39;</span><span class="p">,</span>
            <span class="n">course_instance</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="n">course_instance</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">lti_exercise</span> <span class="o">=</span> <span class="n">LTIExercise</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;LTI exercise 1&#39;</span><span class="p">,</span>
            <span class="n">category</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="n">category</span><span class="p">,</span>
            <span class="n">course_module</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="n">course_module</span><span class="p">,</span>
            <span class="n">url</span><span class="o">=</span><span class="s1">&#39;ltiex1&#39;</span><span class="p">,</span>
            <span class="n">max_points</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
            <span class="n">lti_service</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="n">lti_service</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">lti_exercise2</span> <span class="o">=</span> <span class="n">LTIExercise</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;LTI exercise 2&#39;</span><span class="p">,</span>
            <span class="n">category</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="n">category</span><span class="p">,</span>
            <span class="n">course_module</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="n">course_module</span><span class="p">,</span>
            <span class="n">url</span><span class="o">=</span><span class="s1">&#39;ltiex2&#39;</span><span class="p">,</span>
            <span class="n">max_points</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
            <span class="n">max_submissions</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
            <span class="n">lti_service</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="n">lti_service</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">lti_user1</span> <span class="o">=</span> <span class="n">LTIServiceUser</span><span class="p">(</span>
            <span class="n">exercise</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="n">lti_exercise</span><span class="p">,</span>
            <span class="n">lti_service</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="n">lti_service</span><span class="p">,</span>
            <span class="n">user_id</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="n">student1</span><span class="o">.</span><span class="n">id</span>
        <span class="p">)</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">lti_user2</span> <span class="o">=</span> <span class="n">LTIServiceUser</span><span class="p">(</span>
            <span class="n">exercise</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="n">lti_exercise2</span><span class="p">,</span>
            <span class="n">lti_service</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="n">lti_service</span><span class="p">,</span>
            <span class="n">user_id</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="n">student1</span><span class="o">.</span><span class="n">id</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="LTIOutcomesTests.test_replaceResult">
<a class="viewcode-back" href="../../../external_services.api.html#external_services.api.tests.LTIOutcomesTests.test_replaceResult">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_replaceResult</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">sourced_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mk_sourced_id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lti_exercise</span><span class="p">,</span> <span class="n">enrollment</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">student1_enrollment</span><span class="p">)</span>
        <span class="n">req_xml</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BASE_OUTCOMES_REQUEST_XML</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">msg_id</span><span class="o">=</span><span class="s1">&#39;fudyhsgysywe374628mfgu&#39;</span><span class="p">,</span>
            <span class="n">operation</span><span class="o">=</span><span class="s1">&#39;replaceResult&#39;</span><span class="p">,</span>
            <span class="n">sourced_id</span><span class="o">=</span><span class="n">sourced_id</span><span class="p">,</span>
            <span class="n">result</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">BASE_RESULT_XML</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">score</span><span class="o">=</span><span class="s1">&#39;0.71&#39;</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="c1"># OAuth1 signature and body hash for the HTTP request Authorization header</span>
        <span class="n">oauth_client</span> <span class="o">=</span> <span class="n">oauthlib</span><span class="o">.</span><span class="n">oauth1</span><span class="o">.</span><span class="n">Client</span><span class="p">(</span>
            <span class="n">client_key</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lti_service</span><span class="o">.</span><span class="n">consumer_key</span><span class="p">,</span>
            <span class="n">client_secret</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lti_service</span><span class="o">.</span><span class="n">consumer_secret</span><span class="p">,</span>
            <span class="n">signature_method</span><span class="o">=</span><span class="n">oauthlib</span><span class="o">.</span><span class="n">oauth1</span><span class="o">.</span><span class="n">SIGNATURE_HMAC</span><span class="p">,</span>
            <span class="n">signature_type</span><span class="o">=</span><span class="n">oauthlib</span><span class="o">.</span><span class="n">oauth1</span><span class="o">.</span><span class="n">SIGNATURE_TYPE_AUTH_HEADER</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># pylint: disable-next=unused-variable</span>
        <span class="n">oa_uri</span><span class="p">,</span> <span class="n">oa_headers</span><span class="p">,</span> <span class="n">oa_body</span> <span class="o">=</span> <span class="n">oauth_client</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="s1">&#39;http://aplus.local/api/v2/lti-outcomes&#39;</span><span class="p">,</span>
            <span class="n">http_method</span><span class="o">=</span><span class="s1">&#39;POST&#39;</span><span class="p">,</span>
            <span class="n">body</span><span class="o">=</span><span class="n">req_xml</span><span class="p">,</span>
            <span class="n">headers</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;Content-Type&#39;</span><span class="p">:</span> <span class="s1">&#39;application/xml&#39;</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">)</span>

        <span class="c1"># make the test request</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">OUTCOMES_API_URL</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">req_xml</span><span class="p">,</span> <span class="n">content_type</span><span class="o">=</span><span class="s1">&#39;application/xml&#39;</span><span class="p">,</span>
                         <span class="n">HTTP_AUTHORIZATION</span><span class="o">=</span><span class="n">oa_headers</span><span class="p">[</span><span class="s1">&#39;Authorization&#39;</span><span class="p">],</span>
                         <span class="n">SERVER_NAME</span><span class="o">=</span><span class="s1">&#39;aplus.local&#39;</span><span class="p">)</span>
        <span class="n">response_xml</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="n">root</span> <span class="o">=</span> <span class="n">lxml</span><span class="o">.</span><span class="n">etree</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">response_xml</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span> <span class="c1"># pylint: disable=c-extension-no-member</span>
        <span class="n">response_msg_id</span> <span class="o">=</span> <span class="n">root</span><span class="o">.</span><span class="n">findtext</span><span class="p">(</span>
            <span class="s1">&#39;</span><span class="si">{ns}</span><span class="s1">imsx_POXHeader/</span><span class="si">{ns}</span><span class="s1">imsx_POXResponseHeaderInfo/</span><span class="si">{ns}</span><span class="s1">imsx_messageIdentifier&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">ns</span><span class="o">=</span><span class="s1">&#39;{http://www.imsglobal.org/services/ltiv1p1/xsd/imsoms_v1p0}&#39;</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="n">expected_response_xml</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BASE_OUTCOMES_RESPONSE_XML</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">msg_id</span><span class="o">=</span><span class="n">response_msg_id</span><span class="p">,</span> <span class="c1"># random, can not know beforehand</span>
            <span class="n">code_major</span><span class="o">=</span><span class="s1">&#39;success&#39;</span><span class="p">,</span>
            <span class="n">severity</span><span class="o">=</span><span class="s1">&#39;status&#39;</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s1">&#39;Score </span><span class="si">{}</span><span class="s1"> added to sourcedId </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;0.71&#39;</span><span class="p">,</span> <span class="n">sourced_id</span><span class="p">),</span>
            <span class="n">msg_ref_id</span><span class="o">=</span><span class="s1">&#39;fudyhsgysywe374628mfgu&#39;</span><span class="p">,</span>
            <span class="n">operation_ref</span><span class="o">=</span><span class="s1">&#39;replaceResult&#39;</span><span class="p">,</span>
            <span class="n">extra_status</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="n">body</span><span class="o">=</span><span class="s1">&#39;&lt;replaceResultResponse/&gt;&#39;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">maxDiff</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertXMLEqual</span><span class="p">(</span><span class="n">response_xml</span><span class="p">,</span> <span class="n">expected_response_xml</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="n">status</span><span class="o">.</span><span class="n">HTTP_200_OK</span><span class="p">)</span>

        <span class="c1"># find the new submission in the database and check its points</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Submission</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;there should be only one submission&#39;</span><span class="p">)</span>
        <span class="n">submission</span> <span class="o">=</span> <span class="n">Submission</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">submission</span><span class="o">.</span><span class="n">grade</span><span class="p">,</span> <span class="mi">71</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">submission</span><span class="o">.</span><span class="n">feedback</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">submission</span><span class="o">.</span><span class="n">status</span><span class="p">,</span> <span class="s1">&#39;ready&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">submission</span><span class="o">.</span><span class="n">submitters</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">submission</span><span class="o">.</span><span class="n">submitters</span><span class="o">.</span><span class="n">first</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">student1_profile</span><span class="p">)</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">submission</span><span class="o">.</span><span class="n">submission_time</span> <span class="o">&lt;</span> <span class="n">now</span> <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">submission</span><span class="o">.</span><span class="n">submission_time</span> <span class="o">&gt;</span> <span class="n">now</span> <span class="o">-</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">submission</span><span class="o">.</span><span class="n">grading_data</span><span class="p">,</span> <span class="p">{</span>
            <span class="s1">&#39;score&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;0.71&#39;</span><span class="p">),</span>
            <span class="s1">&#39;lti_msgid&#39;</span><span class="p">:</span> <span class="s1">&#39;fudyhsgysywe374628mfgu&#39;</span><span class="p">,</span>
            <span class="s1">&#39;sourced_id&#39;</span><span class="p">:</span> <span class="n">sourced_id</span><span class="p">,</span>
        <span class="p">})</span></div>


<div class="viewcode-block" id="LTIOutcomesTests.test_readResult">
<a class="viewcode-back" href="../../../external_services.api.html#external_services.api.tests.LTIOutcomesTests.test_readResult">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_readResult</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># create submissions in the database</span>
        <span class="n">sourced_id1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mk_sourced_id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lti_exercise</span><span class="p">,</span> <span class="n">enrollment</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">student1_enrollment</span><span class="p">)</span>
        <span class="n">submission1</span> <span class="o">=</span> <span class="n">Submission</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">exercise</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lti_exercise</span><span class="p">,</span>
            <span class="n">status</span><span class="o">=</span><span class="n">Submission</span><span class="o">.</span><span class="n">STATUS</span><span class="o">.</span><span class="n">READY</span><span class="p">,</span>
            <span class="n">grade</span><span class="o">=</span><span class="mi">46</span><span class="p">,</span>
            <span class="n">grading_time</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">now</span><span class="p">,</span>
            <span class="n">grading_data</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;score&#39;</span><span class="p">:</span> <span class="s1">&#39;0.46&#39;</span><span class="p">,</span>
                <span class="s1">&#39;lti_msgid&#39;</span><span class="p">:</span> <span class="s1">&#39;ifhdye73yjdnhwy&#39;</span><span class="p">,</span>
                <span class="s1">&#39;sourced_id&#39;</span><span class="p">:</span> <span class="n">sourced_id1</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">)</span>
        <span class="n">submission1</span><span class="o">.</span><span class="n">submitters</span><span class="o">.</span><span class="n">set</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">student1_profile</span><span class="p">])</span>

        <span class="c1"># second submission in the same exercise</span>
        <span class="n">sourced_id2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mk_sourced_id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lti_exercise</span><span class="p">,</span> <span class="n">enrollment</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">student1_enrollment</span><span class="p">)</span>
        <span class="n">submission2</span> <span class="o">=</span> <span class="n">Submission</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">exercise</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lti_exercise</span><span class="p">,</span>
            <span class="n">status</span><span class="o">=</span><span class="n">Submission</span><span class="o">.</span><span class="n">STATUS</span><span class="o">.</span><span class="n">READY</span><span class="p">,</span>
            <span class="n">grade</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
            <span class="n">grading_time</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">now</span><span class="p">,</span>
            <span class="n">grading_data</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;score&#39;</span><span class="p">:</span> <span class="s1">&#39;0.20&#39;</span><span class="p">,</span>
                <span class="s1">&#39;lti_msgid&#39;</span><span class="p">:</span> <span class="s1">&#39;kfofi8ey7dbndu&#39;</span><span class="p">,</span>
                <span class="s1">&#39;sourced_id&#39;</span><span class="p">:</span> <span class="n">sourced_id2</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">)</span>
        <span class="n">submission2</span><span class="o">.</span><span class="n">submitters</span><span class="o">.</span><span class="n">set</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">student1_profile</span><span class="p">])</span>

        <span class="c1"># different exercise</span>
        <span class="n">sourced_id3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mk_sourced_id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lti_exercise2</span><span class="p">,</span> <span class="n">enrollment</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">student1_enrollment</span><span class="p">)</span>
        <span class="n">submission3</span> <span class="o">=</span> <span class="n">Submission</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">exercise</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lti_exercise2</span><span class="p">,</span>
            <span class="n">status</span><span class="o">=</span><span class="n">Submission</span><span class="o">.</span><span class="n">STATUS</span><span class="o">.</span><span class="n">READY</span><span class="p">,</span>
            <span class="n">grade</span><span class="o">=</span><span class="mi">48</span><span class="p">,</span>
            <span class="n">grading_time</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">now</span><span class="p">,</span>
            <span class="n">grading_data</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;score&#39;</span><span class="p">:</span> <span class="s1">&#39;0.96&#39;</span><span class="p">,</span>
                <span class="s1">&#39;lti_msgid&#39;</span><span class="p">:</span> <span class="s1">&#39;i8463yrfjdbdye63hdksHFisk&#39;</span><span class="p">,</span>
                <span class="s1">&#39;sourced_id&#39;</span><span class="p">:</span> <span class="n">sourced_id3</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">)</span>
        <span class="n">submission3</span><span class="o">.</span><span class="n">submitters</span><span class="o">.</span><span class="n">set</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">student1_profile</span><span class="p">])</span>

        <span class="c1"># make the test request</span>
        <span class="n">req_xml1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BASE_OUTCOMES_REQUEST_XML</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">msg_id</span><span class="o">=</span><span class="s1">&#39;84yfhdbwbnwuwe254&#39;</span><span class="p">,</span>
            <span class="n">operation</span><span class="o">=</span><span class="s1">&#39;readResult&#39;</span><span class="p">,</span>
            <span class="n">sourced_id</span><span class="o">=</span><span class="n">sourced_id1</span><span class="p">,</span>
            <span class="n">result</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">force_authenticate</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lti_user1</span><span class="p">)</span> <span class="c1"># skip OAuth credentials</span>
        <span class="n">response1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">OUTCOMES_API_URL</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">req_xml1</span><span class="p">,</span> <span class="n">content_type</span><span class="o">=</span><span class="s1">&#39;application/xml&#39;</span><span class="p">)</span>
        <span class="n">response_xml1</span> <span class="o">=</span> <span class="n">response1</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>

        <span class="n">expected_response_xml1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BASE_OUTCOMES_RESPONSE_XML</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">msg_id</span><span class="o">=</span><span class="s1">&#39;xxx&#39;</span><span class="p">,</span> <span class="c1"># random, can not know beforehand</span>
            <span class="n">code_major</span><span class="o">=</span><span class="s1">&#39;success&#39;</span><span class="p">,</span>
            <span class="n">severity</span><span class="o">=</span><span class="s1">&#39;status&#39;</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s1">&#39;SourcedId </span><span class="si">{}</span><span class="s1"> has the score </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sourced_id1</span><span class="p">,</span> <span class="s1">&#39;0.460000&#39;</span><span class="p">),</span>
            <span class="n">msg_ref_id</span><span class="o">=</span><span class="s1">&#39;84yfhdbwbnwuwe254&#39;</span><span class="p">,</span>
            <span class="n">operation_ref</span><span class="o">=</span><span class="s1">&#39;readResult&#39;</span><span class="p">,</span>
            <span class="n">extra_status</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="n">body</span><span class="o">=</span><span class="s1">&#39;&lt;readResultResponse&gt;</span><span class="si">{}</span><span class="s1">&lt;/readResultResponse&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">BASE_RESULT_XML</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">score</span><span class="o">=</span><span class="s1">&#39;0.460000&#39;</span><span class="p">)),</span>
        <span class="p">)</span>
        <span class="c1"># compare XML without msg id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertLTIOutcomesResponseXMLEqual</span><span class="p">(</span><span class="n">response_xml1</span><span class="p">,</span> <span class="n">expected_response_xml1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">response1</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="n">status</span><span class="o">.</span><span class="n">HTTP_200_OK</span><span class="p">)</span>

        <span class="c1"># readResult for the second exercise</span>
        <span class="n">req_xml2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BASE_OUTCOMES_REQUEST_XML</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">msg_id</span><span class="o">=</span><span class="s1">&#39;jo8367tjhbcjsuiduo4&#39;</span><span class="p">,</span>
            <span class="n">operation</span><span class="o">=</span><span class="s1">&#39;readResult&#39;</span><span class="p">,</span>
            <span class="n">sourced_id</span><span class="o">=</span><span class="n">sourced_id3</span><span class="p">,</span>
            <span class="n">result</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">force_authenticate</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lti_user2</span><span class="p">)</span>
        <span class="n">response2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">OUTCOMES_API_URL</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">req_xml2</span><span class="p">,</span> <span class="n">content_type</span><span class="o">=</span><span class="s1">&#39;application/xml&#39;</span><span class="p">)</span>
        <span class="n">response_xml2</span> <span class="o">=</span> <span class="n">response2</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>

        <span class="n">expected_response_xml2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BASE_OUTCOMES_RESPONSE_XML</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">msg_id</span><span class="o">=</span><span class="s1">&#39;xxx&#39;</span><span class="p">,</span> <span class="c1"># random, can not know beforehand</span>
            <span class="n">code_major</span><span class="o">=</span><span class="s1">&#39;success&#39;</span><span class="p">,</span>
            <span class="n">severity</span><span class="o">=</span><span class="s1">&#39;status&#39;</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s1">&#39;SourcedId </span><span class="si">{}</span><span class="s1"> has the score </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sourced_id3</span><span class="p">,</span> <span class="s1">&#39;0.960000&#39;</span><span class="p">),</span>
            <span class="n">msg_ref_id</span><span class="o">=</span><span class="s1">&#39;jo8367tjhbcjsuiduo4&#39;</span><span class="p">,</span>
            <span class="n">operation_ref</span><span class="o">=</span><span class="s1">&#39;readResult&#39;</span><span class="p">,</span>
            <span class="n">extra_status</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="n">body</span><span class="o">=</span><span class="s1">&#39;&lt;readResultResponse&gt;</span><span class="si">{}</span><span class="s1">&lt;/readResultResponse&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">BASE_RESULT_XML</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">score</span><span class="o">=</span><span class="s1">&#39;0.960000&#39;</span><span class="p">)),</span>
        <span class="p">)</span>
        <span class="c1"># compare XML without msg id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertLTIOutcomesResponseXMLEqual</span><span class="p">(</span><span class="n">response_xml2</span><span class="p">,</span> <span class="n">expected_response_xml2</span><span class="p">)</span></div>


<div class="viewcode-block" id="LTIOutcomesTests.test_readResult_no_result">
<a class="viewcode-back" href="../../../external_services.api.html#external_services.api.tests.LTIOutcomesTests.test_readResult_no_result">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_readResult_no_result</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># no submissions exist, readResult score is an empty string</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Submission</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">sourced_id1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mk_sourced_id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lti_exercise</span><span class="p">,</span> <span class="n">enrollment</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">student1_enrollment</span><span class="p">)</span>
        <span class="c1"># make the test request</span>
        <span class="n">req_xml1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BASE_OUTCOMES_REQUEST_XML</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">msg_id</span><span class="o">=</span><span class="s1">&#39;jdndu36729qoshs63jfs&#39;</span><span class="p">,</span>
            <span class="n">operation</span><span class="o">=</span><span class="s1">&#39;readResult&#39;</span><span class="p">,</span>
            <span class="n">sourced_id</span><span class="o">=</span><span class="n">sourced_id1</span><span class="p">,</span>
            <span class="n">result</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">force_authenticate</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lti_user1</span><span class="p">)</span> <span class="c1"># skip OAuth credentials</span>
        <span class="n">response1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">OUTCOMES_API_URL</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">req_xml1</span><span class="p">,</span> <span class="n">content_type</span><span class="o">=</span><span class="s1">&#39;application/xml&#39;</span><span class="p">)</span>
        <span class="n">response_xml1</span> <span class="o">=</span> <span class="n">response1</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>

        <span class="n">expected_response_xml1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BASE_OUTCOMES_RESPONSE_XML</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">msg_id</span><span class="o">=</span><span class="s1">&#39;xxx&#39;</span><span class="p">,</span> <span class="c1"># random, can not know beforehand</span>
            <span class="n">code_major</span><span class="o">=</span><span class="s1">&#39;success&#39;</span><span class="p">,</span>
            <span class="n">severity</span><span class="o">=</span><span class="s1">&#39;status&#39;</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s1">&#39;SourcedId </span><span class="si">{}</span><span class="s1"> has the score </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sourced_id1</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
            <span class="n">msg_ref_id</span><span class="o">=</span><span class="s1">&#39;jdndu36729qoshs63jfs&#39;</span><span class="p">,</span>
            <span class="n">operation_ref</span><span class="o">=</span><span class="s1">&#39;readResult&#39;</span><span class="p">,</span>
            <span class="n">extra_status</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="n">body</span><span class="o">=</span><span class="s1">&#39;&lt;readResultResponse&gt;</span><span class="si">{}</span><span class="s1">&lt;/readResultResponse&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">BASE_RESULT_XML</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">score</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)),</span>
        <span class="p">)</span>
        <span class="c1"># compare XML without msg id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertLTIOutcomesResponseXMLEqual</span><span class="p">(</span><span class="n">response_xml1</span><span class="p">,</span> <span class="n">expected_response_xml1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">response1</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="n">status</span><span class="o">.</span><span class="n">HTTP_200_OK</span><span class="p">)</span></div>


<div class="viewcode-block" id="LTIOutcomesTests.test_deleteResult">
<a class="viewcode-back" href="../../../external_services.api.html#external_services.api.tests.LTIOutcomesTests.test_deleteResult">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_deleteResult</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># response states that the deleteResult operation is unsupported and no submission is deleted</span>
        <span class="n">sourced_id1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mk_sourced_id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lti_exercise</span><span class="p">,</span> <span class="n">enrollment</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">student1_enrollment</span><span class="p">)</span>
        <span class="n">submission1</span> <span class="o">=</span> <span class="n">Submission</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">exercise</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lti_exercise</span><span class="p">,</span>
            <span class="n">status</span><span class="o">=</span><span class="n">Submission</span><span class="o">.</span><span class="n">STATUS</span><span class="o">.</span><span class="n">READY</span><span class="p">,</span>
            <span class="n">grade</span><span class="o">=</span><span class="mi">86</span><span class="p">,</span>
            <span class="n">grading_time</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">now</span><span class="p">,</span>
            <span class="n">grading_data</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;score&#39;</span><span class="p">:</span> <span class="s1">&#39;0.86&#39;</span><span class="p">,</span>
                <span class="s1">&#39;lti_msgid&#39;</span><span class="p">:</span> <span class="s1">&#39;khnsdnsdi2743j2&#39;</span><span class="p">,</span>
                <span class="s1">&#39;sourced_id&#39;</span><span class="p">:</span> <span class="n">sourced_id1</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">)</span>
        <span class="n">submission1</span><span class="o">.</span><span class="n">submitters</span><span class="o">.</span><span class="n">set</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">student1_profile</span><span class="p">])</span>

        <span class="c1"># make the test request</span>
        <span class="n">req_xml1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BASE_OUTCOMES_REQUEST_XML</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">msg_id</span><span class="o">=</span><span class="s1">&#39;nvldoe837jslsurkg&#39;</span><span class="p">,</span>
            <span class="n">operation</span><span class="o">=</span><span class="s1">&#39;deleteResult&#39;</span><span class="p">,</span>
            <span class="n">sourced_id</span><span class="o">=</span><span class="n">sourced_id1</span><span class="p">,</span>
            <span class="n">result</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">force_authenticate</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lti_user1</span><span class="p">)</span> <span class="c1"># skip OAuth credentials</span>
        <span class="n">response1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">OUTCOMES_API_URL</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">req_xml1</span><span class="p">,</span> <span class="n">content_type</span><span class="o">=</span><span class="s1">&#39;application/xml&#39;</span><span class="p">)</span>
        <span class="n">response_xml1</span> <span class="o">=</span> <span class="n">response1</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>

        <span class="n">expected_response_xml1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BASE_OUTCOMES_RESPONSE_XML</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">msg_id</span><span class="o">=</span><span class="s1">&#39;xxx&#39;</span><span class="p">,</span> <span class="c1"># random, can not know beforehand</span>
            <span class="n">code_major</span><span class="o">=</span><span class="s1">&#39;unsupported&#39;</span><span class="p">,</span>
            <span class="n">severity</span><span class="o">=</span><span class="s1">&#39;status&#39;</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s1">&#39;deleteResult operation is not supported&#39;</span><span class="p">,</span>
            <span class="n">msg_ref_id</span><span class="o">=</span><span class="s1">&#39;nvldoe837jslsurkg&#39;</span><span class="p">,</span>
            <span class="n">operation_ref</span><span class="o">=</span><span class="s1">&#39;deleteResult&#39;</span><span class="p">,</span>
            <span class="n">extra_status</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="n">body</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="c1"># empty body when status is unsupported</span>
        <span class="p">)</span>
        <span class="c1"># compare XML without msg id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertLTIOutcomesResponseXMLEqual</span><span class="p">(</span><span class="n">response_xml1</span><span class="p">,</span> <span class="n">expected_response_xml1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">response1</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="n">status</span><span class="o">.</span><span class="n">HTTP_200_OK</span><span class="p">)</span>

        <span class="c1"># check that the submission was not deleted</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Submission</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Submission</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">first</span><span class="p">()</span><span class="o">.</span><span class="n">pk</span><span class="p">,</span> <span class="n">submission1</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span></div>


<div class="viewcode-block" id="LTIOutcomesTests.test_replaceResult2">
<a class="viewcode-back" href="../../../external_services.api.html#external_services.api.tests.LTIOutcomesTests.test_replaceResult2">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_replaceResult2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># make 2 requests and check that there are 2 new submissions</span>
        <span class="n">sourced_id1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mk_sourced_id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lti_exercise</span><span class="p">,</span> <span class="n">enrollment</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">student1_enrollment</span><span class="p">)</span>
        <span class="n">req_xml1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BASE_OUTCOMES_REQUEST_XML</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">msg_id</span><span class="o">=</span><span class="s1">&#39;jnvbcvxsrw538r49ri&#39;</span><span class="p">,</span>
            <span class="n">operation</span><span class="o">=</span><span class="s1">&#39;replaceResult&#39;</span><span class="p">,</span>
            <span class="n">sourced_id</span><span class="o">=</span><span class="n">sourced_id1</span><span class="p">,</span>
            <span class="n">result</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">BASE_RESULT_XML</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">score</span><span class="o">=</span><span class="s1">&#39;0.88&#39;</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">force_authenticate</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lti_user1</span><span class="p">)</span> <span class="c1"># skip OAuth credentials</span>
        <span class="n">response1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">OUTCOMES_API_URL</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">req_xml1</span><span class="p">,</span> <span class="n">content_type</span><span class="o">=</span><span class="s1">&#39;application/xml&#39;</span><span class="p">)</span>
        <span class="n">response_xml1</span> <span class="o">=</span> <span class="n">response1</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="n">expected_response_xml1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BASE_OUTCOMES_RESPONSE_XML</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">msg_id</span><span class="o">=</span><span class="s1">&#39;xxxx&#39;</span><span class="p">,</span> <span class="c1"># random, can not know beforehand</span>
            <span class="n">code_major</span><span class="o">=</span><span class="s1">&#39;success&#39;</span><span class="p">,</span>
            <span class="n">severity</span><span class="o">=</span><span class="s1">&#39;status&#39;</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s1">&#39;Score </span><span class="si">{}</span><span class="s1"> added to sourcedId </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;0.88&#39;</span><span class="p">,</span> <span class="n">sourced_id1</span><span class="p">),</span>
            <span class="n">msg_ref_id</span><span class="o">=</span><span class="s1">&#39;jnvbcvxsrw538r49ri&#39;</span><span class="p">,</span>
            <span class="n">operation_ref</span><span class="o">=</span><span class="s1">&#39;replaceResult&#39;</span><span class="p">,</span>
            <span class="n">extra_status</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="n">body</span><span class="o">=</span><span class="s1">&#39;&lt;replaceResultResponse/&gt;&#39;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertLTIOutcomesResponseXMLEqual</span><span class="p">(</span><span class="n">response_xml1</span><span class="p">,</span> <span class="n">expected_response_xml1</span><span class="p">)</span>

        <span class="c1"># another replaceResult request</span>
        <span class="n">sourced_id2</span> <span class="o">=</span> <span class="n">sourced_id1</span>
        <span class="n">req_xml2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BASE_OUTCOMES_REQUEST_XML</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">msg_id</span><span class="o">=</span><span class="s1">&#39;cxduedu73tiew7fjdoe&#39;</span><span class="p">,</span>
            <span class="n">operation</span><span class="o">=</span><span class="s1">&#39;replaceResult&#39;</span><span class="p">,</span>
            <span class="n">sourced_id</span><span class="o">=</span><span class="n">sourced_id2</span><span class="p">,</span>
            <span class="n">result</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">BASE_RESULT_XML</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">score</span><span class="o">=</span><span class="s1">&#39;0.26&#39;</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="n">response2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">OUTCOMES_API_URL</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">req_xml2</span><span class="p">,</span> <span class="n">content_type</span><span class="o">=</span><span class="s1">&#39;application/xml&#39;</span><span class="p">)</span>
        <span class="n">response_xml2</span> <span class="o">=</span> <span class="n">response2</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="n">expected_response_xml2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BASE_OUTCOMES_RESPONSE_XML</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">msg_id</span><span class="o">=</span><span class="s1">&#39;xxxx&#39;</span><span class="p">,</span> <span class="c1"># random, can not know beforehand</span>
            <span class="n">code_major</span><span class="o">=</span><span class="s1">&#39;success&#39;</span><span class="p">,</span>
            <span class="n">severity</span><span class="o">=</span><span class="s1">&#39;status&#39;</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s1">&#39;Score </span><span class="si">{}</span><span class="s1"> added to sourcedId </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;0.26&#39;</span><span class="p">,</span> <span class="n">sourced_id2</span><span class="p">),</span>
            <span class="n">msg_ref_id</span><span class="o">=</span><span class="s1">&#39;cxduedu73tiew7fjdoe&#39;</span><span class="p">,</span>
            <span class="n">operation_ref</span><span class="o">=</span><span class="s1">&#39;replaceResult&#39;</span><span class="p">,</span>
            <span class="n">extra_status</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="n">body</span><span class="o">=</span><span class="s1">&#39;&lt;replaceResultResponse/&gt;&#39;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertLTIOutcomesResponseXMLEqual</span><span class="p">(</span><span class="n">response_xml2</span><span class="p">,</span> <span class="n">expected_response_xml2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">response2</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="n">status</span><span class="o">.</span><span class="n">HTTP_200_OK</span><span class="p">)</span>

        <span class="c1"># check the submissions in the database</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Submission</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">submission1</span> <span class="o">=</span> <span class="n">Submission</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">grade</span><span class="o">=</span><span class="mi">88</span><span class="p">)</span>
        <span class="n">submission2</span> <span class="o">=</span> <span class="n">Submission</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">grade</span><span class="o">=</span><span class="mi">26</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">submission1</span><span class="o">.</span><span class="n">status</span><span class="p">,</span> <span class="s1">&#39;ready&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">submission2</span><span class="o">.</span><span class="n">status</span><span class="p">,</span> <span class="s1">&#39;ready&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">submission1</span><span class="o">.</span><span class="n">exercise</span><span class="o">.</span><span class="n">pk</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lti_exercise</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">submission2</span><span class="o">.</span><span class="n">exercise</span><span class="o">.</span><span class="n">pk</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lti_exercise</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span></div>


<div class="viewcode-block" id="LTIOutcomesTests.test_invalid_req_body_no_msg_id">
<a class="viewcode-back" href="../../../external_services.api.html#external_services.api.tests.LTIOutcomesTests.test_invalid_req_body_no_msg_id">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_invalid_req_body_no_msg_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># invalid request body XML, no messageIdentifier</span>
        <span class="n">sourced_id1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mk_sourced_id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lti_exercise</span><span class="p">,</span> <span class="n">enrollment</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">student1_enrollment</span><span class="p">)</span>
        <span class="n">req_xml_no_msgid</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="s1">&lt;imsx_POXEnvelopeRequest xmlns=&quot;http://www.imsglobal.org/services/ltiv1p1/xsd/imsoms_v1p0&quot;&gt;</span>
<span class="s1">  &lt;imsx_POXHeader&gt;</span>
<span class="s1">    &lt;imsx_POXRequestHeaderInfo&gt;</span>
<span class="s1">      &lt;imsx_version&gt;V1.0&lt;/imsx_version&gt;</span>
<span class="s1">    &lt;/imsx_POXRequestHeaderInfo&gt;</span>
<span class="s1">  &lt;/imsx_POXHeader&gt;</span>
<span class="s1">  &lt;imsx_POXBody&gt;</span>
<span class="s1">    &lt;</span><span class="si">{operation}</span><span class="s1">Request&gt;</span>
<span class="s1">      &lt;resultRecord&gt;</span>
<span class="s1">        &lt;sourcedGUID&gt;</span>
<span class="s1">          &lt;sourcedId&gt;</span><span class="si">{sourced_id}</span><span class="s1">&lt;/sourcedId&gt;</span>
<span class="s1">        &lt;/sourcedGUID&gt;</span>
<span class="s1">      &lt;/resultRecord&gt;</span>
<span class="s1">    &lt;/</span><span class="si">{operation}</span><span class="s1">Request&gt;</span>
<span class="s1">  &lt;/imsx_POXBody&gt;</span>
<span class="s1">&lt;/imsx_POXEnvelopeRequest&gt;&#39;&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">operation</span><span class="o">=</span><span class="s1">&#39;readResult&#39;</span><span class="p">,</span>
            <span class="n">sourced_id</span><span class="o">=</span><span class="n">sourced_id1</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">force_authenticate</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lti_user1</span><span class="p">)</span> <span class="c1"># skip OAuth credentials</span>
        <span class="n">response1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">OUTCOMES_API_URL</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">req_xml_no_msgid</span><span class="p">,</span> <span class="n">content_type</span><span class="o">=</span><span class="s1">&#39;application/xml&#39;</span><span class="p">)</span>
        <span class="n">response_xml1</span> <span class="o">=</span> <span class="n">response1</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="n">expected_response_xml1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BASE_OUTCOMES_RESPONSE_XML</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">msg_id</span><span class="o">=</span><span class="s1">&#39;xxxx&#39;</span><span class="p">,</span> <span class="c1"># random, can not know beforehand</span>
            <span class="n">code_major</span><span class="o">=</span><span class="s1">&#39;failure&#39;</span><span class="p">,</span>
            <span class="n">severity</span><span class="o">=</span><span class="s1">&#39;status&#39;</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s1">&#39;msgid: This field is required.&#39;</span><span class="p">,</span>
            <span class="n">msg_ref_id</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="n">operation_ref</span><span class="o">=</span><span class="s1">&#39;readResult&#39;</span><span class="p">,</span>
            <span class="n">extra_status</span><span class="o">=</span><span class="s1">&#39;&lt;imsx_codeMinor&gt;invalidsourcedata&lt;/imsx_codeMinor&gt;&#39;</span><span class="p">,</span>
            <span class="n">body</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertLTIOutcomesResponseXMLEqual</span><span class="p">(</span><span class="n">response_xml1</span><span class="p">,</span> <span class="n">expected_response_xml1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">response1</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">)</span></div>


<div class="viewcode-block" id="LTIOutcomesTests.test_invalid_req_body_empty_msg_id">
<a class="viewcode-back" href="../../../external_services.api.html#external_services.api.tests.LTIOutcomesTests.test_invalid_req_body_empty_msg_id">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_invalid_req_body_empty_msg_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># invalid request body XML, empty messageIdentifier element</span>
        <span class="n">sourced_id1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mk_sourced_id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lti_exercise</span><span class="p">,</span> <span class="n">enrollment</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">student1_enrollment</span><span class="p">)</span>
        <span class="n">req_xml_empty_msgid</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="s1">&lt;imsx_POXEnvelopeRequest xmlns=&quot;http://www.imsglobal.org/services/ltiv1p1/xsd/imsoms_v1p0&quot;&gt;</span>
<span class="s1">  &lt;imsx_POXHeader&gt;</span>
<span class="s1">    &lt;imsx_POXRequestHeaderInfo&gt;</span>
<span class="s1">      &lt;imsx_version&gt;V1.0&lt;/imsx_version&gt;</span>
<span class="s1">      &lt;imsx_messageIdentifier&gt;&lt;/imsx_messageIdentifier&gt;</span>
<span class="s1">    &lt;/imsx_POXRequestHeaderInfo&gt;</span>
<span class="s1">  &lt;/imsx_POXHeader&gt;</span>
<span class="s1">  &lt;imsx_POXBody&gt;</span>
<span class="s1">    &lt;</span><span class="si">{operation}</span><span class="s1">Request&gt;</span>
<span class="s1">      &lt;resultRecord&gt;</span>
<span class="s1">        &lt;sourcedGUID&gt;</span>
<span class="s1">          &lt;sourcedId&gt;</span><span class="si">{sourced_id}</span><span class="s1">&lt;/sourcedId&gt;</span>
<span class="s1">        &lt;/sourcedGUID&gt;</span>
<span class="s1">      &lt;/resultRecord&gt;</span>
<span class="s1">    &lt;/</span><span class="si">{operation}</span><span class="s1">Request&gt;</span>
<span class="s1">  &lt;/imsx_POXBody&gt;</span>
<span class="s1">&lt;/imsx_POXEnvelopeRequest&gt;&#39;&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">operation</span><span class="o">=</span><span class="s1">&#39;readResult&#39;</span><span class="p">,</span>
            <span class="n">sourced_id</span><span class="o">=</span><span class="n">sourced_id1</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">force_authenticate</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lti_user1</span><span class="p">)</span> <span class="c1"># skip OAuth credentials</span>
        <span class="n">response1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">OUTCOMES_API_URL</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">req_xml_empty_msgid</span><span class="p">,</span> <span class="n">content_type</span><span class="o">=</span><span class="s1">&#39;application/xml&#39;</span><span class="p">)</span>
        <span class="n">response_xml1</span> <span class="o">=</span> <span class="n">response1</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="n">expected_response_xml1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BASE_OUTCOMES_RESPONSE_XML</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">msg_id</span><span class="o">=</span><span class="s1">&#39;xxxx&#39;</span><span class="p">,</span> <span class="c1"># random, can not know beforehand</span>
            <span class="n">code_major</span><span class="o">=</span><span class="s1">&#39;failure&#39;</span><span class="p">,</span>
            <span class="n">severity</span><span class="o">=</span><span class="s1">&#39;status&#39;</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s1">&#39;msgid: This field may not be blank.&#39;</span><span class="p">,</span>
            <span class="n">msg_ref_id</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="n">operation_ref</span><span class="o">=</span><span class="s1">&#39;readResult&#39;</span><span class="p">,</span>
            <span class="n">extra_status</span><span class="o">=</span><span class="s1">&#39;&lt;imsx_codeMinor&gt;invalidsourcedata&lt;/imsx_codeMinor&gt;&#39;</span><span class="p">,</span>
            <span class="n">body</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertLTIOutcomesResponseXMLEqual</span><span class="p">(</span><span class="n">response_xml1</span><span class="p">,</span> <span class="n">expected_response_xml1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">response1</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">)</span></div>


<div class="viewcode-block" id="LTIOutcomesTests.test_invalid_req_body_no_sourced_id">
<a class="viewcode-back" href="../../../external_services.api.html#external_services.api.tests.LTIOutcomesTests.test_invalid_req_body_no_sourced_id">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_invalid_req_body_no_sourced_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># invalid request body XML, no sourcedId element</span>
        <span class="n">req_xml_no_sourced_id</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="s1">&lt;imsx_POXEnvelopeRequest xmlns=&quot;http://www.imsglobal.org/services/ltiv1p1/xsd/imsoms_v1p0&quot;&gt;</span>
<span class="s1">  &lt;imsx_POXHeader&gt;</span>
<span class="s1">    &lt;imsx_POXRequestHeaderInfo&gt;</span>
<span class="s1">      &lt;imsx_version&gt;V1.0&lt;/imsx_version&gt;</span>
<span class="s1">      &lt;imsx_messageIdentifier&gt;</span><span class="si">{msgid}</span><span class="s1">&lt;/imsx_messageIdentifier&gt;</span>
<span class="s1">    &lt;/imsx_POXRequestHeaderInfo&gt;</span>
<span class="s1">  &lt;/imsx_POXHeader&gt;</span>
<span class="s1">  &lt;imsx_POXBody&gt;</span>
<span class="s1">    &lt;</span><span class="si">{operation}</span><span class="s1">Request&gt;</span>
<span class="s1">      &lt;resultRecord&gt;</span>
<span class="s1">      &lt;/resultRecord&gt;</span>
<span class="s1">    &lt;/</span><span class="si">{operation}</span><span class="s1">Request&gt;</span>
<span class="s1">  &lt;/imsx_POXBody&gt;</span>
<span class="s1">&lt;/imsx_POXEnvelopeRequest&gt;&#39;&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">msgid</span><span class="o">=</span><span class="s1">&#39;lghofudgw63yrjfhe6&#39;</span><span class="p">,</span>
            <span class="n">operation</span><span class="o">=</span><span class="s1">&#39;readResult&#39;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">force_authenticate</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">LTIServiceUser</span><span class="p">())</span> <span class="c1"># skip OAuth credentials</span>
        <span class="n">response1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">OUTCOMES_API_URL</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">req_xml_no_sourced_id</span><span class="p">,</span> <span class="n">content_type</span><span class="o">=</span><span class="s1">&#39;application/xml&#39;</span><span class="p">)</span>
        <span class="n">response_xml1</span> <span class="o">=</span> <span class="n">response1</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="n">expected_response_xml1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BASE_OUTCOMES_RESPONSE_XML</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">msg_id</span><span class="o">=</span><span class="s1">&#39;xxxx&#39;</span><span class="p">,</span> <span class="c1"># random, can not know beforehand</span>
            <span class="n">code_major</span><span class="o">=</span><span class="s1">&#39;failure&#39;</span><span class="p">,</span>
            <span class="n">severity</span><span class="o">=</span><span class="s1">&#39;status&#39;</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s1">&#39;sourced_id: This field is required.&#39;</span><span class="p">,</span>
            <span class="n">msg_ref_id</span><span class="o">=</span><span class="s1">&#39;lghofudgw63yrjfhe6&#39;</span><span class="p">,</span>
            <span class="n">operation_ref</span><span class="o">=</span><span class="s1">&#39;readResult&#39;</span><span class="p">,</span>
            <span class="n">extra_status</span><span class="o">=</span><span class="s1">&#39;&lt;imsx_codeMinor&gt;invalidsourcedata&lt;/imsx_codeMinor&gt;&#39;</span><span class="p">,</span>
            <span class="n">body</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertLTIOutcomesResponseXMLEqual</span><span class="p">(</span><span class="n">response_xml1</span><span class="p">,</span> <span class="n">expected_response_xml1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">response1</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">)</span></div>


<div class="viewcode-block" id="LTIOutcomesTests.test_invalid_req_body_unknown_operation">
<a class="viewcode-back" href="../../../external_services.api.html#external_services.api.tests.LTIOutcomesTests.test_invalid_req_body_unknown_operation">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_invalid_req_body_unknown_operation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># invalid request body XML, operation in the POXBody is unknown</span>
        <span class="n">sourced_id1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mk_sourced_id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lti_exercise</span><span class="p">,</span> <span class="n">enrollment</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">student1_enrollment</span><span class="p">)</span>
        <span class="n">req_xml_unknown_operation</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="s1">&lt;imsx_POXEnvelopeRequest xmlns=&quot;http://www.imsglobal.org/services/ltiv1p1/xsd/imsoms_v1p0&quot;&gt;</span>
<span class="s1">  &lt;imsx_POXHeader&gt;</span>
<span class="s1">    &lt;imsx_POXRequestHeaderInfo&gt;</span>
<span class="s1">      &lt;imsx_version&gt;V1.0&lt;/imsx_version&gt;</span>
<span class="s1">      &lt;imsx_messageIdentifier&gt;</span><span class="si">{msgid}</span><span class="s1">&lt;/imsx_messageIdentifier&gt;</span>
<span class="s1">    &lt;/imsx_POXRequestHeaderInfo&gt;</span>
<span class="s1">  &lt;/imsx_POXHeader&gt;</span>
<span class="s1">  &lt;imsx_POXBody&gt;</span>
<span class="s1">    &lt;</span><span class="si">{operation}</span><span class="s1">Request&gt;</span>
<span class="s1">      &lt;resultRecord&gt;</span>
<span class="s1">        &lt;sourcedGUID&gt;</span>
<span class="s1">          &lt;sourcedId&gt;</span><span class="si">{sourced_id}</span><span class="s1">&lt;/sourcedId&gt;</span>
<span class="s1">        &lt;/sourcedGUID&gt;</span>
<span class="s1">      &lt;/resultRecord&gt;</span>
<span class="s1">    &lt;/</span><span class="si">{operation}</span><span class="s1">Request&gt;</span>
<span class="s1">  &lt;/imsx_POXBody&gt;</span>
<span class="s1">&lt;/imsx_POXEnvelopeRequest&gt;&#39;&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">msgid</span><span class="o">=</span><span class="s1">&#39;cchdujfg836759odjd&#39;</span><span class="p">,</span>
            <span class="n">sourced_id</span><span class="o">=</span><span class="n">sourced_id1</span><span class="p">,</span>
            <span class="n">operation</span><span class="o">=</span><span class="s1">&#39;retrieveResult&#39;</span><span class="p">,</span> <span class="c1"># fake operation</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">force_authenticate</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lti_user1</span><span class="p">)</span> <span class="c1"># skip OAuth credentials</span>
        <span class="n">response1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">OUTCOMES_API_URL</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="n">req_xml_unknown_operation</span><span class="p">,</span>
            <span class="n">content_type</span><span class="o">=</span><span class="s1">&#39;application/xml&#39;</span>
        <span class="p">)</span>
        <span class="n">response_xml1</span> <span class="o">=</span> <span class="n">response1</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="n">expected_response_xml1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BASE_OUTCOMES_RESPONSE_XML</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">msg_id</span><span class="o">=</span><span class="s1">&#39;xxxx&#39;</span><span class="p">,</span> <span class="c1"># random, can not know beforehand</span>
            <span class="n">code_major</span><span class="o">=</span><span class="s1">&#39;failure&#39;</span><span class="p">,</span>
            <span class="n">severity</span><span class="o">=</span><span class="s1">&#39;status&#39;</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s1">&#39;req_type: &quot;retrieveResult&quot; is not a valid choice.&#39;</span><span class="p">,</span>
            <span class="n">msg_ref_id</span><span class="o">=</span><span class="s1">&#39;cchdujfg836759odjd&#39;</span><span class="p">,</span>
            <span class="n">operation_ref</span><span class="o">=</span><span class="s1">&#39;retrieveResult&#39;</span><span class="p">,</span>
            <span class="n">extra_status</span><span class="o">=</span><span class="s1">&#39;&lt;imsx_codeMinor&gt;invalidsourcedata&lt;/imsx_codeMinor&gt;&#39;</span><span class="p">,</span>
            <span class="n">body</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertLTIOutcomesResponseXMLEqual</span><span class="p">(</span><span class="n">response_xml1</span><span class="p">,</span> <span class="n">expected_response_xml1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">response1</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">)</span></div>


<div class="viewcode-block" id="LTIOutcomesTests.test_invalid_req_body_unknown_operation2">
<a class="viewcode-back" href="../../../external_services.api.html#external_services.api.tests.LTIOutcomesTests.test_invalid_req_body_unknown_operation2">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_invalid_req_body_unknown_operation2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># invalid request body XML, operation in the POXBody is unknown and does not end with &quot;Request&quot;</span>
        <span class="n">sourced_id1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mk_sourced_id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lti_exercise</span><span class="p">,</span> <span class="n">enrollment</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">student1_enrollment</span><span class="p">)</span>
        <span class="n">req_xml_unknown_operation</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="s1">&lt;imsx_POXEnvelopeRequest xmlns=&quot;http://www.imsglobal.org/services/ltiv1p1/xsd/imsoms_v1p0&quot;&gt;</span>
<span class="s1">  &lt;imsx_POXHeader&gt;</span>
<span class="s1">    &lt;imsx_POXRequestHeaderInfo&gt;</span>
<span class="s1">      &lt;imsx_version&gt;V1.0&lt;/imsx_version&gt;</span>
<span class="s1">      &lt;imsx_messageIdentifier&gt;</span><span class="si">{msgid}</span><span class="s1">&lt;/imsx_messageIdentifier&gt;</span>
<span class="s1">    &lt;/imsx_POXRequestHeaderInfo&gt;</span>
<span class="s1">  &lt;/imsx_POXHeader&gt;</span>
<span class="s1">  &lt;imsx_POXBody&gt;</span>
<span class="s1">    &lt;foo&gt;</span>
<span class="s1">      &lt;resultRecord&gt;</span>
<span class="s1">        &lt;sourcedGUID&gt;</span>
<span class="s1">          &lt;sourcedId&gt;</span><span class="si">{sourced_id}</span><span class="s1">&lt;/sourcedId&gt;</span>
<span class="s1">        &lt;/sourcedGUID&gt;</span>
<span class="s1">      &lt;/resultRecord&gt;</span>
<span class="s1">    &lt;/foo&gt;</span>
<span class="s1">  &lt;/imsx_POXBody&gt;</span>
<span class="s1">&lt;/imsx_POXEnvelopeRequest&gt;&#39;&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">msgid</span><span class="o">=</span><span class="s1">&#39;arwt374ufjhdhne&#39;</span><span class="p">,</span>
            <span class="n">sourced_id</span><span class="o">=</span><span class="n">sourced_id1</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">force_authenticate</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lti_user1</span><span class="p">)</span> <span class="c1"># skip OAuth credentials</span>
        <span class="n">response1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">OUTCOMES_API_URL</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="n">req_xml_unknown_operation</span><span class="p">,</span>
            <span class="n">content_type</span><span class="o">=</span><span class="s1">&#39;application/xml&#39;</span>
        <span class="p">)</span>
        <span class="n">response_xml1</span> <span class="o">=</span> <span class="n">response1</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="n">expected_response_xml1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BASE_OUTCOMES_RESPONSE_XML</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">msg_id</span><span class="o">=</span><span class="s1">&#39;xxxx&#39;</span><span class="p">,</span> <span class="c1"># random, can not know beforehand</span>
            <span class="n">code_major</span><span class="o">=</span><span class="s1">&#39;failure&#39;</span><span class="p">,</span>
            <span class="n">severity</span><span class="o">=</span><span class="s1">&#39;status&#39;</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s1">&#39;req_type: &quot;&quot; is not a valid choice.&#39;</span><span class="p">,</span>
            <span class="n">msg_ref_id</span><span class="o">=</span><span class="s1">&#39;arwt374ufjhdhne&#39;</span><span class="p">,</span>
            <span class="n">operation_ref</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="c1"># the parser truncates the &quot;foo&quot; element name to the empty string</span>
            <span class="n">extra_status</span><span class="o">=</span><span class="s1">&#39;&lt;imsx_codeMinor&gt;invalidsourcedata&lt;/imsx_codeMinor&gt;&#39;</span><span class="p">,</span>
            <span class="n">body</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertLTIOutcomesResponseXMLEqual</span><span class="p">(</span><span class="n">response_xml1</span><span class="p">,</span> <span class="n">expected_response_xml1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">response1</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Submission</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span></div>


<div class="viewcode-block" id="LTIOutcomesTests.test_invalid_req_body_no_score_in_replace">
<a class="viewcode-back" href="../../../external_services.api.html#external_services.api.tests.LTIOutcomesTests.test_invalid_req_body_no_score_in_replace">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_invalid_req_body_no_score_in_replace</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># invalid request body XML, replaceResultRequest with an empty score</span>
        <span class="n">sourced_id1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mk_sourced_id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lti_exercise</span><span class="p">,</span> <span class="n">enrollment</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">student1_enrollment</span><span class="p">)</span>
        <span class="n">req_xml_no_score</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="s1">&lt;imsx_POXEnvelopeRequest xmlns=&quot;http://www.imsglobal.org/services/ltiv1p1/xsd/imsoms_v1p0&quot;&gt;</span>
<span class="s1">  &lt;imsx_POXHeader&gt;</span>
<span class="s1">    &lt;imsx_POXRequestHeaderInfo&gt;</span>
<span class="s1">      &lt;imsx_version&gt;V1.0&lt;/imsx_version&gt;</span>
<span class="s1">      &lt;imsx_messageIdentifier&gt;</span><span class="si">{msgid}</span><span class="s1">&lt;/imsx_messageIdentifier&gt;</span>
<span class="s1">    &lt;/imsx_POXRequestHeaderInfo&gt;</span>
<span class="s1">  &lt;/imsx_POXHeader&gt;</span>
<span class="s1">  &lt;imsx_POXBody&gt;</span>
<span class="s1">    &lt;</span><span class="si">{operation}</span><span class="s1">Request&gt;</span>
<span class="s1">      &lt;resultRecord&gt;</span>
<span class="s1">        &lt;sourcedGUID&gt;</span>
<span class="s1">          &lt;sourcedId&gt;</span><span class="si">{sourced_id}</span><span class="s1">&lt;/sourcedId&gt;</span>
<span class="s1">        &lt;/sourcedGUID&gt;</span>
<span class="s1">        &lt;result&gt;</span>
<span class="s1">          &lt;resultScore&gt;</span>
<span class="s1">            &lt;language&gt;en&lt;/language&gt;</span>
<span class="s1">            &lt;textString&gt;&lt;/textString&gt;</span>
<span class="s1">          &lt;/resultScore&gt;</span>
<span class="s1">        &lt;/result&gt;</span>
<span class="s1">      &lt;/resultRecord&gt;</span>
<span class="s1">    &lt;/</span><span class="si">{operation}</span><span class="s1">Request&gt;</span>
<span class="s1">  &lt;/imsx_POXBody&gt;</span>
<span class="s1">&lt;/imsx_POXEnvelopeRequest&gt;&#39;&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">msgid</span><span class="o">=</span><span class="s1">&#39;xhfgd836togjsus7g&#39;</span><span class="p">,</span>
            <span class="n">operation</span><span class="o">=</span><span class="s1">&#39;replaceResult&#39;</span><span class="p">,</span>
            <span class="n">sourced_id</span><span class="o">=</span><span class="n">sourced_id1</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">force_authenticate</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lti_user1</span><span class="p">)</span> <span class="c1"># skip OAuth credentials</span>
        <span class="n">response1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">OUTCOMES_API_URL</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">req_xml_no_score</span><span class="p">,</span> <span class="n">content_type</span><span class="o">=</span><span class="s1">&#39;application/xml&#39;</span><span class="p">)</span>
        <span class="n">response_xml1</span> <span class="o">=</span> <span class="n">response1</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="n">expected_response_xml1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BASE_OUTCOMES_RESPONSE_XML</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">msg_id</span><span class="o">=</span><span class="s1">&#39;xxxx&#39;</span><span class="p">,</span> <span class="c1"># random, can not know beforehand</span>
            <span class="n">code_major</span><span class="o">=</span><span class="s1">&#39;failure&#39;</span><span class="p">,</span>
            <span class="n">severity</span><span class="o">=</span><span class="s1">&#39;status&#39;</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s1">&#39;score: A valid number is required.&#39;</span><span class="p">,</span>
            <span class="n">msg_ref_id</span><span class="o">=</span><span class="s1">&#39;xhfgd836togjsus7g&#39;</span><span class="p">,</span>
            <span class="n">operation_ref</span><span class="o">=</span><span class="s1">&#39;replaceResult&#39;</span><span class="p">,</span>
            <span class="n">extra_status</span><span class="o">=</span><span class="s1">&#39;&lt;imsx_codeMinor&gt;invalidsourcedata&lt;/imsx_codeMinor&gt;&#39;</span><span class="p">,</span>
            <span class="n">body</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertLTIOutcomesResponseXMLEqual</span><span class="p">(</span><span class="n">response_xml1</span><span class="p">,</span> <span class="n">expected_response_xml1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">response1</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">)</span>
        <span class="c1"># no submission was created</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Submission</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span></div>


<div class="viewcode-block" id="LTIOutcomesTests.test_invalid_req_body_no_score_in_replace2">
<a class="viewcode-back" href="../../../external_services.api.html#external_services.api.tests.LTIOutcomesTests.test_invalid_req_body_no_score_in_replace2">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_invalid_req_body_no_score_in_replace2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># invalid request body XML, replaceResultRequest with no score element</span>
        <span class="n">sourced_id1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mk_sourced_id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lti_exercise</span><span class="p">,</span> <span class="n">enrollment</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">student1_enrollment</span><span class="p">)</span>
        <span class="n">req_xml_no_score</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="s1">&lt;imsx_POXEnvelopeRequest xmlns=&quot;http://www.imsglobal.org/services/ltiv1p1/xsd/imsoms_v1p0&quot;&gt;</span>
<span class="s1">  &lt;imsx_POXHeader&gt;</span>
<span class="s1">    &lt;imsx_POXRequestHeaderInfo&gt;</span>
<span class="s1">      &lt;imsx_version&gt;V1.0&lt;/imsx_version&gt;</span>
<span class="s1">      &lt;imsx_messageIdentifier&gt;</span><span class="si">{msgid}</span><span class="s1">&lt;/imsx_messageIdentifier&gt;</span>
<span class="s1">    &lt;/imsx_POXRequestHeaderInfo&gt;</span>
<span class="s1">  &lt;/imsx_POXHeader&gt;</span>
<span class="s1">  &lt;imsx_POXBody&gt;</span>
<span class="s1">    &lt;</span><span class="si">{operation}</span><span class="s1">Request&gt;</span>
<span class="s1">      &lt;resultRecord&gt;</span>
<span class="s1">        &lt;sourcedGUID&gt;</span>
<span class="s1">          &lt;sourcedId&gt;</span><span class="si">{sourced_id}</span><span class="s1">&lt;/sourcedId&gt;</span>
<span class="s1">        &lt;/sourcedGUID&gt;</span>
<span class="s1">        &lt;result&gt;</span>
<span class="s1">          &lt;resultScore&gt;</span>
<span class="s1">            &lt;language&gt;en&lt;/language&gt;</span>
<span class="s1">          &lt;/resultScore&gt;</span>
<span class="s1">        &lt;/result&gt;</span>
<span class="s1">      &lt;/resultRecord&gt;</span>
<span class="s1">    &lt;/</span><span class="si">{operation}</span><span class="s1">Request&gt;</span>
<span class="s1">  &lt;/imsx_POXBody&gt;</span>
<span class="s1">&lt;/imsx_POXEnvelopeRequest&gt;&#39;&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">msgid</span><span class="o">=</span><span class="s1">&#39;ogifhu7w3634hdhd&#39;</span><span class="p">,</span>
            <span class="n">operation</span><span class="o">=</span><span class="s1">&#39;replaceResult&#39;</span><span class="p">,</span>
            <span class="n">sourced_id</span><span class="o">=</span><span class="n">sourced_id1</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">force_authenticate</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lti_user1</span><span class="p">)</span> <span class="c1"># skip OAuth credentials</span>
        <span class="n">response1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">OUTCOMES_API_URL</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">req_xml_no_score</span><span class="p">,</span> <span class="n">content_type</span><span class="o">=</span><span class="s1">&#39;application/xml&#39;</span><span class="p">)</span>
        <span class="n">response_xml1</span> <span class="o">=</span> <span class="n">response1</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="n">expected_response_xml1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BASE_OUTCOMES_RESPONSE_XML</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">msg_id</span><span class="o">=</span><span class="s1">&#39;xxxx&#39;</span><span class="p">,</span> <span class="c1"># random, can not know beforehand</span>
            <span class="n">code_major</span><span class="o">=</span><span class="s1">&#39;failure&#39;</span><span class="p">,</span>
            <span class="n">severity</span><span class="o">=</span><span class="s1">&#39;status&#39;</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s1">&#39;score: replaceResult request must include the new result score.&#39;</span><span class="p">,</span>
            <span class="n">msg_ref_id</span><span class="o">=</span><span class="s1">&#39;ogifhu7w3634hdhd&#39;</span><span class="p">,</span>
            <span class="n">operation_ref</span><span class="o">=</span><span class="s1">&#39;replaceResult&#39;</span><span class="p">,</span>
            <span class="n">extra_status</span><span class="o">=</span><span class="s1">&#39;&lt;imsx_codeMinor&gt;invalidsourcedata&lt;/imsx_codeMinor&gt;&#39;</span><span class="p">,</span>
            <span class="n">body</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertLTIOutcomesResponseXMLEqual</span><span class="p">(</span><span class="n">response_xml1</span><span class="p">,</span> <span class="n">expected_response_xml1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">response1</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">)</span>
        <span class="c1"># no submission was created</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Submission</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span></div>


<div class="viewcode-block" id="LTIOutcomesTests.test_invalid_req_body_bad_score">
<a class="viewcode-back" href="../../../external_services.api.html#external_services.api.tests.LTIOutcomesTests.test_invalid_req_body_bad_score">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_invalid_req_body_bad_score</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># invalid request body XML, replaceResultRequest with a score over 1</span>
        <span class="n">sourced_id1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mk_sourced_id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lti_exercise</span><span class="p">,</span> <span class="n">enrollment</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">student1_enrollment</span><span class="p">)</span>
        <span class="n">req_xml_no_score</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="s1">&lt;imsx_POXEnvelopeRequest xmlns=&quot;http://www.imsglobal.org/services/ltiv1p1/xsd/imsoms_v1p0&quot;&gt;</span>
<span class="s1">  &lt;imsx_POXHeader&gt;</span>
<span class="s1">    &lt;imsx_POXRequestHeaderInfo&gt;</span>
<span class="s1">      &lt;imsx_version&gt;V1.0&lt;/imsx_version&gt;</span>
<span class="s1">      &lt;imsx_messageIdentifier&gt;</span><span class="si">{msgid}</span><span class="s1">&lt;/imsx_messageIdentifier&gt;</span>
<span class="s1">    &lt;/imsx_POXRequestHeaderInfo&gt;</span>
<span class="s1">  &lt;/imsx_POXHeader&gt;</span>
<span class="s1">  &lt;imsx_POXBody&gt;</span>
<span class="s1">    &lt;</span><span class="si">{operation}</span><span class="s1">Request&gt;</span>
<span class="s1">      &lt;resultRecord&gt;</span>
<span class="s1">        &lt;sourcedGUID&gt;</span>
<span class="s1">          &lt;sourcedId&gt;</span><span class="si">{sourced_id}</span><span class="s1">&lt;/sourcedId&gt;</span>
<span class="s1">        &lt;/sourcedGUID&gt;</span>
<span class="s1">        &lt;result&gt;</span>
<span class="s1">          &lt;resultScore&gt;</span>
<span class="s1">            &lt;language&gt;en&lt;/language&gt;</span>
<span class="s1">            &lt;textString&gt;</span><span class="si">{score}</span><span class="s1">&lt;/textString&gt;</span>
<span class="s1">          &lt;/resultScore&gt;</span>
<span class="s1">        &lt;/result&gt;</span>
<span class="s1">      &lt;/resultRecord&gt;</span>
<span class="s1">    &lt;/</span><span class="si">{operation}</span><span class="s1">Request&gt;</span>
<span class="s1">  &lt;/imsx_POXBody&gt;</span>
<span class="s1">&lt;/imsx_POXEnvelopeRequest&gt;&#39;&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">msgid</span><span class="o">=</span><span class="s1">&#39;cjfud7374uytiodpfie&#39;</span><span class="p">,</span>
            <span class="n">operation</span><span class="o">=</span><span class="s1">&#39;replaceResult&#39;</span><span class="p">,</span>
            <span class="n">sourced_id</span><span class="o">=</span><span class="n">sourced_id1</span><span class="p">,</span>
            <span class="n">score</span><span class="o">=</span><span class="s1">&#39;1.01&#39;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">force_authenticate</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lti_user1</span><span class="p">)</span> <span class="c1"># skip OAuth credentials</span>
        <span class="n">response1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">OUTCOMES_API_URL</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">req_xml_no_score</span><span class="p">,</span> <span class="n">content_type</span><span class="o">=</span><span class="s1">&#39;application/xml&#39;</span><span class="p">)</span>
        <span class="n">response_xml1</span> <span class="o">=</span> <span class="n">response1</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="n">expected_response_xml1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BASE_OUTCOMES_RESPONSE_XML</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">msg_id</span><span class="o">=</span><span class="s1">&#39;xxxx&#39;</span><span class="p">,</span> <span class="c1"># random, can not know beforehand</span>
            <span class="n">code_major</span><span class="o">=</span><span class="s1">&#39;failure&#39;</span><span class="p">,</span>
            <span class="n">severity</span><span class="o">=</span><span class="s1">&#39;status&#39;</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s1">&#39;score: Ensure this value is less than or equal to 1.&#39;</span><span class="p">,</span>
            <span class="n">msg_ref_id</span><span class="o">=</span><span class="s1">&#39;cjfud7374uytiodpfie&#39;</span><span class="p">,</span>
            <span class="n">operation_ref</span><span class="o">=</span><span class="s1">&#39;replaceResult&#39;</span><span class="p">,</span>
            <span class="n">extra_status</span><span class="o">=</span><span class="s1">&#39;&lt;imsx_codeMinor&gt;invalidsourcedata&lt;/imsx_codeMinor&gt;&#39;</span><span class="p">,</span>
            <span class="n">body</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertLTIOutcomesResponseXMLEqual</span><span class="p">(</span><span class="n">response_xml1</span><span class="p">,</span> <span class="n">expected_response_xml1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">response1</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">)</span>
        <span class="c1"># no submission was created</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Submission</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span></div>


<div class="viewcode-block" id="LTIOutcomesTests.test_invalid_oauth_req">
<a class="viewcode-back" href="../../../external_services.api.html#external_services.api.tests.LTIOutcomesTests.test_invalid_oauth_req">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_invalid_oauth_req</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># request has bad OAuth parameters and authentication fails</span>
        <span class="n">sourced_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mk_sourced_id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lti_exercise</span><span class="p">,</span> <span class="n">enrollment</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">student1_enrollment</span><span class="p">)</span>
        <span class="n">req_xml</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BASE_OUTCOMES_REQUEST_XML</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">msg_id</span><span class="o">=</span><span class="s1">&#39;poubchsd7w63&#39;</span><span class="p">,</span>
            <span class="n">operation</span><span class="o">=</span><span class="s1">&#39;replaceResult&#39;</span><span class="p">,</span>
            <span class="n">sourced_id</span><span class="o">=</span><span class="n">sourced_id</span><span class="p">,</span>
            <span class="n">result</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">BASE_RESULT_XML</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">score</span><span class="o">=</span><span class="s1">&#39;0.92&#39;</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="c1"># OAuth1 signature and body hash for the HTTP request Authorization header</span>
        <span class="n">oauth_client</span> <span class="o">=</span> <span class="n">oauthlib</span><span class="o">.</span><span class="n">oauth1</span><span class="o">.</span><span class="n">Client</span><span class="p">(</span>
            <span class="n">client_key</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lti_service</span><span class="o">.</span><span class="n">consumer_key</span><span class="p">,</span>
            <span class="n">client_secret</span><span class="o">=</span><span class="s1">&#39;thewrongsecret&#39;</span><span class="p">,</span>
            <span class="n">signature_method</span><span class="o">=</span><span class="n">oauthlib</span><span class="o">.</span><span class="n">oauth1</span><span class="o">.</span><span class="n">SIGNATURE_HMAC</span><span class="p">,</span>
            <span class="n">signature_type</span><span class="o">=</span><span class="n">oauthlib</span><span class="o">.</span><span class="n">oauth1</span><span class="o">.</span><span class="n">SIGNATURE_TYPE_AUTH_HEADER</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># pylint: disable-next=unused-variable</span>
        <span class="n">oa_uri</span><span class="p">,</span> <span class="n">oa_headers</span><span class="p">,</span> <span class="n">oa_body</span> <span class="o">=</span> <span class="n">oauth_client</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="s1">&#39;http://aplus.local/api/v2/lti-outcomes&#39;</span><span class="p">,</span>
            <span class="n">http_method</span><span class="o">=</span><span class="s1">&#39;POST&#39;</span><span class="p">,</span>
            <span class="n">body</span><span class="o">=</span><span class="n">req_xml</span><span class="p">,</span>
            <span class="n">headers</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;Content-Type&#39;</span><span class="p">:</span> <span class="s1">&#39;application/xml&#39;</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">)</span>

        <span class="c1"># make the test request</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">OUTCOMES_API_URL</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">req_xml</span><span class="p">,</span> <span class="n">content_type</span><span class="o">=</span><span class="s1">&#39;application/xml&#39;</span><span class="p">,</span>
                         <span class="n">HTTP_AUTHORIZATION</span><span class="o">=</span><span class="n">oa_headers</span><span class="p">[</span><span class="s1">&#39;Authorization&#39;</span><span class="p">],</span>
                         <span class="n">SERVER_NAME</span><span class="o">=</span><span class="s1">&#39;aplus.local&#39;</span><span class="p">)</span>
        <span class="n">response_xml</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>

        <span class="n">expected_response_xml</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BASE_OUTCOMES_RESPONSE_XML</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">msg_id</span><span class="o">=</span><span class="s1">&#39;xxxxx&#39;</span><span class="p">,</span> <span class="c1"># random, can not know beforehand</span>
            <span class="n">code_major</span><span class="o">=</span><span class="s1">&#39;failure&#39;</span><span class="p">,</span>
            <span class="n">severity</span><span class="o">=</span><span class="s1">&#39;status&#39;</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s1">&#39;OAuth verification failed: oauth_signature verification failed&#39;</span><span class="p">,</span>
            <span class="n">msg_ref_id</span><span class="o">=</span><span class="s1">&#39;poubchsd7w63&#39;</span><span class="p">,</span>
            <span class="n">operation_ref</span><span class="o">=</span><span class="s1">&#39;replaceResult&#39;</span><span class="p">,</span>
            <span class="n">extra_status</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="n">body</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertLTIOutcomesResponseXMLEqual</span><span class="p">(</span><span class="n">response_xml</span><span class="p">,</span> <span class="n">expected_response_xml</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="n">status</span><span class="o">.</span><span class="n">HTTP_403_FORBIDDEN</span><span class="p">)</span>

        <span class="c1"># check that no submission was made</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Submission</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span></div>


<div class="viewcode-block" id="LTIOutcomesTests.test_invalid_oauth_and_XML">
<a class="viewcode-back" href="../../../external_services.api.html#external_services.api.tests.LTIOutcomesTests.test_invalid_oauth_and_XML">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_invalid_oauth_and_XML</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># OAuth credentials are invalid and the body XML causes ParseError</span>
        <span class="n">req_xml</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="s1">&lt;imsx_POXEnvelopeRequest xmlns=&quot;http://www.imsglobal.org/services/ltiv1p1/xsd/imsoms_v1p0&quot;&gt;&#39;&#39;&#39;</span>

        <span class="c1"># OAuth1 signature and body hash for the HTTP request Authorization header</span>
        <span class="n">oauth_client</span> <span class="o">=</span> <span class="n">oauthlib</span><span class="o">.</span><span class="n">oauth1</span><span class="o">.</span><span class="n">Client</span><span class="p">(</span>
            <span class="n">client_key</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lti_service</span><span class="o">.</span><span class="n">consumer_key</span><span class="p">,</span>
            <span class="n">client_secret</span><span class="o">=</span><span class="s1">&#39;thewrongsecret&#39;</span><span class="p">,</span>
            <span class="n">signature_method</span><span class="o">=</span><span class="n">oauthlib</span><span class="o">.</span><span class="n">oauth1</span><span class="o">.</span><span class="n">SIGNATURE_HMAC</span><span class="p">,</span>
            <span class="n">signature_type</span><span class="o">=</span><span class="n">oauthlib</span><span class="o">.</span><span class="n">oauth1</span><span class="o">.</span><span class="n">SIGNATURE_TYPE_AUTH_HEADER</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># pylint: disable-next=unused-variable</span>
        <span class="n">oa_uri</span><span class="p">,</span> <span class="n">oa_headers</span><span class="p">,</span> <span class="n">oa_body</span> <span class="o">=</span> <span class="n">oauth_client</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="s1">&#39;http://aplus.local/api/v2/lti-outcomes&#39;</span><span class="p">,</span>
            <span class="n">http_method</span><span class="o">=</span><span class="s1">&#39;POST&#39;</span><span class="p">,</span>
            <span class="n">body</span><span class="o">=</span><span class="n">req_xml</span><span class="p">,</span>
            <span class="n">headers</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;Content-Type&#39;</span><span class="p">:</span> <span class="s1">&#39;application/xml&#39;</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">)</span>

        <span class="c1"># make the test request</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">OUTCOMES_API_URL</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">req_xml</span><span class="p">,</span> <span class="n">content_type</span><span class="o">=</span><span class="s1">&#39;application/xml&#39;</span><span class="p">,</span>
                         <span class="n">HTTP_AUTHORIZATION</span><span class="o">=</span><span class="n">oa_headers</span><span class="p">[</span><span class="s1">&#39;Authorization&#39;</span><span class="p">],</span>
                         <span class="n">SERVER_NAME</span><span class="o">=</span><span class="s1">&#39;aplus.local&#39;</span><span class="p">)</span>
        <span class="n">response_xml</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>

        <span class="n">expected_response_xml</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BASE_OUTCOMES_RESPONSE_XML</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">msg_id</span><span class="o">=</span><span class="s1">&#39;xxxxx&#39;</span><span class="p">,</span> <span class="c1"># random, can not know beforehand</span>
            <span class="n">code_major</span><span class="o">=</span><span class="s1">&#39;failure&#39;</span><span class="p">,</span>
            <span class="n">severity</span><span class="o">=</span><span class="s1">&#39;status&#39;</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s1">&#39;THIS FIELD IS NOT VALIDATED&#39;</span><span class="p">,</span>
            <span class="n">msg_ref_id</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="n">operation_ref</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="n">extra_status</span><span class="o">=</span><span class="s1">&#39;&lt;imsx_codeMinor&gt;invalidsourcedata&lt;/imsx_codeMinor&gt;&#39;</span><span class="p">,</span>
            <span class="n">body</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertLTIOutcomesResponseXMLEqual</span><span class="p">(</span>
            <span class="n">response_xml</span><span class="p">,</span>
            <span class="n">expected_response_xml</span><span class="p">,</span>
            <span class="n">ignore_elems</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;imsx_description&#39;</span><span class="p">},</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">)</span>
        <span class="c1"># check that no submission was made</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Submission</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span></div>


<div class="viewcode-block" id="LTIOutcomesTests.test_no_auth_header">
<a class="viewcode-back" href="../../../external_services.api.html#external_services.api.tests.LTIOutcomesTests.test_no_auth_header">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_no_auth_header</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># no HTTP Authorization header in the request, auth fails</span>
        <span class="n">sourced_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mk_sourced_id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lti_exercise</span><span class="p">,</span> <span class="n">enrollment</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">student1_enrollment</span><span class="p">)</span>
        <span class="n">req_xml</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BASE_OUTCOMES_REQUEST_XML</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">msg_id</span><span class="o">=</span><span class="s1">&#39;lofide7364ghdhsu&#39;</span><span class="p">,</span>
            <span class="n">operation</span><span class="o">=</span><span class="s1">&#39;replaceResult&#39;</span><span class="p">,</span>
            <span class="n">sourced_id</span><span class="o">=</span><span class="n">sourced_id</span><span class="p">,</span>
            <span class="n">result</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">BASE_RESULT_XML</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">score</span><span class="o">=</span><span class="s1">&#39;0.64&#39;</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="c1"># make the test request</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">OUTCOMES_API_URL</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">req_xml</span><span class="p">,</span> <span class="n">content_type</span><span class="o">=</span><span class="s1">&#39;application/xml&#39;</span><span class="p">,</span>
                         <span class="n">SERVER_NAME</span><span class="o">=</span><span class="s1">&#39;aplus.local&#39;</span><span class="p">)</span>
        <span class="n">response_xml</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>

        <span class="n">expected_response_xml</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BASE_OUTCOMES_RESPONSE_XML</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">msg_id</span><span class="o">=</span><span class="s1">&#39;xxxxx&#39;</span><span class="p">,</span> <span class="c1"># random, can not know beforehand</span>
            <span class="n">code_major</span><span class="o">=</span><span class="s1">&#39;failure&#39;</span><span class="p">,</span>
            <span class="n">severity</span><span class="o">=</span><span class="s1">&#39;status&#39;</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s1">&#39;Authentication credentials were not provided.&#39;</span><span class="p">,</span>
            <span class="n">msg_ref_id</span><span class="o">=</span><span class="s1">&#39;lofide7364ghdhsu&#39;</span><span class="p">,</span>
            <span class="n">operation_ref</span><span class="o">=</span><span class="s1">&#39;replaceResult&#39;</span><span class="p">,</span>
            <span class="n">extra_status</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="n">body</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertLTIOutcomesResponseXMLEqual</span><span class="p">(</span><span class="n">response_xml</span><span class="p">,</span> <span class="n">expected_response_xml</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="n">status</span><span class="o">.</span><span class="n">HTTP_403_FORBIDDEN</span><span class="p">)</span>
        <span class="c1"># check that no submission was made</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Submission</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span></div>


<div class="viewcode-block" id="LTIOutcomesTests.test_nonce_reuse">
<a class="viewcode-back" href="../../../external_services.api.html#external_services.api.tests.LTIOutcomesTests.test_nonce_reuse">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_nonce_reuse</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># reuse the same nonce another time, authentication should fail</span>
        <span class="n">sourced_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mk_sourced_id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lti_exercise</span><span class="p">,</span> <span class="n">enrollment</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">student1_enrollment</span><span class="p">)</span>
        <span class="n">req_xml</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BASE_OUTCOMES_REQUEST_XML</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">msg_id</span><span class="o">=</span><span class="s1">&#39;hvudfud7e63y&#39;</span><span class="p">,</span>
            <span class="n">operation</span><span class="o">=</span><span class="s1">&#39;replaceResult&#39;</span><span class="p">,</span>
            <span class="n">sourced_id</span><span class="o">=</span><span class="n">sourced_id</span><span class="p">,</span>
            <span class="n">result</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">BASE_RESULT_XML</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">score</span><span class="o">=</span><span class="s1">&#39;0.64&#39;</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="c1"># OAuth1 signature and body hash for the HTTP request Authorization header</span>
        <span class="n">oauth_client</span> <span class="o">=</span> <span class="n">oauthlib</span><span class="o">.</span><span class="n">oauth1</span><span class="o">.</span><span class="n">Client</span><span class="p">(</span>
            <span class="n">client_key</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lti_service</span><span class="o">.</span><span class="n">consumer_key</span><span class="p">,</span>
            <span class="n">client_secret</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lti_service</span><span class="o">.</span><span class="n">consumer_secret</span><span class="p">,</span>
            <span class="n">signature_method</span><span class="o">=</span><span class="n">oauthlib</span><span class="o">.</span><span class="n">oauth1</span><span class="o">.</span><span class="n">SIGNATURE_HMAC</span><span class="p">,</span>
            <span class="n">signature_type</span><span class="o">=</span><span class="n">oauthlib</span><span class="o">.</span><span class="n">oauth1</span><span class="o">.</span><span class="n">SIGNATURE_TYPE_AUTH_HEADER</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># pylint: disable-next=unused-variable</span>
        <span class="n">oa_uri</span><span class="p">,</span> <span class="n">oa_headers</span><span class="p">,</span> <span class="n">oa_body</span> <span class="o">=</span> <span class="n">oauth_client</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="s1">&#39;http://aplus.local&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">OUTCOMES_API_URL</span><span class="p">,</span>
            <span class="n">http_method</span><span class="o">=</span><span class="s1">&#39;POST&#39;</span><span class="p">,</span>
            <span class="n">body</span><span class="o">=</span><span class="n">req_xml</span><span class="p">,</span>
            <span class="n">headers</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;Content-Type&#39;</span><span class="p">:</span> <span class="s1">&#39;application/xml&#39;</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">)</span>

        <span class="c1"># make the test request</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">OUTCOMES_API_URL</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">req_xml</span><span class="p">,</span> <span class="n">content_type</span><span class="o">=</span><span class="s1">&#39;application/xml&#39;</span><span class="p">,</span>
                <span class="n">HTTP_AUTHORIZATION</span><span class="o">=</span><span class="n">oa_headers</span><span class="p">[</span><span class="s1">&#39;Authorization&#39;</span><span class="p">],</span>
                <span class="n">SERVER_NAME</span><span class="o">=</span><span class="s1">&#39;aplus.local&#39;</span><span class="p">)</span>
        <span class="n">response_xml</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>

        <span class="n">expected_response_xml</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BASE_OUTCOMES_RESPONSE_XML</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">msg_id</span><span class="o">=</span><span class="s1">&#39;xxxxx&#39;</span><span class="p">,</span> <span class="c1"># random, can not know beforehand</span>
            <span class="n">code_major</span><span class="o">=</span><span class="s1">&#39;success&#39;</span><span class="p">,</span>
            <span class="n">severity</span><span class="o">=</span><span class="s1">&#39;status&#39;</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s1">&#39;Score </span><span class="si">{}</span><span class="s1"> added to sourcedId </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;0.64&#39;</span><span class="p">,</span> <span class="n">sourced_id</span><span class="p">),</span>
            <span class="n">msg_ref_id</span><span class="o">=</span><span class="s1">&#39;hvudfud7e63y&#39;</span><span class="p">,</span>
            <span class="n">operation_ref</span><span class="o">=</span><span class="s1">&#39;replaceResult&#39;</span><span class="p">,</span>
            <span class="n">extra_status</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="n">body</span><span class="o">=</span><span class="s1">&#39;&lt;replaceResultResponse/&gt;&#39;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertLTIOutcomesResponseXMLEqual</span><span class="p">(</span><span class="n">response_xml</span><span class="p">,</span> <span class="n">expected_response_xml</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="n">status</span><span class="o">.</span><span class="n">HTTP_200_OK</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Submission</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># send the same request again, the nonce check should fail</span>
        <span class="n">response2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">OUTCOMES_API_URL</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">req_xml</span><span class="p">,</span> <span class="n">content_type</span><span class="o">=</span><span class="s1">&#39;application/xml&#39;</span><span class="p">,</span>
                <span class="n">HTTP_AUTHORIZATION</span><span class="o">=</span><span class="n">oa_headers</span><span class="p">[</span><span class="s1">&#39;Authorization&#39;</span><span class="p">],</span>
                <span class="n">SERVER_NAME</span><span class="o">=</span><span class="s1">&#39;aplus.local&#39;</span><span class="p">)</span>
        <span class="n">response_xml2</span> <span class="o">=</span> <span class="n">response2</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>

        <span class="n">expected_response_xml2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BASE_OUTCOMES_RESPONSE_XML</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">msg_id</span><span class="o">=</span><span class="s1">&#39;xxxxx&#39;</span><span class="p">,</span> <span class="c1"># random, can not know beforehand</span>
            <span class="n">code_major</span><span class="o">=</span><span class="s1">&#39;failure&#39;</span><span class="p">,</span>
            <span class="n">severity</span><span class="o">=</span><span class="s1">&#39;status&#39;</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s1">&#39;OAuth verification failed: oauth_nonce has been used&#39;</span><span class="p">,</span>
            <span class="n">msg_ref_id</span><span class="o">=</span><span class="s1">&#39;hvudfud7e63y&#39;</span><span class="p">,</span>
            <span class="n">operation_ref</span><span class="o">=</span><span class="s1">&#39;replaceResult&#39;</span><span class="p">,</span>
            <span class="n">extra_status</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="n">body</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertLTIOutcomesResponseXMLEqual</span><span class="p">(</span><span class="n">response_xml2</span><span class="p">,</span> <span class="n">expected_response_xml2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">response2</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="n">status</span><span class="o">.</span><span class="n">HTTP_403_FORBIDDEN</span><span class="p">)</span>
        <span class="c1"># no second submission was created</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Submission</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span></div>


<div class="viewcode-block" id="LTIOutcomesTests.test_invalid_req_XML">
<a class="viewcode-back" href="../../../external_services.api.html#external_services.api.tests.LTIOutcomesTests.test_invalid_req_XML">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_invalid_req_XML</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># LTI XML parser raises ParseError, wrong root element</span>
        <span class="n">req_xml</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="s1">&lt;POXEnvelopeRequest xmlns=&quot;http://www.imsglobal.org/services/ltiv1p1/xsd/imsoms_v1p0&quot;&gt;</span>
<span class="s1">  &lt;imsx_POXHeader&gt;</span>
<span class="s1">    &lt;imsx_POXRequestHeaderInfo&gt;</span>
<span class="s1">      &lt;imsx_version&gt;V1.0&lt;/imsx_version&gt;</span>
<span class="s1">      &lt;imsx_messageIdentifier&gt;jgjfud73746373ydh&lt;/imsx_messageIdentifier&gt;</span>
<span class="s1">    &lt;/imsx_POXRequestHeaderInfo&gt;</span>
<span class="s1">  &lt;/imsx_POXHeader&gt;</span>
<span class="s1">&lt;/POXEnvelopeRequest&gt;&#39;&#39;&#39;</span>

        <span class="c1"># make the test request</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">force_authenticate</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">LTIServiceUser</span><span class="p">())</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">OUTCOMES_API_URL</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">req_xml</span><span class="p">,</span> <span class="n">content_type</span><span class="o">=</span><span class="s1">&#39;application/xml&#39;</span><span class="p">)</span>
        <span class="n">response_xml</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>

        <span class="n">expected_response_xml</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BASE_OUTCOMES_RESPONSE_XML</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">msg_id</span><span class="o">=</span><span class="s1">&#39;xxxxx&#39;</span><span class="p">,</span> <span class="c1"># random, can not know beforehand</span>
            <span class="n">code_major</span><span class="o">=</span><span class="s1">&#39;failure&#39;</span><span class="p">,</span>
            <span class="n">severity</span><span class="o">=</span><span class="s1">&#39;status&#39;</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="p">(</span>
                <span class="s1">&#39;The XML root element is not &#39;</span>
                <span class="s1">&#39;&quot;{http://www.imsglobal.org/services/ltiv1p1/xsd/imsoms_v1p0}imsx_POXEnvelopeRequest&quot;&#39;</span>
            <span class="p">),</span>
            <span class="n">msg_ref_id</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="n">operation_ref</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="n">extra_status</span><span class="o">=</span><span class="s1">&#39;&lt;imsx_codeMinor&gt;invalidsourcedata&lt;/imsx_codeMinor&gt;&#39;</span><span class="p">,</span>
            <span class="n">body</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertLTIOutcomesResponseXMLEqual</span><span class="p">(</span><span class="n">response_xml</span><span class="p">,</span> <span class="n">expected_response_xml</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">)</span>
        <span class="c1"># check that no submission was made</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Submission</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span></div>


<div class="viewcode-block" id="LTIOutcomesTests.test_exceed_submission_limit">
<a class="viewcode-back" href="../../../external_services.api.html#external_services.api.tests.LTIOutcomesTests.test_exceed_submission_limit">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_exceed_submission_limit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># student submits too many times. The exercise has limited the max submissions.</span>
        <span class="c1"># create the max number of submissions</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lti_exercise2</span><span class="o">.</span><span class="n">max_submissions</span><span class="p">):</span>
            <span class="n">submission</span> <span class="o">=</span> <span class="n">Submission</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
                <span class="n">exercise</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lti_exercise2</span><span class="p">,</span>
                <span class="n">status</span><span class="o">=</span><span class="n">Submission</span><span class="o">.</span><span class="n">STATUS</span><span class="o">.</span><span class="n">READY</span><span class="p">,</span>
                <span class="n">grade</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">submission</span><span class="o">.</span><span class="n">submitters</span><span class="o">.</span><span class="n">set</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">student1_profile</span><span class="p">])</span>

        <span class="c1"># try to make a new submission</span>
        <span class="n">sourced_id1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mk_sourced_id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lti_exercise2</span><span class="p">,</span> <span class="n">enrollment</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">student1_enrollment</span><span class="p">)</span>
        <span class="n">req_xml1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BASE_OUTCOMES_REQUEST_XML</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">msg_id</span><span class="o">=</span><span class="s1">&#39;sawye8fjvjfie734&#39;</span><span class="p">,</span>
            <span class="n">operation</span><span class="o">=</span><span class="s1">&#39;replaceResult&#39;</span><span class="p">,</span>
            <span class="n">sourced_id</span><span class="o">=</span><span class="n">sourced_id1</span><span class="p">,</span>
            <span class="n">result</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">BASE_RESULT_XML</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">score</span><span class="o">=</span><span class="s1">&#39;0.95&#39;</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">force_authenticate</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lti_user2</span><span class="p">)</span> <span class="c1"># skip OAuth credentials</span>
        <span class="n">response1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">OUTCOMES_API_URL</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">req_xml1</span><span class="p">,</span> <span class="n">content_type</span><span class="o">=</span><span class="s1">&#39;application/xml&#39;</span><span class="p">)</span>
        <span class="n">response_xml1</span> <span class="o">=</span> <span class="n">response1</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="n">expected_response_xml1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BASE_OUTCOMES_RESPONSE_XML</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">msg_id</span><span class="o">=</span><span class="s1">&#39;xxxx&#39;</span><span class="p">,</span> <span class="c1"># random, can not know beforehand</span>
            <span class="n">code_major</span><span class="o">=</span><span class="s1">&#39;failure&#39;</span><span class="p">,</span>
            <span class="n">severity</span><span class="o">=</span><span class="s1">&#39;status&#39;</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s1">&#39;You have used the allowed amount of submissions for this assignment.&#39;</span><span class="p">,</span>
            <span class="n">msg_ref_id</span><span class="o">=</span><span class="s1">&#39;sawye8fjvjfie734&#39;</span><span class="p">,</span>
            <span class="n">operation_ref</span><span class="o">=</span><span class="s1">&#39;replaceResult&#39;</span><span class="p">,</span>
            <span class="n">extra_status</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="n">body</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertLTIOutcomesResponseXMLEqual</span><span class="p">(</span><span class="n">response_xml1</span><span class="p">,</span> <span class="n">expected_response_xml1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">response1</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="n">status</span><span class="o">.</span><span class="n">HTTP_200_OK</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Submission</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">lti_exercise2</span><span class="o">.</span><span class="n">max_submissions</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="LTIOutcomesNoEnrollmentTests">
<a class="viewcode-back" href="../../../external_services.api.html#external_services.api.tests.LTIOutcomesNoEnrollmentTests">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">LTIOutcomesNoEnrollmentTests</span><span class="p">(</span><span class="n">LTIOutcomesBaseTest</span><span class="p">):</span>

<div class="viewcode-block" id="LTIOutcomesNoEnrollmentTests.setUpTestData">
<a class="viewcode-back" href="../../../external_services.api.html#external_services.api.tests.LTIOutcomesNoEnrollmentTests.setUpTestData">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">setUpTestData</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">now</span> <span class="o">=</span> <span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">year_before</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">now</span> <span class="o">-</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">365</span><span class="p">)</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">year_after</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">now</span> <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">365</span><span class="p">)</span>

        <span class="bp">cls</span><span class="o">.</span><span class="n">student1</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create_user</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s1">&#39;student1&#39;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s1">&#39;123456&#39;</span><span class="p">)</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">student1_profile</span> <span class="o">=</span> <span class="n">UserProfile</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="n">student1</span><span class="p">)</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">student1_profile</span><span class="o">.</span><span class="n">student_id</span> <span class="o">=</span> <span class="s1">&#39;123456&#39;</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">student1_profile</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

        <span class="bp">cls</span><span class="o">.</span><span class="n">lti_service</span> <span class="o">=</span> <span class="n">LTIService</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">url</span><span class="o">=</span><span class="s1">&#39;http://localhost:8080/lti-launch&#39;</span><span class="p">,</span> <span class="c1"># fake URL</span>
            <span class="n">consumer_key</span><span class="o">=</span><span class="s1">&#39;apluskey&#39;</span><span class="p">,</span>
            <span class="n">consumer_secret</span><span class="o">=</span><span class="s1">&#39;aplussecret&#39;</span><span class="p">,</span>
            <span class="n">access_settings</span><span class="o">=</span><span class="n">LTIService</span><span class="o">.</span><span class="n">LTI_ACCESS</span><span class="o">.</span><span class="n">ANON_API_NO</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">course</span> <span class="o">=</span> <span class="n">Course</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Test course&#39;</span><span class="p">,</span>
            <span class="n">code</span><span class="o">=</span><span class="s1">&#39;test&#39;</span><span class="p">,</span>
            <span class="n">url</span><span class="o">=</span><span class="s1">&#39;test&#39;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">course_instance</span> <span class="o">=</span> <span class="n">CourseInstance</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">course</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="n">course</span><span class="p">,</span>
            <span class="n">instance_name</span><span class="o">=</span><span class="s1">&#39;Test&#39;</span><span class="p">,</span>
            <span class="n">url</span><span class="o">=</span><span class="s1">&#39;test&#39;</span><span class="p">,</span>
            <span class="n">starting_time</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="n">year_before</span><span class="p">,</span>
            <span class="n">ending_time</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="n">year_after</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">cls</span><span class="o">.</span><span class="n">category</span> <span class="o">=</span> <span class="n">LearningObjectCategory</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;LTI exercises&#39;</span><span class="p">,</span>
            <span class="n">course_instance</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="n">course_instance</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="LTIOutcomesNoEnrollmentTests.test_replaceResult_without_enrollment">
<a class="viewcode-back" href="../../../external_services.api.html#external_services.api.tests.LTIOutcomesNoEnrollmentTests.test_replaceResult_without_enrollment">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_replaceResult_without_enrollment</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">course_module</span> <span class="o">=</span> <span class="n">CourseModule</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Module 1&#39;</span><span class="p">,</span>
            <span class="n">url</span><span class="o">=</span><span class="s1">&#39;module1&#39;</span><span class="p">,</span>
            <span class="n">course_instance</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">course_instance</span><span class="p">,</span>
            <span class="n">opening_time</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">year_before</span><span class="p">,</span>
            <span class="n">closing_time</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">year_after</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">lti_exercise</span> <span class="o">=</span> <span class="n">LTIExercise</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;LTI exercise 1&#39;</span><span class="p">,</span>
            <span class="n">category</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">category</span><span class="p">,</span>
            <span class="n">course_module</span><span class="o">=</span><span class="n">course_module</span><span class="p">,</span>
            <span class="n">url</span><span class="o">=</span><span class="s1">&#39;ltiex1&#39;</span><span class="p">,</span>
            <span class="n">max_points</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
            <span class="n">max_submissions</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
            <span class="n">lti_service</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lti_service</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># try to make a new submission</span>
        <span class="c1"># fake sourced id since there is no enrollment</span>
        <span class="n">sourced_id1</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">-</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">lti_exercise</span><span class="o">.</span><span class="n">pk</span><span class="p">,</span> <span class="s1">&#39;ahdjdue73yrhdhsdy6we6&#39;</span><span class="p">)</span>
        <span class="n">req_xml1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BASE_OUTCOMES_REQUEST_XML</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">msg_id</span><span class="o">=</span><span class="s1">&#39;zjdudu7w6784hthr&#39;</span><span class="p">,</span>
            <span class="n">operation</span><span class="o">=</span><span class="s1">&#39;replaceResult&#39;</span><span class="p">,</span>
            <span class="n">sourced_id</span><span class="o">=</span><span class="n">sourced_id1</span><span class="p">,</span>
            <span class="n">result</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">BASE_RESULT_XML</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">score</span><span class="o">=</span><span class="s1">&#39;0.76&#39;</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="c1"># skip OAuth credentials</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">force_authenticate</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">LTIServiceUser</span><span class="p">(</span><span class="n">exercise</span><span class="o">=</span><span class="n">lti_exercise</span><span class="p">,</span> <span class="n">lti_service</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lti_service</span><span class="p">))</span>
        <span class="c1"># authentication would also require a valid sourced id value, but authentication is skipped now</span>
        <span class="n">response1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">OUTCOMES_API_URL</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">req_xml1</span><span class="p">,</span> <span class="n">content_type</span><span class="o">=</span><span class="s1">&#39;application/xml&#39;</span><span class="p">)</span>
        <span class="n">response_xml1</span> <span class="o">=</span> <span class="n">response1</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="n">expected_response_xml1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BASE_OUTCOMES_RESPONSE_XML</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">msg_id</span><span class="o">=</span><span class="s1">&#39;xxxx&#39;</span><span class="p">,</span> <span class="c1"># random, can not know beforehand</span>
            <span class="n">code_major</span><span class="o">=</span><span class="s1">&#39;failure&#39;</span><span class="p">,</span>
            <span class="n">severity</span><span class="o">=</span><span class="s1">&#39;status&#39;</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s1">&#39;sourced_id: Invalid sourcedId.&#39;</span><span class="p">,</span>
            <span class="n">msg_ref_id</span><span class="o">=</span><span class="s1">&#39;zjdudu7w6784hthr&#39;</span><span class="p">,</span>
            <span class="n">operation_ref</span><span class="o">=</span><span class="s1">&#39;replaceResult&#39;</span><span class="p">,</span>
            <span class="n">extra_status</span><span class="o">=</span><span class="s1">&#39;&lt;imsx_codeMinor&gt;invalidsourcedata&lt;/imsx_codeMinor&gt;&#39;</span><span class="p">,</span>
            <span class="n">body</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertLTIOutcomesResponseXMLEqual</span><span class="p">(</span><span class="n">response_xml1</span><span class="p">,</span> <span class="n">expected_response_xml1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">response1</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Submission</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span></div>


<div class="viewcode-block" id="LTIOutcomesNoEnrollmentTests.test_replaceResult_after_deadline">
<a class="viewcode-back" href="../../../external_services.api.html#external_services.api.tests.LTIOutcomesNoEnrollmentTests.test_replaceResult_after_deadline">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_replaceResult_after_deadline</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">student1_enrollment</span> <span class="o">=</span> <span class="n">Enrollment</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">course_instance</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">course_instance</span><span class="p">,</span>
            <span class="n">user_profile</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">student1_profile</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">course_module</span> <span class="o">=</span> <span class="n">CourseModule</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Module 1&#39;</span><span class="p">,</span>
            <span class="n">url</span><span class="o">=</span><span class="s1">&#39;module1&#39;</span><span class="p">,</span>
            <span class="n">course_instance</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">course_instance</span><span class="p">,</span>
            <span class="n">opening_time</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">year_before</span><span class="p">,</span>
            <span class="n">closing_time</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">now</span> <span class="o">-</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="c1"># deadline has passed</span>
        <span class="p">)</span>
        <span class="n">lti_exercise</span> <span class="o">=</span> <span class="n">LTIExercise</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;LTI exercise 1&#39;</span><span class="p">,</span>
            <span class="n">category</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">category</span><span class="p">,</span>
            <span class="n">course_module</span><span class="o">=</span><span class="n">course_module</span><span class="p">,</span>
            <span class="n">url</span><span class="o">=</span><span class="s1">&#39;ltiex1&#39;</span><span class="p">,</span>
            <span class="n">max_points</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
            <span class="n">max_submissions</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
            <span class="n">lti_service</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lti_service</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># try to make a new submission</span>
        <span class="n">sourced_id1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mk_sourced_id</span><span class="p">(</span><span class="n">lti_exercise</span><span class="p">,</span> <span class="n">enrollment</span><span class="o">=</span><span class="n">student1_enrollment</span><span class="p">)</span>
        <span class="n">req_xml1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BASE_OUTCOMES_REQUEST_XML</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">msg_id</span><span class="o">=</span><span class="s1">&#39;vbxhsgsy764y3dg&#39;</span><span class="p">,</span>
            <span class="n">operation</span><span class="o">=</span><span class="s1">&#39;replaceResult&#39;</span><span class="p">,</span>
            <span class="n">sourced_id</span><span class="o">=</span><span class="n">sourced_id1</span><span class="p">,</span>
            <span class="n">result</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">BASE_RESULT_XML</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">score</span><span class="o">=</span><span class="s1">&#39;0.76&#39;</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">force_authenticate</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">LTIServiceUser</span><span class="p">(</span><span class="n">exercise</span><span class="o">=</span><span class="n">lti_exercise</span><span class="p">,</span>
                                                           <span class="n">lti_service</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lti_service</span><span class="p">,</span>
                                                           <span class="n">user_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">student1</span><span class="o">.</span><span class="n">id</span><span class="p">))</span> <span class="c1"># skip OAuth credentials</span>
        <span class="n">response1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">OUTCOMES_API_URL</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">req_xml1</span><span class="p">,</span> <span class="n">content_type</span><span class="o">=</span><span class="s1">&#39;application/xml&#39;</span><span class="p">)</span>
        <span class="n">response_xml1</span> <span class="o">=</span> <span class="n">response1</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="n">expected_response_xml1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BASE_OUTCOMES_RESPONSE_XML</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">msg_id</span><span class="o">=</span><span class="s1">&#39;xxxx&#39;</span><span class="p">,</span> <span class="c1"># random, can not know beforehand</span>
            <span class="n">code_major</span><span class="o">=</span><span class="s1">&#39;failure&#39;</span><span class="p">,</span>
            <span class="n">severity</span><span class="o">=</span><span class="s1">&#39;status&#39;</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s1">&#39;The deadline for the assignment has passed (</span><span class="si">{date}</span><span class="s1">).&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">date</span><span class="o">=</span><span class="n">date_format</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">localtime</span><span class="p">(</span><span class="n">course_module</span><span class="o">.</span><span class="n">closing_time</span><span class="p">),</span> <span class="s2">&quot;DATETIME_FORMAT&quot;</span><span class="p">)),</span>
            <span class="n">msg_ref_id</span><span class="o">=</span><span class="s1">&#39;vbxhsgsy764y3dg&#39;</span><span class="p">,</span>
            <span class="n">operation_ref</span><span class="o">=</span><span class="s1">&#39;replaceResult&#39;</span><span class="p">,</span>
            <span class="n">extra_status</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="n">body</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertLTIOutcomesResponseXMLEqual</span><span class="p">(</span><span class="n">response_xml1</span><span class="p">,</span> <span class="n">expected_response_xml1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">response1</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="n">status</span><span class="o">.</span><span class="n">HTTP_200_OK</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Submission</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="LTIOutcomesPublicServiceTests">
<a class="viewcode-back" href="../../../external_services.api.html#external_services.api.tests.LTIOutcomesPublicServiceTests">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">LTIOutcomesPublicServiceTests</span><span class="p">(</span><span class="n">LTIOutcomesBaseTest</span><span class="p">):</span>

<div class="viewcode-block" id="LTIOutcomesPublicServiceTests.setUpTestData">
<a class="viewcode-back" href="../../../external_services.api.html#external_services.api.tests.LTIOutcomesPublicServiceTests.setUpTestData">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">setUpTestData</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">now</span> <span class="o">=</span> <span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">year_before</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">now</span> <span class="o">-</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">365</span><span class="p">)</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">year_after</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">now</span> <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">365</span><span class="p">)</span>

        <span class="bp">cls</span><span class="o">.</span><span class="n">student1</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create_user</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s1">&#39;student1&#39;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s1">&#39;123456&#39;</span><span class="p">)</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">student1_profile</span> <span class="o">=</span> <span class="n">UserProfile</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="n">student1</span><span class="p">)</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">student1_profile</span><span class="o">.</span><span class="n">student_id</span> <span class="o">=</span> <span class="s1">&#39;123456&#39;</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">student1_profile</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

        <span class="bp">cls</span><span class="o">.</span><span class="n">lti_service</span> <span class="o">=</span> <span class="n">LTIService</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">url</span><span class="o">=</span><span class="s1">&#39;http://localhost:8080/lti-launch&#39;</span><span class="p">,</span> <span class="c1"># fake URL</span>
            <span class="n">consumer_key</span><span class="o">=</span><span class="s1">&#39;apluskey&#39;</span><span class="p">,</span>
            <span class="n">consumer_secret</span><span class="o">=</span><span class="s1">&#39;aplussecret&#39;</span><span class="p">,</span>
            <span class="n">access_settings</span><span class="o">=</span><span class="n">LTIService</span><span class="o">.</span><span class="n">LTI_ACCESS</span><span class="o">.</span><span class="n">PUBLIC_API_NO</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">course</span> <span class="o">=</span> <span class="n">Course</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Test course&#39;</span><span class="p">,</span>
            <span class="n">code</span><span class="o">=</span><span class="s1">&#39;test&#39;</span><span class="p">,</span>
            <span class="n">url</span><span class="o">=</span><span class="s1">&#39;test&#39;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">course_instance</span> <span class="o">=</span> <span class="n">CourseInstance</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">course</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="n">course</span><span class="p">,</span>
            <span class="n">instance_name</span><span class="o">=</span><span class="s1">&#39;Test&#39;</span><span class="p">,</span>
            <span class="n">url</span><span class="o">=</span><span class="s1">&#39;test&#39;</span><span class="p">,</span>
            <span class="n">starting_time</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="n">year_before</span><span class="p">,</span>
            <span class="n">ending_time</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="n">year_after</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">student1_enrollment</span> <span class="o">=</span> <span class="n">Enrollment</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">course_instance</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="n">course_instance</span><span class="p">,</span>
            <span class="n">user_profile</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="n">student1_profile</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">course_module</span> <span class="o">=</span> <span class="n">CourseModule</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Module 1&#39;</span><span class="p">,</span>
            <span class="n">url</span><span class="o">=</span><span class="s1">&#39;module1&#39;</span><span class="p">,</span>
            <span class="n">course_instance</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="n">course_instance</span><span class="p">,</span>
            <span class="n">opening_time</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="n">now</span><span class="p">,</span>
            <span class="n">closing_time</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="n">year_after</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">category</span> <span class="o">=</span> <span class="n">LearningObjectCategory</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;LTI exercises&#39;</span><span class="p">,</span>
            <span class="n">course_instance</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="n">course_instance</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">lti_exercise</span> <span class="o">=</span> <span class="n">LTIExercise</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;LTI exercise 1&#39;</span><span class="p">,</span>
            <span class="n">category</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="n">category</span><span class="p">,</span>
            <span class="n">course_module</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="n">course_module</span><span class="p">,</span>
            <span class="n">url</span><span class="o">=</span><span class="s1">&#39;ltiex1&#39;</span><span class="p">,</span>
            <span class="n">max_points</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
            <span class="n">lti_service</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="n">lti_service</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">lti_exercise2</span> <span class="o">=</span> <span class="n">LTIExercise</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;LTI exercise 2&#39;</span><span class="p">,</span>
            <span class="n">category</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="n">category</span><span class="p">,</span>
            <span class="n">course_module</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="n">course_module</span><span class="p">,</span>
            <span class="n">url</span><span class="o">=</span><span class="s1">&#39;ltiex2&#39;</span><span class="p">,</span>
            <span class="n">max_points</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
            <span class="n">max_submissions</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
            <span class="n">lti_service</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="n">lti_service</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="LTIOutcomesPublicServiceTests.test_public_service_sourced_id">
<a class="viewcode-back" href="../../../external_services.api.html#external_services.api.tests.LTIOutcomesPublicServiceTests.test_public_service_sourced_id">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_public_service_sourced_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># make a replaceResult request</span>
        <span class="n">sourced_id1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mk_sourced_id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lti_exercise</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">student1</span><span class="p">)</span>
        <span class="n">req_xml1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BASE_OUTCOMES_REQUEST_XML</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">msg_id</span><span class="o">=</span><span class="s1">&#39;nbkif7e6whdhdujd&#39;</span><span class="p">,</span>
            <span class="n">operation</span><span class="o">=</span><span class="s1">&#39;replaceResult&#39;</span><span class="p">,</span>
            <span class="n">sourced_id</span><span class="o">=</span><span class="n">sourced_id1</span><span class="p">,</span>
            <span class="n">result</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">BASE_RESULT_XML</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">score</span><span class="o">=</span><span class="s1">&#39;0.35&#39;</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">force_authenticate</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">LTIServiceUser</span><span class="p">(</span><span class="n">exercise</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lti_exercise</span><span class="p">,</span>
                                                           <span class="n">lti_service</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lti_service</span><span class="p">,</span>
                                                           <span class="n">user_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">student1</span><span class="o">.</span><span class="n">id</span><span class="p">))</span> <span class="c1"># skip OAuth credentials</span>
        <span class="n">response1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">OUTCOMES_API_URL</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">req_xml1</span><span class="p">,</span> <span class="n">content_type</span><span class="o">=</span><span class="s1">&#39;application/xml&#39;</span><span class="p">)</span>
        <span class="n">response_xml1</span> <span class="o">=</span> <span class="n">response1</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="n">expected_response_xml1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BASE_OUTCOMES_RESPONSE_XML</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">msg_id</span><span class="o">=</span><span class="s1">&#39;xxxx&#39;</span><span class="p">,</span> <span class="c1"># random, can not know beforehand</span>
            <span class="n">code_major</span><span class="o">=</span><span class="s1">&#39;success&#39;</span><span class="p">,</span>
            <span class="n">severity</span><span class="o">=</span><span class="s1">&#39;status&#39;</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s1">&#39;Score </span><span class="si">{}</span><span class="s1"> added to sourcedId </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;0.35&#39;</span><span class="p">,</span> <span class="n">sourced_id1</span><span class="p">),</span>
            <span class="n">msg_ref_id</span><span class="o">=</span><span class="s1">&#39;nbkif7e6whdhdujd&#39;</span><span class="p">,</span>
            <span class="n">operation_ref</span><span class="o">=</span><span class="s1">&#39;replaceResult&#39;</span><span class="p">,</span>
            <span class="n">extra_status</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="n">body</span><span class="o">=</span><span class="s1">&#39;&lt;replaceResultResponse/&gt;&#39;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertLTIOutcomesResponseXMLEqual</span><span class="p">(</span><span class="n">response_xml1</span><span class="p">,</span> <span class="n">expected_response_xml1</span><span class="p">)</span>

        <span class="c1"># check the submissions in the database</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Submission</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">submission1</span> <span class="o">=</span> <span class="n">Submission</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">submission1</span><span class="o">.</span><span class="n">status</span><span class="p">,</span> <span class="s1">&#39;ready&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">submission1</span><span class="o">.</span><span class="n">exercise</span><span class="o">.</span><span class="n">pk</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lti_exercise</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span></div>
</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, A+ development team.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>