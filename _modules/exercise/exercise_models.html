

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>exercise.exercise_models &mdash; A+ 1.28 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=3011ec97"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            A+
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <!-- Local TOC -->
              <div class="local-toc"></div>
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">A+</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">exercise.exercise_models</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for exercise.exercise_models</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">annotations</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">TYPE_CHECKING</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">TypeVar</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">urllib.parse</span><span class="w"> </span><span class="kn">import</span> <span class="n">urlsplit</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">django.conf</span><span class="w"> </span><span class="kn">import</span> <span class="n">settings</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.contrib</span><span class="w"> </span><span class="kn">import</span> <span class="n">messages</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.contrib.auth.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">User</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.core.exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">ValidationError</span><span class="p">,</span> <span class="n">PermissionDenied</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.core.files.storage</span><span class="w"> </span><span class="kn">import</span> <span class="n">default_storage</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.http.request</span><span class="w"> </span><span class="kn">import</span> <span class="n">HttpRequest</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.db</span><span class="w"> </span><span class="kn">import</span> <span class="n">models</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.db.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">signals</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.db.models.signals</span><span class="w"> </span><span class="kn">import</span> <span class="n">post_delete</span><span class="p">,</span> <span class="n">post_save</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.template</span><span class="w"> </span><span class="kn">import</span> <span class="n">loader</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">timezone</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.utils.dateparse</span><span class="w"> </span><span class="kn">import</span> <span class="n">parse_datetime</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.utils.formats</span><span class="w"> </span><span class="kn">import</span> <span class="n">date_format</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.utils.text</span><span class="w"> </span><span class="kn">import</span> <span class="n">format_lazy</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.utils.translation</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_language</span><span class="p">,</span> <span class="n">gettext_lazy</span> <span class="k">as</span> <span class="n">_</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">aplus.api</span><span class="w"> </span><span class="kn">import</span> <span class="n">api_reverse</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">authorization.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">JWTAccessible</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">authorization.object_permissions</span><span class="w"> </span><span class="kn">import</span> <span class="n">register_jwt_accessible_class</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">course.models</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">Enrollment</span><span class="p">,</span>
    <span class="n">StudentGroup</span><span class="p">,</span>
    <span class="n">CourseInstance</span><span class="p">,</span>
    <span class="n">CourseModule</span><span class="p">,</span>
    <span class="n">CourseModuleProto</span><span class="p">,</span>
    <span class="n">LearningObjectCategory</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">external_services.lti</span><span class="w"> </span><span class="kn">import</span> <span class="n">CustomStudentInfoLTIRequest</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">external_services.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">LTIService</span><span class="p">,</span> <span class="n">LTI1p3Service</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">inheritance.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">ModelWithInheritance</span><span class="p">,</span> <span class="n">ModelWithInheritanceManager</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">lib.api.authentication</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">get_graderauth_submission_params</span><span class="p">,</span>
    <span class="n">get_graderauth_exercise_params</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">lib.fields</span><span class="w"> </span><span class="kn">import</span> <span class="n">DefaultForeignKey</span><span class="p">,</span> <span class="n">DefaultOneToOneField</span><span class="p">,</span> <span class="n">JSONField</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">lib.helpers</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">Enum</span><span class="p">,</span>
    <span class="n">update_url_params</span><span class="p">,</span>
    <span class="n">safe_file_name</span><span class="p">,</span>
    <span class="n">roman_numeral</span><span class="p">,</span>
    <span class="n">build_aplus_url</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">lib.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">UrlMixin</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">lib.localization_syntax</span><span class="w"> </span><span class="kn">import</span> <span class="n">pick_localized</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">lib.validators</span><span class="w"> </span><span class="kn">import</span> <span class="n">generate_url_key_validator</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">userprofile.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">UserProfile</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">.cache.exercise</span><span class="w"> </span><span class="kn">import</span> <span class="n">ExerciseCache</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.protocol.aplus</span><span class="w"> </span><span class="kn">import</span> <span class="n">load_exercise_page</span><span class="p">,</span> <span class="n">load_feedback_page</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.protocol.exercise_page</span><span class="w"> </span><span class="kn">import</span> <span class="n">ExercisePage</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.reveal_models</span><span class="w"> </span><span class="kn">import</span> <span class="n">RevealRule</span>

<span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">django.db.models.manager</span><span class="w"> </span><span class="kn">import</span> <span class="n">RelatedManager</span>

    <span class="kn">from</span><span class="w"> </span><span class="nn">deviations.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">DeadlineRuleDeviation</span><span class="p">,</span> <span class="n">MaxSubmissionsRuleDeviation</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">.submission_models</span><span class="w"> </span><span class="kn">import</span> <span class="n">Submission</span><span class="p">,</span> <span class="n">SubmissionDraft</span>


<div class="viewcode-block" id="LearningObjectManager">
<a class="viewcode-back" href="../../exercise.html#exercise.exercise_models.LearningObjectManager">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">LearningObjectManager</span><span class="p">(</span><span class="n">ModelWithInheritanceManager</span><span class="p">):</span>
<div class="viewcode-block" id="LearningObjectManager.get_queryset">
<a class="viewcode-back" href="../../exercise.html#exercise.exercise_models.LearningObjectManager.get_queryset">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_queryset</span><span class="p">()</span>
            <span class="o">.</span><span class="n">defer</span><span class="p">(</span><span class="s1">&#39;description&#39;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">select_related</span><span class="p">(</span>
                <span class="s1">&#39;course_module&#39;</span><span class="p">,</span>
                <span class="s1">&#39;course_module__course_instance&#39;</span><span class="p">,</span>
                <span class="s1">&#39;course_module__course_instance__course&#39;</span><span class="p">,</span>
                <span class="s1">&#39;category&#39;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">prefetch_related</span><span class="p">(</span><span class="s1">&#39;parent&#39;</span><span class="p">)</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="LearningObjectManager.find_enrollment_exercise">
<a class="viewcode-back" href="../../exercise.html#exercise.exercise_models.LearningObjectManager.find_enrollment_exercise">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">find_enrollment_exercise</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">course_instance</span><span class="p">,</span> <span class="n">is_external</span><span class="p">):</span>
        <span class="n">exercise</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">is_external</span><span class="p">:</span>
            <span class="n">exercise</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">course_module__course_instance</span><span class="o">=</span><span class="n">course_instance</span><span class="p">,</span>
                <span class="n">status</span><span class="o">=</span><span class="s1">&#39;enrollment_ext&#39;</span>
            <span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">exercise</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">course_module__course_instance</span><span class="o">=</span><span class="n">course_instance</span><span class="p">,</span>
            <span class="n">status</span><span class="o">=</span><span class="s1">&#39;enrollment&#39;</span>
        <span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span></div>
</div>



<span class="n">LObjProto</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s2">&quot;LObjProto&quot;</span><span class="p">,</span> <span class="n">bound</span><span class="o">=</span><span class="s2">&quot;LearningObjectProto&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="LearningObjectProto">
<a class="viewcode-back" href="../../exercise.html#exercise.exercise_models.LearningObjectProto">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">LearningObjectProto</span><span class="p">(</span><span class="n">UrlMixin</span><span class="p">):</span>
    <span class="n">ABSOLUTE_URL_NAME</span> <span class="o">=</span> <span class="s2">&quot;exercise&quot;</span>
    <span class="n">url</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">course_module</span><span class="p">:</span> <span class="n">CourseModuleProto</span>
    <span class="n">parent</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">LearningObjectProto</span><span class="p">]</span>
    <span class="n">status</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">order</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">category_status</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">module_status</span><span class="p">:</span> <span class="nb">str</span>

<div class="viewcode-block" id="LearningObjectProto.get_path">
<a class="viewcode-back" href="../../exercise.html#exercise.exercise_models.LearningObjectProto.get_path">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_path</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;/&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">o</span><span class="o">.</span><span class="n">url</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_list</span><span class="p">()])</span></div>


<div class="viewcode-block" id="LearningObjectProto.parent_list">
<a class="viewcode-back" href="../../exercise.html#exercise.exercise_models.LearningObjectProto.parent_list">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">parent_list</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">LObjProto</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">LObjProto</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="si">}</span><span class="s2"> must implement parent_list&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="LearningObjectProto.get_url_kwargs">
<a class="viewcode-back" href="../../exercise.html#exercise.exercise_models.LearningObjectProto.get_url_kwargs">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_url_kwargs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;exercise_path&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_path</span><span class="p">(),</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">course_module</span><span class="o">.</span><span class="n">get_url_kwargs</span><span class="p">()}</span></div>


<div class="viewcode-block" id="LearningObjectProto.get_display_url">
<a class="viewcode-back" href="../../exercise.html#exercise.exercise_models.LearningObjectProto.get_display_url">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_display_url</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">LearningObject</span><span class="o">.</span><span class="n">STATUS</span><span class="o">.</span><span class="n">UNLISTED</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">#chapter-exercise-</span><span class="si">{:d}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">get_absolute_url</span><span class="p">(),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">order</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_absolute_url</span><span class="p">()</span></div>


<div class="viewcode-block" id="LearningObjectProto.is_visible">
<a class="viewcode-back" href="../../exercise.html#exercise.exercise_models.LearningObjectProto.is_visible">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">is_visible</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">category_status</span> <span class="o">!=</span> <span class="n">LearningObjectCategory</span><span class="o">.</span><span class="n">STATUS</span><span class="o">.</span><span class="n">HIDDEN</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">module_status</span> <span class="o">!=</span> <span class="n">CourseModule</span><span class="o">.</span><span class="n">STATUS</span><span class="o">.</span><span class="n">HIDDEN</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span>
                <span class="n">LearningObject</span><span class="o">.</span><span class="n">STATUS</span><span class="o">.</span><span class="n">HIDDEN</span><span class="p">,</span>
                <span class="n">LearningObject</span><span class="o">.</span><span class="n">STATUS</span><span class="o">.</span><span class="n">ENROLLMENT</span><span class="p">,</span>
                <span class="n">LearningObject</span><span class="o">.</span><span class="n">STATUS</span><span class="o">.</span><span class="n">ENROLLMENT_EXTERNAL</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="LearningObjectProto.is_listed">
<a class="viewcode-back" href="../../exercise.html#exercise.exercise_models.LearningObjectProto.is_listed">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">is_listed</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_visible</span><span class="p">()</span> <span class="ow">and</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">module_status</span> <span class="o">!=</span> <span class="n">CourseModule</span><span class="o">.</span><span class="n">STATUS</span><span class="o">.</span><span class="n">UNLISTED</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span>
                <span class="n">LearningObject</span><span class="o">.</span><span class="n">STATUS</span><span class="o">.</span><span class="n">UNLISTED</span><span class="p">,</span>
                <span class="n">LearningObject</span><span class="o">.</span><span class="n">STATUS</span><span class="o">.</span><span class="n">MAINTENANCE</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="LearningObjectProto.is_in_maintenance">
<a class="viewcode-back" href="../../exercise.html#exercise.exercise_models.LearningObjectProto.is_in_maintenance">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">is_in_maintenance</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">module_status</span> <span class="o">==</span> <span class="n">CourseModule</span><span class="o">.</span><span class="n">STATUS</span><span class="o">.</span><span class="n">MAINTENANCE</span>
            <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">LearningObject</span><span class="o">.</span><span class="n">STATUS</span><span class="o">.</span><span class="n">MAINTENANCE</span>
        <span class="p">)</span></div>
</div>



<div class="viewcode-block" id="LearningObject">
<a class="viewcode-back" href="../../exercise.html#exercise.exercise_models.LearningObject">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">LearningObject</span><span class="p">(</span><span class="n">LearningObjectProto</span><span class="p">,</span> <span class="n">ModelWithInheritance</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    All learning objects inherit this model.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">STATUS</span> <span class="o">=</span> <span class="n">Enum</span><span class="p">([</span>
        <span class="p">(</span><span class="s1">&#39;READY&#39;</span><span class="p">,</span> <span class="s1">&#39;ready&#39;</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;STATUS_READY&#39;</span><span class="p">)),</span>
        <span class="p">(</span><span class="s1">&#39;UNLISTED&#39;</span><span class="p">,</span> <span class="s1">&#39;unlisted&#39;</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;STATUS_UNLISTED&#39;</span><span class="p">)),</span>
        <span class="p">(</span><span class="s1">&#39;ENROLLMENT&#39;</span><span class="p">,</span> <span class="s1">&#39;enrollment&#39;</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;ENROLLMENT_QUESTIONS&#39;</span><span class="p">)),</span>
        <span class="p">(</span><span class="s1">&#39;ENROLLMENT_EXTERNAL&#39;</span><span class="p">,</span> <span class="s1">&#39;enrollment_ext&#39;</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;ENROLLMENT_QUESTIONS_FOR_EXTERNAL&#39;</span><span class="p">)),</span>
        <span class="p">(</span><span class="s1">&#39;HIDDEN&#39;</span><span class="p">,</span> <span class="s1">&#39;hidden&#39;</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;HIDDEN_FROM_NOT_COURSE_STAFF&#39;</span><span class="p">)),</span>
        <span class="p">(</span><span class="s1">&#39;MAINTENANCE&#39;</span><span class="p">,</span> <span class="s1">&#39;maintenance&#39;</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;STATUS_MAINTENANCE&#39;</span><span class="p">)),</span>
    <span class="p">])</span>
    <span class="n">AUDIENCE</span> <span class="o">=</span> <span class="n">Enum</span><span class="p">([</span>
        <span class="p">(</span><span class="s1">&#39;COURSE_AUDIENCE&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;AUDIENCE_COURSE_AUDIENCE&#39;</span><span class="p">)),</span>
        <span class="p">(</span><span class="s1">&#39;INTERNAL_USERS&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;AUDIENCE_INTERNAL_USERS&#39;</span><span class="p">)),</span>
        <span class="p">(</span><span class="s1">&#39;EXTERNAL_USERS&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;AUDIENCE_EXTERNAL_USERS&#39;</span><span class="p">)),</span>
        <span class="p">(</span><span class="s1">&#39;REGISTERED_USERS&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;AUDIENCE_REGISTERED_USERS&#39;</span><span class="p">)),</span>
    <span class="p">])</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span> <span class="c1"># type: ignore</span>
        <span class="n">verbose_name</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;LABEL_STATUS&#39;</span><span class="p">),</span>
        <span class="n">max_length</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span>
        <span class="n">choices</span><span class="o">=</span><span class="n">STATUS</span><span class="o">.</span><span class="n">choices</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">STATUS</span><span class="o">.</span><span class="n">READY</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">audience</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">IntegerField</span><span class="p">(</span>
        <span class="n">verbose_name</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;LABEL_AUDIENCE&#39;</span><span class="p">),</span>
        <span class="n">choices</span><span class="o">=</span><span class="n">AUDIENCE</span><span class="o">.</span><span class="n">choices</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="n">AUDIENCE</span><span class="o">.</span><span class="n">COURSE_AUDIENCE</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">category</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">LearningObjectCategory</span><span class="p">,</span>
        <span class="n">verbose_name</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;LABEL_CATEGORY&#39;</span><span class="p">),</span>
        <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">CASCADE</span><span class="p">,</span>
        <span class="n">related_name</span><span class="o">=</span><span class="s2">&quot;learning_objects&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">course_module</span><span class="p">:</span> <span class="n">CourseModule</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">CourseModule</span><span class="p">,</span> <span class="c1"># type: ignore</span>
        <span class="n">verbose_name</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;LABEL_COURSE_MODULE&#39;</span><span class="p">),</span>
        <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">CASCADE</span><span class="p">,</span>
        <span class="n">related_name</span><span class="o">=</span><span class="s2">&quot;learning_objects&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parent</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">LearningObject</span><span class="p">]</span> <span class="o">=</span> <span class="n">DefaultForeignKey</span><span class="p">(</span><span class="s1">&#39;self&#39;</span><span class="p">,</span> <span class="c1"># type: ignore</span>
        <span class="n">verbose_name</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;LABEL_PARENT&#39;</span><span class="p">),</span>
        <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">SET_NULL</span><span class="p">,</span>
        <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">related_name</span><span class="o">=</span><span class="s1">&#39;children&#39;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">order</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">IntegerField</span><span class="p">(</span> <span class="c1"># type: ignore</span>
        <span class="n">verbose_name</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;LABEL_ORDER&#39;</span><span class="p">),</span>
        <span class="n">default</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">url</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span>
        <span class="n">verbose_name</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;LABEL_URL&#39;</span><span class="p">),</span>
        <span class="n">max_length</span><span class="o">=</span><span class="mi">512</span><span class="p">,</span>
        <span class="n">help_text</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;LEARNING_OBJECT_URL_IDENTIFIER_HELPTEXT&#39;</span><span class="p">),</span>
        <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">generate_url_key_validator</span><span class="p">()],</span>
    <span class="p">)</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span>
        <span class="n">verbose_name</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;LABEL_NAME&#39;</span><span class="p">),</span>
        <span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">description</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">(</span>
        <span class="n">verbose_name</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;LABEL_DESCRIPTION&#39;</span><span class="p">),</span>
        <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">help_text</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;LEARNING_OBJECT_DESCRIPTION_HELPTEXT&#39;</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="n">use_wide_column</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">(</span>
        <span class="n">verbose_name</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;LABEL_USE_WIDE_COLUMN&#39;</span><span class="p">),</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">help_text</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;LEARNING_OBJECT_WIDE_COLUMN_HELPTEXT&#39;</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="n">service_url</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span>
        <span class="n">verbose_name</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;LABEL_SERVICE_URL&#39;</span><span class="p">),</span>
        <span class="n">max_length</span><span class="o">=</span><span class="mi">4096</span><span class="p">,</span>
        <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">exercise_info</span> <span class="o">=</span> <span class="n">JSONField</span><span class="p">(</span>
        <span class="n">verbose_name</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;LABEL_EXERCISE_INFO&#39;</span><span class="p">),</span>
        <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">model_answers</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">(</span>
        <span class="n">verbose_name</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;LABEL_MODEL_ANSWERS&#39;</span><span class="p">),</span>
        <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">help_text</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;LEARNING_OBJECT_MODEL_ANSWER_URLS_HELPTEXT&#39;</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="n">templates</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">(</span>
        <span class="n">verbose_name</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;LABEL_TEMPLATES&#39;</span><span class="p">),</span>
        <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">help_text</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;LEARNING_OBJECT_TEMPLATE_URLS_HELPTEXT&#39;</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="c1"># Keep this to support ExerciseWithAttachment</span>
    <span class="c1"># Maybe this should inject extra content to any exercise</span>
    <span class="n">content</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">(</span>
        <span class="n">verbose_name</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;LABEL_CONTENT&#39;</span><span class="p">),</span>
        <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">objects</span> <span class="o">=</span> <span class="n">LearningObjectManager</span><span class="p">()</span>
    <span class="c1"># Manager without prefetch/select_related or select_subclasses</span>
    <span class="n">bare_objects</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Manager</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
        <span class="nb">id</span><span class="p">:</span> <span class="nb">int</span>
        <span class="n">parent_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>
        <span class="n">children</span><span class="p">:</span> <span class="n">RelatedManager</span><span class="p">[</span><span class="s2">&quot;LearningObject&quot;</span><span class="p">]</span>
        <span class="n">model_answer_modules</span><span class="p">:</span> <span class="n">RelatedManager</span><span class="p">[</span><span class="s2">&quot;CourseModule&quot;</span><span class="p">]</span>

    <span class="k">class</span><span class="w"> </span><span class="nc">Meta</span><span class="p">:</span>
        <span class="n">verbose_name</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;MODEL_NAME_LEARNING_OBJECT&#39;</span><span class="p">)</span>
        <span class="n">verbose_name_plural</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;MODEL_NAME_LEARNING_OBJECT_PLURAL&#39;</span><span class="p">)</span>
        <span class="n">app_label</span> <span class="o">=</span> <span class="s2">&quot;exercise&quot;</span>
        <span class="n">ordering</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;course_module&#39;</span><span class="p">,</span> <span class="s1">&#39;order&#39;</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">]</span>
        <span class="n">unique_together</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;course_module&#39;</span><span class="p">,</span> <span class="s1">&#39;parent&#39;</span><span class="p">,</span> <span class="s1">&#39;url&#39;</span><span class="p">]</span>

<div class="viewcode-block" id="LearningObject.clean">
<a class="viewcode-back" href="../../exercise.html#exercise.exercise_models.LearningObject.clean">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">clean</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Validates the model before saving (standard method used in Django admin).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">clean</span><span class="p">()</span>
        <span class="n">errors</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">RESERVED</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;submissions&quot;</span><span class="p">,</span> <span class="s2">&quot;plain&quot;</span><span class="p">,</span> <span class="s2">&quot;info&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">url</span> <span class="ow">in</span> <span class="n">RESERVED</span><span class="p">:</span>
            <span class="n">errors</span><span class="p">[</span><span class="s1">&#39;url&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">format_lazy</span><span class="p">(</span>
                <span class="n">_</span><span class="p">(</span><span class="s1">&#39;TAKEN_WORDS_INCLUDE -- </span><span class="si">{}</span><span class="s1">&#39;</span><span class="p">),</span>
                <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">RESERVED</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">course_module</span><span class="o">.</span><span class="n">course_instance</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">category</span><span class="o">.</span><span class="n">course_instance</span><span class="p">:</span>
            <span class="n">errors</span><span class="p">[</span><span class="s1">&#39;category&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;LEARNING_OBJECT_ERROR_MODULE_AND_CATEGORY_MUST_HAVE_SAME_COURSE_INSTANCE&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">course_module</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">course_module</span><span class="p">:</span>
                <span class="n">errors</span><span class="p">[</span><span class="s1">&#39;parent&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;LEARNING_OBJECT_ERROR_PARENT_MUST_BE_FROM_SAME_MODULE&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">:</span>
                <span class="n">errors</span><span class="p">[</span><span class="s1">&#39;parent&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;LEARNING_OBJECT_ERROR_PARENT_CANNOT_BE_SELF&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">errors</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="n">errors</span><span class="p">)</span></div>


<div class="viewcode-block" id="LearningObject.save">
<a class="viewcode-back" href="../../exercise.html#exercise.exercise_models.LearningObject.save">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="c1"># Trigger LearningObject post save signal for extending classes.</span>
        <span class="bp">cls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span>
        <span class="k">while</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__bases__</span><span class="p">:</span>
            <span class="bp">cls</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__bases__</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;LearningObject&#39;</span><span class="p">:</span>
                <span class="n">signals</span><span class="o">.</span><span class="n">post_save</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">sender</span><span class="o">=</span><span class="bp">cls</span><span class="p">,</span> <span class="n">instance</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span></div>


<div class="viewcode-block" id="LearningObject.delete">
<a class="viewcode-back" href="../../exercise.html#exercise.exercise_models.LearningObject.delete">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="c1"># Trigger LearningObject post delete signal for extending classes.</span>
        <span class="bp">cls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span>
        <span class="k">while</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__bases__</span><span class="p">:</span>
            <span class="bp">cls</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__bases__</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;LearningObject&#39;</span><span class="p">:</span>
                <span class="n">signals</span><span class="o">.</span><span class="n">post_delete</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">sender</span><span class="o">=</span><span class="bp">cls</span><span class="p">,</span> <span class="n">instance</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_build_full_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">force_content_numbering</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">force_module_numbering</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">content_numbering</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">course_instance</span><span class="o">.</span><span class="n">content_numbering</span>
            <span class="k">if</span> <span class="n">force_content_numbering</span> <span class="ow">is</span> <span class="kc">None</span>
            <span class="k">else</span> <span class="n">force_content_numbering</span>
        <span class="p">)</span>
        <span class="n">module_numbering</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">course_instance</span><span class="o">.</span><span class="n">module_numbering</span>
            <span class="k">if</span> <span class="n">force_module_numbering</span> <span class="ow">is</span> <span class="kc">None</span>
            <span class="k">else</span> <span class="n">force_module_numbering</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">order</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">content_numbering</span> <span class="o">==</span> <span class="n">CourseInstance</span><span class="o">.</span><span class="n">CONTENT_NUMBERING</span><span class="o">.</span><span class="n">ARABIC</span><span class="p">:</span>
                <span class="n">number</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">number</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">module_numbering</span> <span class="ow">in</span> <span class="p">(</span>
                        <span class="n">CourseInstance</span><span class="o">.</span><span class="n">CONTENT_NUMBERING</span><span class="o">.</span><span class="n">ARABIC</span><span class="p">,</span>
                        <span class="n">CourseInstance</span><span class="o">.</span><span class="n">CONTENT_NUMBERING</span><span class="o">.</span><span class="n">HIDDEN</span><span class="p">,</span>
                    <span class="p">):</span>
                    <span class="k">return</span> <span class="s2">&quot;</span><span class="si">{:d}</span><span class="s2">.</span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">course_module</span><span class="o">.</span><span class="n">order</span><span class="p">,</span> <span class="n">number</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="k">return</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">number</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">content_numbering</span> <span class="o">==</span> <span class="n">CourseInstance</span><span class="o">.</span><span class="n">CONTENT_NUMBERING</span><span class="o">.</span><span class="n">ROMAN</span><span class="p">:</span>
                <span class="k">return</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">roman_numeral</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">order</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_full_name</span><span class="p">()</span>

<div class="viewcode-block" id="LearningObject.hierarchical_name">
<a class="viewcode-back" href="../../exercise.html#exercise.exercise_models.LearningObject.hierarchical_name">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">hierarchical_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_full_name</span><span class="p">(</span>
            <span class="n">CourseInstance</span><span class="o">.</span><span class="n">CONTENT_NUMBERING</span><span class="o">.</span><span class="n">ARABIC</span><span class="p">,</span>
            <span class="n">CourseInstance</span><span class="o">.</span><span class="n">CONTENT_NUMBERING</span><span class="o">.</span><span class="n">ARABIC</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="LearningObject.number">
<a class="viewcode-back" href="../../exercise.html#exercise.exercise_models.LearningObject.number">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">number</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;.&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">order</span><span class="p">)</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_list</span><span class="p">()])</span></div>


<div class="viewcode-block" id="LearningObject.parent_list">
<a class="viewcode-back" href="../../exercise.html#exercise.exercise_models.LearningObject.parent_list">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">parent_list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_parents&#39;</span><span class="p">):</span>
            <span class="k">def</span><span class="w"> </span><span class="nf">recursion</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">parents</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">recursion</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="p">[</span><span class="n">obj</span><span class="p">]</span> <span class="o">+</span> <span class="n">parents</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">parents</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_parents</span> <span class="o">=</span> <span class="n">recursion</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="p">])</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parents</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">course_instance</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CourseInstance</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">course_module</span><span class="o">.</span><span class="n">course_instance</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">is_submittable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span>

<div class="viewcode-block" id="LearningObject.can_be_shown_as_module_model_solution">
<a class="viewcode-back" href="../../exercise.html#exercise.exercise_models.LearningObject.can_be_shown_as_module_model_solution">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">can_be_shown_as_module_model_solution</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">:</span> <span class="n">User</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        If this exercise&#39;s parent chapter is a model solution to modules, check if the chapter</span>
<span class="sd">        can be revealed to the user according to the module&#39;s reveal rule.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">can_be_shown_as_module_model_solution</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span></div>



<div class="viewcode-block" id="LearningObject.is_empty">
<a class="viewcode-back" href="../../exercise.html#exercise.exercise_models.LearningObject.is_empty">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">is_empty</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">service_url</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">as_leaf_class</span><span class="p">()</span><span class="o">.</span><span class="n">_is_empty</span><span class="p">()</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_is_empty</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">True</span>

<div class="viewcode-block" id="LearningObject.is_open">
<a class="viewcode-back" href="../../exercise.html#exercise.exercise_models.LearningObject.is_open">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">is_open</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">when</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">course_module</span><span class="o">.</span><span class="n">exercises_open</span><span class="p">(</span><span class="n">when</span><span class="o">=</span><span class="n">when</span><span class="p">)</span></div>


<div class="viewcode-block" id="LearningObject.is_closed">
<a class="viewcode-back" href="../../exercise.html#exercise.exercise_models.LearningObject.is_closed">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">is_closed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">when</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">course_module</span><span class="o">.</span><span class="n">is_closed</span><span class="p">(</span><span class="n">when</span><span class="o">=</span><span class="n">when</span><span class="p">)</span></div>


<div class="viewcode-block" id="LearningObject.get_display_url">
<a class="viewcode-back" href="../../exercise.html#exercise.exercise_models.LearningObject.get_display_url">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_display_url</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">STATUS</span><span class="o">.</span><span class="n">UNLISTED</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">#chapter-exercise-</span><span class="si">{:d}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">get_absolute_url</span><span class="p">(),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">order</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_absolute_url</span><span class="p">()</span></div>


<div class="viewcode-block" id="LearningObject.get_submission_list_url">
<a class="viewcode-back" href="../../exercise.html#exercise.exercise_models.LearningObject.get_submission_list_url">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_submission_list_url</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_url</span><span class="p">(</span><span class="s2">&quot;submission-list&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="LearningObject.load">
<a class="viewcode-back" href="../../exercise.html#exercise.exercise_models.LearningObject.load">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">load</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">request</span><span class="p">:</span> <span class="n">HttpRequest</span><span class="p">,</span>
            <span class="n">students</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">UserProfile</span><span class="p">],</span>
            <span class="n">url_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;exercise&quot;</span><span class="p">,</span>
            <span class="n">ordinal</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ExercisePage</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Loads the learning object page.</span>

<span class="sd">        Provide the `ordinal` parameter ONLY when viewing previous submissions.</span>
<span class="sd">        In randomized exercises, it causes a specific submission&#39;s form to be</span>
<span class="sd">        returned.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">page</span> <span class="o">=</span> <span class="n">ExercisePage</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">service_url</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">page</span>
        <span class="n">language</span> <span class="o">=</span> <span class="n">get_language</span><span class="p">()</span>
        <span class="n">cache</span> <span class="o">=</span> <span class="n">ExerciseCache</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">language</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">students</span><span class="p">,</span> <span class="n">url_name</span><span class="p">,</span> <span class="n">ordinal</span><span class="p">)</span>
        <span class="n">page</span><span class="o">.</span><span class="n">head</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
        <span class="n">page</span><span class="o">.</span><span class="n">content</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">content</span><span class="p">()</span>
        <span class="n">page</span><span class="o">.</span><span class="n">is_loaded</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="n">page</span></div>


<div class="viewcode-block" id="LearningObject.load_page">
<a class="viewcode-back" href="../../exercise.html#exercise.exercise_models.LearningObject.load_page">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">load_page</span><span class="p">(</span> <span class="c1"># pylint: disable=too-many-arguments</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">language</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="n">request</span><span class="p">:</span> <span class="n">HttpRequest</span><span class="p">,</span>
            <span class="n">students</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">UserProfile</span><span class="p">],</span>
            <span class="n">url_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="n">ordinal</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">last_modified</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ExercisePage</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">load_exercise_page</span><span class="p">(</span>
            <span class="n">request</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_load_url</span><span class="p">(</span><span class="n">language</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">students</span><span class="p">,</span> <span class="n">url_name</span><span class="p">,</span> <span class="n">ordinal</span><span class="p">),</span>
            <span class="n">last_modified</span><span class="p">,</span>
            <span class="bp">self</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="LearningObject.get_service_url">
<a class="viewcode-back" href="../../exercise.html#exercise.exercise_models.LearningObject.get_service_url">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_service_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">language</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">pick_localized</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">service_url</span><span class="p">,</span> <span class="n">language</span><span class="p">)</span></div>


<div class="viewcode-block" id="LearningObject.get_load_url">
<a class="viewcode-back" href="../../exercise.html#exercise.exercise_models.LearningObject.get_load_url">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_load_url</span><span class="p">(</span> <span class="c1"># pylint: disable=too-many-arguments</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">language</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="n">request</span><span class="p">:</span> <span class="n">HttpRequest</span><span class="p">,</span>
            <span class="n">students</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">UserProfile</span><span class="p">],</span> <span class="c1"># pylint: disable=unused-argument</span>
            <span class="n">url_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;exercise&quot;</span><span class="p">,</span> <span class="c1"># pylint: disable=unused-argument</span>
            <span class="n">ordinal</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="c1"># pylint: disable=unused-argument</span>
            <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">update_url_params</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_service_url</span><span class="p">(</span><span class="n">language</span><span class="p">),</span> <span class="p">{</span>
            <span class="s1">&#39;lang&#39;</span><span class="p">:</span> <span class="n">language</span><span class="p">,</span>
        <span class="p">})</span></div>


<div class="viewcode-block" id="LearningObject.get_models_by_language">
<a class="viewcode-back" href="../../exercise.html#exercise.exercise_models.LearningObject.get_models_by_language">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_models_by_language</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">language</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">entries</span> <span class="o">=</span> <span class="n">pick_localized</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_answers</span><span class="p">,</span> <span class="n">language</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[(</span><span class="n">url</span><span class="p">,</span><span class="n">url</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;?&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">url</span> <span class="ow">in</span> <span class="n">entries</span><span class="o">.</span><span class="n">split</span><span class="p">()]</span></div>


<div class="viewcode-block" id="LearningObject.get_models">
<a class="viewcode-back" href="../../exercise.html#exercise.exercise_models.LearningObject.get_models">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_models</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_models_by_language</span><span class="p">(</span><span class="n">get_language</span><span class="p">())</span></div>


<div class="viewcode-block" id="LearningObject.get_templates">
<a class="viewcode-back" href="../../exercise.html#exercise.exercise_models.LearningObject.get_templates">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_templates</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">entries</span> <span class="o">=</span> <span class="n">pick_localized</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">templates</span><span class="p">,</span> <span class="n">get_language</span><span class="p">())</span>
        <span class="k">return</span> <span class="p">[(</span><span class="n">url</span><span class="p">,</span><span class="n">url</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;?&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">url</span> <span class="ow">in</span> <span class="n">entries</span><span class="o">.</span><span class="n">split</span><span class="p">()]</span></div>


<div class="viewcode-block" id="LearningObject.get_form_spec_keys">
<a class="viewcode-back" href="../../exercise.html#exercise.exercise_models.LearningObject.get_form_spec_keys">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_form_spec_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">include_static_fields</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the keys of the form fields of this exercise.</span>
<span class="sd">        This is based on the form_spec structure of the exercise_info, which</span>
<span class="sd">        is saved in the course JSON import.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">form_spec</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exercise_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;form_spec&#39;</span><span class="p">,</span> <span class="p">[])</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exercise_info</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span>
            <span class="k">else</span> <span class="p">[]</span>
        <span class="p">)</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">form_spec</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;key&#39;</span><span class="p">)</span>
            <span class="n">typ</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">include_static_fields</span> <span class="ow">and</span> <span class="n">typ</span> <span class="o">==</span> <span class="s1">&#39;static&#39;</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">key</span><span class="p">:</span> <span class="c1"># avoid empty or missing values</span>
                <span class="n">keys</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">keys</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">module_status</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">course_module</span><span class="o">.</span><span class="n">status</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">category_status</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">category</span><span class="o">.</span><span class="n">status</span></div>



<div class="viewcode-block" id="invalidate_exercise">
<a class="viewcode-back" href="../../exercise.html#exercise.exercise_models.invalidate_exercise">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">invalidate_exercise</span><span class="p">(</span><span class="n">sender</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span> <span class="c1"># pylint: disable=unused-argument</span>
    <span class="k">for</span> <span class="n">language</span><span class="p">,</span><span class="n">_</span> <span class="ow">in</span> <span class="n">settings</span><span class="o">.</span><span class="n">LANGUAGES</span><span class="p">:</span>
        <span class="n">ExerciseCache</span><span class="o">.</span><span class="n">invalidate</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">modifiers</span><span class="o">=</span><span class="p">[</span><span class="n">language</span><span class="p">])</span></div>



<span class="c1"># Automatically invalidate cached exercise html when edited.</span>
<span class="n">post_save</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">invalidate_exercise</span><span class="p">,</span> <span class="n">sender</span><span class="o">=</span><span class="n">LearningObject</span><span class="p">)</span>
<span class="n">post_delete</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">invalidate_exercise</span><span class="p">,</span> <span class="n">sender</span><span class="o">=</span><span class="n">LearningObject</span><span class="p">)</span>


<div class="viewcode-block" id="LearningObjectDisplay">
<a class="viewcode-back" href="../../exercise.html#exercise.exercise_models.LearningObjectDisplay">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">LearningObjectDisplay</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Records views of learning objects.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">learning_object</span> <span class="o">=</span> <span class="n">DefaultForeignKey</span><span class="p">(</span><span class="n">LearningObject</span><span class="p">,</span>
        <span class="n">verbose_name</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;LABEL_LEARNING_OBJECT&#39;</span><span class="p">),</span>
        <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">CASCADE</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">profile</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">UserProfile</span><span class="p">,</span>
        <span class="n">verbose_name</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;LABEL_PROFILE&#39;</span><span class="p">),</span>
        <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">CASCADE</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">timestamp</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span>
        <span class="n">verbose_name</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;LABEL_TIMESTAMP&#39;</span><span class="p">),</span>
        <span class="n">auto_now_add</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">class</span><span class="w"> </span><span class="nc">Meta</span><span class="p">:</span>
        <span class="n">verbose_name</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;MODEL_NAME_LEARNING_OBJECT_DISPLAY&#39;</span><span class="p">)</span>
        <span class="n">verbose_name_plural</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;MODEL_NAME_LEARNING_OBJECT_DISPLAY_PLURAL&#39;</span><span class="p">)</span></div>



<div class="viewcode-block" id="CourseChapter">
<a class="viewcode-back" href="../../exercise.html#exercise.exercise_models.CourseChapter">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">CourseChapter</span><span class="p">(</span><span class="n">LearningObject</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Chapters can offer and organize learning material as one page chapters.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">generate_table_of_contents</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">(</span>
        <span class="n">verbose_name</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;LABEL_GENERATE_TOC&#39;</span><span class="p">),</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">class</span><span class="w"> </span><span class="nc">Meta</span><span class="p">:</span>
        <span class="n">verbose_name</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;MODEL_NAME_COURSE_CHAPTER&#39;</span><span class="p">)</span>
        <span class="n">verbose_name_plural</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;MODEL_NAME_COURSE_CHAPTER_PLURAL&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="CourseChapter.can_be_shown_as_module_model_solution">
<a class="viewcode-back" href="../../exercise.html#exercise.exercise_models.CourseChapter.can_be_shown_as_module_model_solution">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">can_be_shown_as_module_model_solution</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">:</span> <span class="n">User</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        If this chapter is a model solution to modules, check if the chapter</span>
<span class="sd">        can be revealed to the user according to the module&#39;s reveal rule.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">.cache.points</span><span class="w"> </span><span class="kn">import</span> <span class="n">LearningObjectPoints</span> <span class="c1"># pylint: disable=import-outside-toplevel</span>
        <span class="n">entry</span> <span class="o">=</span> <span class="n">LearningObjectPoints</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">entry</span><span class="o">.</span><span class="n">is_revealed</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_is_empty</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_table_of_contents</span></div>



<div class="viewcode-block" id="BaseExerciseManager">
<a class="viewcode-back" href="../../exercise.html#exercise.exercise_models.BaseExerciseManager">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">BaseExerciseManager</span><span class="p">(</span><span class="n">JWTAccessible</span><span class="p">[</span><span class="s2">&quot;BaseExercise&quot;</span><span class="p">],</span> <span class="n">LearningObjectManager</span><span class="p">):</span>
    <span class="k">pass</span></div>



<div class="viewcode-block" id="BaseExercise">
<a class="viewcode-back" href="../../exercise.html#exercise.exercise_models.BaseExercise">[docs]</a>
<span class="nd">@register_jwt_accessible_class</span><span class="p">(</span><span class="s2">&quot;exercise&quot;</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">BaseExercise</span><span class="p">(</span><span class="n">LearningObject</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The common parts for all exercises.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Timing enumeration is only used as a return value.</span>
    <span class="n">TIMING</span> <span class="o">=</span> <span class="n">Enum</span><span class="p">([</span>
        <span class="p">(</span><span class="s1">&#39;CLOSED_BEFORE&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;Submissions are not yet accepted&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;OPEN&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;Normal submissions are accepted&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;LATE&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;Late submissions are accepted&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;UNOFFICIAL&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;Only unofficial submissions are accepted&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;CLOSED_AFTER&#39;</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="s2">&quot;Submissions are not anymore accepted&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;ARCHIVED&#39;</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="s2">&quot;Course is archived and so are exercises&quot;</span><span class="p">),</span>
    <span class="p">])</span>

    <span class="n">SUBMIT_STATUS</span> <span class="o">=</span> <span class="n">Enum</span><span class="p">([</span>
        <span class="p">(</span><span class="s1">&#39;ALLOWED&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;CANNOT_ENROLL&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;You cannot enroll in the course.&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;NOT_ENROLLED&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;You must enroll at course home.&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;INVALID_GROUP&#39;</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;The selected group is not acceptable.&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;AMOUNT_EXCEEDED&#39;</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;You have used the allowed amount of submissions.&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;INVALID&#39;</span><span class="p">,</span> <span class="mi">999</span><span class="p">,</span> <span class="s1">&#39;You cannot submit for an unspecified reason.&#39;</span><span class="p">),</span>
    <span class="p">])</span>

    <span class="n">GRADING_MODE</span> <span class="o">=</span> <span class="n">Enum</span><span class="p">([</span>
        <span class="p">(</span><span class="s1">&#39;BEST&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;GRADING_MODE_BEST&#39;</span><span class="p">)),</span>
        <span class="p">(</span><span class="s1">&#39;LAST&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;GRADING_MODE_LAST&#39;</span><span class="p">)),</span>
    <span class="p">])</span>

    <span class="n">allow_assistant_viewing</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">(</span>
        <span class="n">verbose_name</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;LABEL_ALLOW_ASSISTANT_VIEWING&#39;</span><span class="p">),</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">allow_assistant_grading</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">(</span>
        <span class="n">verbose_name</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;LABEL_ALLOW_ASSISTANT_GRADING&#39;</span><span class="p">),</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">min_group_size</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">PositiveIntegerField</span><span class="p">(</span>
        <span class="n">verbose_name</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;LABEL_MIN_GROUP_SIZE&#39;</span><span class="p">),</span>
        <span class="n">default</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">max_group_size</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">PositiveIntegerField</span><span class="p">(</span>
        <span class="n">verbose_name</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;LABEL_MAX_GROUP_SIZE&#39;</span><span class="p">),</span>
        <span class="n">default</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">max_submissions</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">PositiveIntegerField</span><span class="p">(</span>
        <span class="n">verbose_name</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;LABEL_MAX_SUBMISSIONS&#39;</span><span class="p">),</span>
        <span class="n">default</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">max_points</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">PositiveIntegerField</span><span class="p">(</span>
        <span class="n">verbose_name</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;LABEL_MAX_POINTS&#39;</span><span class="p">),</span>
        <span class="n">default</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">points_to_pass</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">PositiveIntegerField</span><span class="p">(</span>
        <span class="n">verbose_name</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;LABEL_POINTS_TO_PASS&#39;</span><span class="p">),</span>
        <span class="n">default</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">difficulty</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span>
        <span class="n">verbose_name</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;LABEL_DIFFICULTY&#39;</span><span class="p">),</span>
        <span class="n">max_length</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span>
        <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">submission_feedback_reveal_rule</span> <span class="o">=</span> <span class="n">DefaultOneToOneField</span><span class="p">(</span><span class="n">RevealRule</span><span class="p">,</span>
        <span class="n">verbose_name</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;LABEL_SUBMISSION_FEEDBACK_REVEAL_RULE&#39;</span><span class="p">),</span>
        <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">SET_NULL</span><span class="p">,</span>
        <span class="n">related_name</span><span class="o">=</span><span class="s1">&#39;+&#39;</span><span class="p">,</span>
        <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">model_solutions_reveal_rule</span> <span class="o">=</span> <span class="n">DefaultOneToOneField</span><span class="p">(</span><span class="n">RevealRule</span><span class="p">,</span>
        <span class="n">verbose_name</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;LABEL_MODEL_SOLUTIONS_REVEAL_RULE&#39;</span><span class="p">),</span>
        <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">SET_NULL</span><span class="p">,</span>
        <span class="n">related_name</span><span class="o">=</span><span class="s1">&#39;+&#39;</span><span class="p">,</span>
        <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">grading_mode</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">IntegerField</span><span class="p">(</span>
        <span class="n">verbose_name</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;LABEL_GRADING_MODE&#39;</span><span class="p">),</span>
        <span class="n">choices</span><span class="o">=</span><span class="n">GRADING_MODE</span><span class="o">.</span><span class="n">choices</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="n">GRADING_MODE</span><span class="o">.</span><span class="n">BEST</span><span class="p">,</span>
        <span class="n">help_text</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;BASE_EXERCISE_GRADING_MODE_HELPTEXT&#39;</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="n">objects</span> <span class="o">=</span> <span class="n">BaseExerciseManager</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
        <span class="nb">id</span><span class="p">:</span> <span class="n">models</span><span class="o">.</span><span class="n">AutoField</span>
        <span class="n">deadlineruledeviation_set</span><span class="p">:</span> <span class="n">RelatedManager</span><span class="p">[</span><span class="s1">&#39;DeadlineRuleDeviation&#39;</span><span class="p">]</span>
        <span class="n">maxsubmissionsruledeviation_set</span><span class="p">:</span> <span class="n">RelatedManager</span><span class="p">[</span><span class="s1">&#39;MaxSubmissionsRuleDeviation&#39;</span><span class="p">]</span>
        <span class="n">submissions</span><span class="p">:</span> <span class="n">RelatedManager</span><span class="p">[</span><span class="s1">&#39;Submission&#39;</span><span class="p">]</span>
        <span class="n">submission_drafts</span><span class="p">:</span> <span class="n">RelatedManager</span><span class="p">[</span><span class="s1">&#39;SubmissionDraft&#39;</span><span class="p">]</span>

    <span class="k">class</span><span class="w"> </span><span class="nc">Meta</span><span class="p">:</span>
        <span class="n">verbose_name</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;MODEL_NAME_BASE_EXERCISE&#39;</span><span class="p">)</span>
        <span class="n">verbose_name_plural</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;MODEL_NAME_BASE_EXERCISE_PLURAL&#39;</span><span class="p">)</span>
        <span class="n">app_label</span> <span class="o">=</span> <span class="s1">&#39;exercise&#39;</span>

<div class="viewcode-block" id="BaseExercise.clean">
<a class="viewcode-back" href="../../exercise.html#exercise.exercise_models.BaseExercise.clean">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">clean</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Validates the model before saving (standard method used in Django admin).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">clean</span><span class="p">()</span>
        <span class="n">errors</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">points_to_pass</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_points</span><span class="p">:</span>
            <span class="n">errors</span><span class="p">[</span><span class="s1">&#39;points_to_pass&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;EXERCISE_ERROR_POINTS_TO_PASS_GREATER_MAX_POINTS&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_group_size</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_group_size</span><span class="p">:</span>
            <span class="n">errors</span><span class="p">[</span><span class="s1">&#39;min_group_size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;EXERCISE_ERROR_MIN_GROUP_SIZE_GREATER_MAX_SIZE&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">errors</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="n">errors</span><span class="p">)</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">is_submittable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">default_submission_feedback_reveal_rule</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RevealRule</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The reveal rule to be used when `submission_feedback_reveal_rule` has</span>
<span class="sd">        not been assigned a value.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">RevealRule</span><span class="p">(</span>
            <span class="n">trigger</span><span class="o">=</span><span class="n">RevealRule</span><span class="o">.</span><span class="n">TRIGGER</span><span class="o">.</span><span class="n">IMMEDIATE</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">active_submission_feedback_reveal_rule</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RevealRule</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The reveal rule that should be used for determining submission feedback</span>
<span class="sd">        visibility. Returns `submission_feedback_reveal_rule`, or</span>
<span class="sd">        `default_submission_feedback_reveal_rule` if the former has not been</span>
<span class="sd">        assigned a value.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">submission_feedback_reveal_rule</span>
            <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_submission_feedback_reveal_rule</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">default_model_solutions_reveal_rule</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RevealRule</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The reveal rule to be used when `model_solutions_reveal_rule` has</span>
<span class="sd">        not been assigned a value.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">RevealRule</span><span class="p">(</span>
            <span class="n">trigger</span><span class="o">=</span><span class="n">RevealRule</span><span class="o">.</span><span class="n">TRIGGER</span><span class="o">.</span><span class="n">DEADLINE</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">active_model_solutions_reveal_rule</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RevealRule</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The reveal rule that should be used for determining model solution</span>
<span class="sd">        visibility. Returns `model_solutions_reveal_rule`, or</span>
<span class="sd">        `default_model_solutions_reveal_rule` if the former has not been</span>
<span class="sd">        assigned a value.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model_solutions_reveal_rule</span>
            <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_model_solutions_reveal_rule</span>
        <span class="p">)</span>

<div class="viewcode-block" id="BaseExercise.get_timing">
<a class="viewcode-back" href="../../exercise.html#exercise.exercise_models.BaseExercise.get_timing">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_timing</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">students</span><span class="p">,</span> <span class="n">when</span><span class="p">):</span>
        <span class="n">module</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">course_module</span>
        <span class="c1"># Check the course instance archive time first so that submissions</span>
        <span class="c1"># are never accepted after it.</span>
        <span class="n">dl</span> <span class="o">=</span> <span class="n">module</span><span class="o">.</span><span class="n">course_instance</span><span class="o">.</span><span class="n">archive_start</span>
        <span class="k">if</span> <span class="n">module</span><span class="o">.</span><span class="n">course_instance</span><span class="o">.</span><span class="n">is_archived</span><span class="p">(</span><span class="n">when</span><span class="o">=</span><span class="n">when</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">TIMING</span><span class="o">.</span><span class="n">ARCHIVED</span><span class="p">,</span> <span class="n">dl</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">module</span><span class="o">.</span><span class="n">have_exercises_been_opened</span><span class="p">(</span><span class="n">when</span><span class="o">=</span><span class="n">when</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">TIMING</span><span class="o">.</span><span class="n">CLOSED_BEFORE</span><span class="p">,</span> <span class="n">module</span><span class="o">.</span><span class="n">opening_time</span>

        <span class="n">category</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">category</span>
        <span class="k">if</span> <span class="n">module</span><span class="o">.</span><span class="n">exercises_open</span><span class="p">(</span><span class="n">when</span><span class="o">=</span><span class="n">when</span><span class="p">)</span> <span class="ow">or</span> <span class="n">category</span><span class="o">.</span><span class="n">confirm_the_level</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">TIMING</span><span class="o">.</span><span class="n">OPEN</span><span class="p">,</span> <span class="n">module</span><span class="o">.</span><span class="n">closing_time</span>

        <span class="n">deviation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one_has_deadline_deviation</span><span class="p">(</span><span class="n">students</span><span class="p">)</span>
        <span class="n">dl</span> <span class="o">=</span> <span class="n">deviation</span><span class="o">.</span><span class="n">get_new_deadline</span><span class="p">()</span> <span class="k">if</span> <span class="n">deviation</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">dl</span> <span class="ow">and</span> <span class="n">when</span> <span class="o">&lt;=</span> <span class="n">dl</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">deviation</span><span class="o">.</span><span class="n">without_late_penalty</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">TIMING</span><span class="o">.</span><span class="n">OPEN</span><span class="p">,</span> <span class="n">dl</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">TIMING</span><span class="o">.</span><span class="n">LATE</span><span class="p">,</span> <span class="n">dl</span>

        <span class="k">if</span> <span class="n">module</span><span class="o">.</span><span class="n">is_late_submission_open</span><span class="p">(</span><span class="n">when</span><span class="o">=</span><span class="n">when</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">TIMING</span><span class="o">.</span><span class="n">LATE</span><span class="p">,</span> <span class="n">module</span><span class="o">.</span><span class="n">late_submission_deadline</span>

        <span class="n">dl</span> <span class="o">=</span> <span class="n">dl</span> <span class="ow">or</span> <span class="p">(</span><span class="n">module</span><span class="o">.</span><span class="n">late_submission_deadline</span>
            <span class="k">if</span> <span class="n">module</span><span class="o">.</span><span class="n">late_submissions_allowed</span> <span class="k">else</span> <span class="n">module</span><span class="o">.</span><span class="n">closing_time</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">category</span><span class="o">.</span><span class="n">accept_unofficial_submits</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">TIMING</span><span class="o">.</span><span class="n">UNOFFICIAL</span><span class="p">,</span> <span class="n">dl</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">TIMING</span><span class="o">.</span><span class="n">CLOSED_AFTER</span><span class="p">,</span> <span class="n">dl</span></div>


<div class="viewcode-block" id="BaseExercise.delta_in_seconds_from_closing_to_date">
<a class="viewcode-back" href="../../exercise.html#exercise.exercise_models.BaseExercise.delta_in_seconds_from_closing_to_date">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">delta_in_seconds_from_closing_to_date</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">future_date</span><span class="p">):</span>
        <span class="n">module_close</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">course_module</span><span class="o">.</span><span class="n">closing_time</span>
        <span class="c1"># module_close is in utc format 2018-04-10 23:59:00+00:00</span>
        <span class="c1"># while future_date from the teacher submitted form might</span>
        <span class="c1"># be in a different format, e.g., 2018-05-15 23:59:00+03:00</span>
        <span class="c1"># -&gt; convert future_date to same format as module_close</span>
        <span class="n">string_date</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">future_date</span><span class="p">)[:</span><span class="mi">19</span><span class="p">]</span>
        <span class="n">converted</span> <span class="o">=</span> <span class="n">timezone</span><span class="o">.</span><span class="n">make_aware</span><span class="p">(</span>
                <span class="n">parse_datetime</span><span class="p">(</span><span class="n">string_date</span><span class="p">),</span>
                <span class="n">timezone</span><span class="o">.</span><span class="n">get_current_timezone</span><span class="p">())</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="n">converted</span> <span class="o">-</span> <span class="n">module_close</span>
        <span class="k">return</span> <span class="n">delta</span><span class="o">.</span><span class="n">days</span> <span class="o">*</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">+</span> <span class="n">delta</span><span class="o">.</span><span class="n">seconds</span></div>


<div class="viewcode-block" id="BaseExercise.one_has_access">
<a class="viewcode-back" href="../../exercise.html#exercise.exercise_models.BaseExercise.one_has_access">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">one_has_access</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">students</span><span class="p">,</span> <span class="n">when</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Checks if any of the users can submit taking the granted extra time</span>
<span class="sd">        in consideration.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">alerts</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;error_messages&#39;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s1">&#39;warning_messages&#39;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s1">&#39;info_messages&#39;</span><span class="p">:</span> <span class="p">[]</span>
        <span class="p">}</span>
        <span class="n">timing</span><span class="p">,</span><span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_timing</span><span class="p">(</span><span class="n">students</span><span class="p">,</span> <span class="n">when</span> <span class="ow">or</span> <span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>

        <span class="n">formatted_time</span> <span class="o">=</span> <span class="n">date_format</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">localtime</span><span class="p">(</span><span class="n">d</span><span class="p">),</span> <span class="s2">&quot;DATETIME_FORMAT&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">timing</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">TIMING</span><span class="o">.</span><span class="n">OPEN</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="n">alerts</span>
        <span class="k">if</span> <span class="n">timing</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">TIMING</span><span class="o">.</span><span class="n">LATE</span><span class="p">:</span>
            <span class="n">alerts</span><span class="p">[</span><span class="s1">&#39;warning_messages&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">format_lazy</span><span class="p">(</span>
                    <span class="c1"># xgettext:no-python-format</span>
                    <span class="n">_</span><span class="p">(</span><span class="s1">&#39;EXERCISE_TIMING_LATE -- </span><span class="si">{date}</span><span class="s1">, </span><span class="si">{percent:d}</span><span class="s1">&#39;</span><span class="p">),</span>
                    <span class="n">date</span><span class="o">=</span><span class="n">formatted_time</span><span class="p">,</span>
                    <span class="n">percent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">course_module</span><span class="o">.</span><span class="n">get_late_submission_point_worth</span><span class="p">(),</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="n">alerts</span>
        <span class="k">if</span> <span class="n">timing</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">TIMING</span><span class="o">.</span><span class="n">UNOFFICIAL</span><span class="p">:</span>
            <span class="n">alerts</span><span class="p">[</span><span class="s1">&#39;warning_messages&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">format_lazy</span><span class="p">(</span>
                    <span class="n">_</span><span class="p">(</span><span class="s1">&#39;EXERCISE_TIMING_UNOFFICIAL -- </span><span class="si">{date}</span><span class="s1">&#39;</span><span class="p">),</span>
                    <span class="n">date</span><span class="o">=</span><span class="n">formatted_time</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="n">alerts</span>
        <span class="k">if</span> <span class="n">timing</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">TIMING</span><span class="o">.</span><span class="n">CLOSED_BEFORE</span><span class="p">:</span>
            <span class="n">alerts</span><span class="p">[</span><span class="s1">&#39;info_messages&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">format_lazy</span><span class="p">(</span>
                    <span class="n">_</span><span class="p">(</span><span class="s1">&#39;EXERCISE_TIMING_CLOSED_BEFORE -- </span><span class="si">{date}</span><span class="s1">&#39;</span><span class="p">),</span>
                    <span class="n">date</span><span class="o">=</span><span class="n">formatted_time</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="n">alerts</span>
        <span class="k">if</span> <span class="n">timing</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">TIMING</span><span class="o">.</span><span class="n">CLOSED_AFTER</span><span class="p">:</span>
            <span class="n">alerts</span><span class="p">[</span><span class="s1">&#39;info_messages&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">format_lazy</span><span class="p">(</span>
                    <span class="n">_</span><span class="p">(</span><span class="s1">&#39;EXERCISE_TIMING_CLOSED_AFTER -- </span><span class="si">{date}</span><span class="s1">&#39;</span><span class="p">),</span>
                    <span class="n">date</span><span class="o">=</span><span class="n">formatted_time</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="n">alerts</span>
        <span class="k">if</span> <span class="n">timing</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">TIMING</span><span class="o">.</span><span class="n">ARCHIVED</span><span class="p">:</span>
            <span class="n">alerts</span><span class="p">[</span><span class="s1">&#39;error_messages&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">format_lazy</span><span class="p">(</span>
                    <span class="n">_</span><span class="p">(</span><span class="s1">&#39;EXERCISE_TIMING_ARCHIVED -- </span><span class="si">{date}</span><span class="s1">&#39;</span><span class="p">),</span>
                    <span class="n">date</span><span class="o">=</span><span class="n">formatted_time</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="n">alerts</span>
        <span class="n">alerts</span><span class="p">[</span><span class="s1">&#39;error_messages&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;SOMETHING_WENT_WRONG&#39;</span><span class="p">))</span>
        <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="n">alerts</span></div>


<div class="viewcode-block" id="BaseExercise.one_has_deadline_deviation">
<a class="viewcode-back" href="../../exercise.html#exercise.exercise_models.BaseExercise.one_has_deadline_deviation">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">one_has_deadline_deviation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">students</span><span class="p">):</span>
        <span class="n">deviation</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">profile</span> <span class="ow">in</span> <span class="n">students</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">deadlineruledeviation_set</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">submitter</span><span class="o">=</span><span class="n">profile</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">deviation</span>\
                        <span class="ow">or</span> <span class="n">d</span><span class="o">.</span><span class="n">get_new_deadline</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">deviation</span><span class="o">.</span><span class="n">get_new_deadline</span><span class="p">():</span>
                    <span class="n">deviation</span> <span class="o">=</span> <span class="n">d</span>
        <span class="k">return</span> <span class="n">deviation</span></div>


<div class="viewcode-block" id="BaseExercise.number_of_submitters">
<a class="viewcode-back" href="../../exercise.html#exercise.exercise_models.BaseExercise.number_of_submitters">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">number_of_submitters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">course_instance</span><span class="o">.</span><span class="n">students</span>\
            <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">submissions__exercise</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">distinct</span><span class="p">()</span><span class="o">.</span><span class="n">count</span><span class="p">()</span></div>


<div class="viewcode-block" id="BaseExercise.get_submissions_for_student">
<a class="viewcode-back" href="../../exercise.html#exercise.exercise_models.BaseExercise.get_submissions_for_student">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_submissions_for_student</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_profile</span><span class="p">,</span> <span class="n">exclude_errors</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">exclude_unofficial</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">submissions</span> <span class="o">=</span> <span class="n">user_profile</span><span class="o">.</span><span class="n">submissions</span>
        <span class="k">if</span> <span class="n">exclude_errors</span><span class="p">:</span>
            <span class="n">submissions</span> <span class="o">=</span> <span class="n">submissions</span><span class="o">.</span><span class="n">exclude_errors</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">exclude_unofficial</span><span class="p">:</span>
            <span class="n">submissions</span> <span class="o">=</span> <span class="n">submissions</span><span class="o">.</span><span class="n">exclude_unofficial</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">submissions</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">exercise</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span></div>


<div class="viewcode-block" id="BaseExercise.max_submissions_for_student">
<a class="viewcode-back" href="../../exercise.html#exercise.exercise_models.BaseExercise.max_submissions_for_student">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">max_submissions_for_student</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_profile</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates student specific max_submissions considering the possible</span>
<span class="sd">        MaxSubmissionsRuleDeviation for this student.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">deviation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxsubmissionsruledeviation_set</span> \
            <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">submitter</span><span class="o">=</span><span class="n">user_profile</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">deviation</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_submissions</span> <span class="o">+</span> <span class="n">deviation</span><span class="o">.</span><span class="n">extra_submissions</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_submissions</span></div>


<div class="viewcode-block" id="BaseExercise.one_has_submissions">
<a class="viewcode-back" href="../../exercise.html#exercise.exercise_models.BaseExercise.one_has_submissions">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">one_has_submissions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">students</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">UserProfile</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
        <span class="n">alerts</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;error_messages&#39;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s1">&#39;warning_messages&#39;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s1">&#39;info_messages&#39;</span><span class="p">:</span> <span class="p">[]</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">students</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">STATUS</span><span class="o">.</span><span class="n">ENROLLMENT</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">STATUS</span><span class="o">.</span><span class="n">ENROLLMENT_EXTERNAL</span><span class="p">):</span>
            <span class="n">enrollment</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">course_instance</span><span class="o">.</span><span class="n">get_enrollment_for</span><span class="p">(</span><span class="n">students</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">enrollment</span> <span class="ow">or</span> <span class="n">enrollment</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="n">Enrollment</span><span class="o">.</span><span class="n">ENROLLMENT_STATUS</span><span class="o">.</span><span class="n">ACTIVE</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="n">alerts</span>
        <span class="n">submission_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">profile</span> <span class="ow">in</span> <span class="n">students</span><span class="p">:</span>
            <span class="c1"># The students are in the same group, therefore, each student should</span>
            <span class="c1"># have the same submission count. However, max submission deviation</span>
            <span class="c1"># may be set for only one group member.</span>
            <span class="n">submission_count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_submissions_for_student</span><span class="p">(</span><span class="n">profile</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">submission_count</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_submissions_for_student</span><span class="p">(</span><span class="n">profile</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="n">alerts</span>
        <span class="c1"># Even in situations where the student could otherwise make an infinite</span>
        <span class="c1"># number of submissions, there is still a hard limit.</span>
        <span class="n">max_unofficial_submissions</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">MAX_UNOFFICIAL_SUBMISSIONS</span>
        <span class="k">if</span> <span class="n">max_unofficial_submissions</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">submission_count</span> <span class="o">&lt;</span> <span class="n">max_unofficial_submissions</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_submissions</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># If max_submissions is 0, the submission limit is &quot;infinite&quot;.</span>
                <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="n">alerts</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">category</span><span class="o">.</span><span class="n">accept_unofficial_submits</span><span class="p">:</span>
                <span class="c1"># Note: time is not checked here, but unofficial submissions are</span>
                <span class="c1"># not allowed if the course archive time has passed.</span>
                <span class="c1"># The caller must check the time limits too.</span>
                <span class="n">alerts</span><span class="p">[</span><span class="s1">&#39;warning_messages&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;EXERCISE_MAX_SUBMISSIONS_USED_UNOFFICIAL_ALLOWED&#39;</span><span class="p">))</span>
                <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="n">alerts</span>
        <span class="n">alerts</span><span class="p">[</span><span class="s1">&#39;error_messages&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;EXERCISE_MAX_SUBMISSIONS_USED&#39;</span><span class="p">))</span>
        <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="n">alerts</span></div>


<div class="viewcode-block" id="BaseExercise.no_submissions_left">
<a class="viewcode-back" href="../../exercise.html#exercise.exercise_models.BaseExercise.no_submissions_left">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">no_submissions_left</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">students</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">students</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">STATUS</span><span class="o">.</span><span class="n">ENROLLMENT</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">STATUS</span><span class="o">.</span><span class="n">ENROLLMENT_EXTERNAL</span><span class="p">):</span>
            <span class="n">enrollment</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">course_instance</span><span class="o">.</span><span class="n">get_enrollment_for</span><span class="p">(</span><span class="n">students</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">enrollment</span> <span class="ow">or</span> <span class="n">enrollment</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="n">Enrollment</span><span class="o">.</span><span class="n">ENROLLMENT_STATUS</span><span class="o">.</span><span class="n">ACTIVE</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_submissions</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">profile</span> <span class="ow">in</span> <span class="n">students</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_submissions_for_student</span><span class="p">(</span><span class="n">profile</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> \
                    <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_submissions_for_student</span><span class="p">(</span><span class="n">profile</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="BaseExercise.check_submission_allowed">
<a class="viewcode-back" href="../../exercise.html#exercise.exercise_models.BaseExercise.check_submission_allowed">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">check_submission_allowed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">profile</span><span class="p">,</span> <span class="n">request</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Checks whether the submission to this exercise is allowed for the given</span>
<span class="sd">        user and generates a list of alerts.</span>

<span class="sd">        @return: (success_flag, warning_message_list)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">success</span><span class="p">,</span> <span class="n">alerts</span><span class="p">,</span> <span class="n">students</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_submission_allowed</span><span class="p">(</span><span class="n">profile</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">alerts</span><span class="p">:</span>
            <span class="n">alerts</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="k">for</span> <span class="n">msg</span> <span class="ow">in</span> <span class="n">alerts</span><span class="p">[</span><span class="n">key</span><span class="p">]]</span>
        <span class="k">return</span> <span class="n">success</span><span class="p">,</span> <span class="n">alerts</span><span class="p">,</span> <span class="n">students</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_check_submission_allowed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">profile</span><span class="p">,</span> <span class="n">request</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span> <span class="c1"># pylint: disable=too-many-locals # noqa: MC0001</span>
        <span class="n">students</span> <span class="o">=</span> <span class="p">[</span><span class="n">profile</span><span class="p">]</span>
        <span class="n">alerts</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;error_messages&#39;</span> <span class="p">:</span> <span class="p">[],</span>
            <span class="s1">&#39;warning_messages&#39;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s1">&#39;info_messages&#39;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="p">}</span>

        <span class="c1"># Let course module settings decide submissionable state.</span>
        <span class="c1">#if self.course_instance.ending_time &lt; timezone.now():</span>
        <span class="c1">#    alerts[&#39;warning_messages&#39;].append(_(&#39;The course is archived. Exercises are offline.&#39;))</span>
        <span class="c1">#    return False, alerts, students</span>

        <span class="c1"># Check enrollment requirements.</span>
        <span class="n">enrollment</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">course_instance</span><span class="o">.</span><span class="n">get_enrollment_for</span><span class="p">(</span><span class="n">profile</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="ow">in</span> <span class="p">(</span>
            <span class="n">LearningObject</span><span class="o">.</span><span class="n">STATUS</span><span class="o">.</span><span class="n">ENROLLMENT</span><span class="p">,</span>
            <span class="n">LearningObject</span><span class="o">.</span><span class="n">STATUS</span><span class="o">.</span><span class="n">ENROLLMENT_EXTERNAL</span><span class="p">,</span>
        <span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">course_instance</span><span class="o">.</span><span class="n">is_enrollment_open</span><span class="p">():</span>
                <span class="n">alerts</span><span class="p">[</span><span class="s1">&#39;error_messages&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;ENROLLMENT_ERROR_ENROLLMENT_NOT_OPEN&#39;</span><span class="p">))</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">SUBMIT_STATUS</span><span class="o">.</span><span class="n">CANNOT_ENROLL</span><span class="p">,</span> <span class="n">alerts</span><span class="p">,</span> <span class="n">students</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">course_instance</span><span class="o">.</span><span class="n">is_enrollable</span><span class="p">(</span><span class="n">profile</span><span class="o">.</span><span class="n">user</span><span class="p">):</span>
                <span class="n">alerts</span><span class="p">[</span><span class="s1">&#39;error_messages&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;CANNOT_ENROLL_IN_COURSE_ERROR&#39;</span><span class="p">))</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">SUBMIT_STATUS</span><span class="o">.</span><span class="n">CANNOT_ENROLL</span><span class="p">,</span> <span class="n">alerts</span><span class="p">,</span> <span class="n">students</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">enrollment</span> <span class="ow">or</span> <span class="n">enrollment</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="n">Enrollment</span><span class="o">.</span><span class="n">ENROLLMENT_STATUS</span><span class="o">.</span><span class="n">ACTIVE</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">course_instance</span><span class="o">.</span><span class="n">is_course_staff</span><span class="p">(</span><span class="n">profile</span><span class="o">.</span><span class="n">user</span><span class="p">):</span>
                <span class="n">alerts</span><span class="p">[</span><span class="s1">&#39;info_messages&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;STAFF_CAN_SUBMIT_WITHOUT_ENROLLING&#39;</span><span class="p">))</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">SUBMIT_STATUS</span><span class="o">.</span><span class="n">ALLOWED</span><span class="p">,</span> <span class="n">alerts</span><span class="p">,</span> <span class="n">students</span>
            <span class="n">alerts</span><span class="p">[</span><span class="s1">&#39;error_messages&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;MUST_ENROLL_TO_SUBMIT_EXERCISES_ERROR&#39;</span><span class="p">))</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">SUBMIT_STATUS</span><span class="o">.</span><span class="n">NOT_ENROLLED</span><span class="p">,</span> <span class="n">alerts</span><span class="p">,</span> <span class="n">students</span>

        <span class="c1"># Support group id from post or currently selected group.</span>
        <span class="n">group</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">group_id</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">request</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">group_id</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;__aplus__&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;group&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span><span class="p">:</span>
                <span class="n">alerts</span><span class="p">[</span><span class="s1">&#39;error_messages&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;EXERCISE_ERROR_CANNOT_SUBMIT_INVALID_JSON_IN_POST&#39;</span><span class="p">))</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">SUBMIT_STATUS</span><span class="o">.</span><span class="n">INVALID</span><span class="p">,</span> <span class="n">alerts</span><span class="p">,</span> <span class="n">students</span>
            <span class="k">if</span> <span class="n">group_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">group_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;_aplus_group&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">group_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">gid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">group_id</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">gid</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">group</span> <span class="o">=</span> <span class="n">profile</span><span class="o">.</span><span class="n">groups</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                        <span class="n">course_instance</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">course_instance</span><span class="p">,</span>
                        <span class="nb">id</span><span class="o">=</span><span class="n">gid</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">group</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">alerts</span><span class="p">[</span><span class="s1">&#39;error_messages&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;EXERCISE_ERROR_NO_GROUP_WITH_ID&#39;</span><span class="p">))</span>
                        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">SUBMIT_STATUS</span><span class="o">.</span><span class="n">INVALID_GROUP</span><span class="p">,</span> <span class="n">alerts</span><span class="p">,</span> <span class="n">students</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">elif</span> <span class="n">enrollment</span> <span class="ow">and</span> <span class="n">enrollment</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">Enrollment</span><span class="o">.</span><span class="n">ENROLLMENT_STATUS</span><span class="o">.</span><span class="n">ACTIVE</span> <span class="ow">and</span> <span class="n">enrollment</span><span class="o">.</span><span class="n">selected_group</span><span class="p">:</span>
            <span class="n">group</span> <span class="o">=</span> <span class="n">enrollment</span><span class="o">.</span><span class="n">selected_group</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_group_size</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># Check groups cannot be changed after submitting.</span>
            <span class="n">submission</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_submissions_for_student</span><span class="p">(</span><span class="n">profile</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">submission</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_detect_group_changes</span><span class="p">(</span><span class="n">profile</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="n">submission</span><span class="p">):</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;EXERCISE_ERROR_GROUP_CANNOT_CHANGE_FOR_SAME_EXERCISE_MSG&#39;</span><span class="p">)</span>
                    <span class="n">error_msg</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;EXERCISE_ERROR_HAS_PREVIOUSLY_SUBMITTED_EXERCISE -- </span><span class="si">{with_group}</span><span class="s1">, </span><span class="si">{msg}</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">submission</span><span class="o">.</span><span class="n">submitters</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">error_msg</span> <span class="o">=</span> <span class="n">format_lazy</span><span class="p">(</span><span class="n">error_msg</span><span class="p">,</span> <span class="n">with_group</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;ALONE&#39;</span><span class="p">),</span> <span class="n">msg</span><span class="o">=</span><span class="n">msg</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">collaborators</span> <span class="o">=</span> <span class="n">StudentGroup</span><span class="o">.</span><span class="n">format_collaborator_names</span><span class="p">(</span>
                                <span class="n">submission</span><span class="o">.</span><span class="n">submitters</span><span class="o">.</span><span class="n">all</span><span class="p">(),</span> <span class="n">profile</span><span class="p">)</span>
                        <span class="n">with_group</span> <span class="o">=</span> <span class="n">format_lazy</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;WITH -- </span><span class="si">{}</span><span class="s1">&#39;</span><span class="p">),</span> <span class="n">collaborators</span><span class="p">)</span>
                        <span class="n">error_msg</span> <span class="o">=</span> <span class="n">format_lazy</span><span class="p">(</span><span class="n">error_msg</span><span class="p">,</span> <span class="n">with_group</span><span class="o">=</span><span class="n">with_group</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="n">msg</span><span class="p">)</span>
                    <span class="n">alerts</span><span class="p">[</span><span class="s1">&#39;error_messages&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">SUBMIT_STATUS</span><span class="o">.</span><span class="n">INVALID_GROUP</span><span class="p">,</span> <span class="n">alerts</span><span class="p">,</span> <span class="n">students</span>

            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_detect_submissions</span><span class="p">(</span><span class="n">profile</span><span class="p">,</span> <span class="n">group</span><span class="p">):</span>
                <span class="n">alerts</span><span class="p">[</span><span class="s1">&#39;error_messages&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">format_lazy</span><span class="p">(</span>
                        <span class="n">_</span><span class="p">(</span><span class="s1">&#39;EXERCISE_ERROR_COLLABS_HAVE_SUBMITTED_EXERCISE_WITH_DIFF_GROUP -- </span><span class="si">{collaborators}</span><span class="s1">&#39;</span><span class="p">),</span>
                        <span class="n">collaborators</span><span class="o">=</span><span class="n">group</span><span class="o">.</span><span class="n">collaborator_names</span><span class="p">(</span><span class="n">profile</span><span class="p">),</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">SUBMIT_STATUS</span><span class="o">.</span><span class="n">INVALID_GROUP</span><span class="p">,</span> <span class="n">alerts</span><span class="p">,</span> <span class="n">students</span>

        <span class="c1"># Get submitters.</span>
        <span class="k">if</span> <span class="n">group</span><span class="p">:</span>
            <span class="n">students</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">group</span><span class="o">.</span><span class="n">members</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>

        <span class="c1"># Check group size.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">min_group_size</span> <span class="o">&lt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">students</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_group_size</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_group_size</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_group_size</span><span class="p">:</span>
                <span class="n">size</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{:d}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">min_group_size</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">size</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{:d}</span><span class="s2">-</span><span class="si">{:d}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">min_group_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_group_size</span><span class="p">)</span>
            <span class="n">alerts</span><span class="p">[</span><span class="s1">&#39;error_messages&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">format_lazy</span><span class="p">(</span>
                    <span class="n">_</span><span class="p">(</span><span class="s1">&#39;EXERCISE_ERROR_REQUIRES_GROUP_SIZE -- </span><span class="si">{size}</span><span class="s1">&#39;</span><span class="p">),</span>
                    <span class="n">size</span><span class="o">=</span><span class="n">size</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">STATUS</span><span class="o">.</span><span class="n">ENROLLMENT</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">STATUS</span><span class="o">.</span><span class="n">ENROLLMENT_EXTERNAL</span><span class="p">):</span>
            <span class="n">access_ok</span><span class="p">,</span> <span class="n">access_alerts</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;error_messages&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;warning_messages&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;info_messages&#39;</span><span class="p">:</span> <span class="p">[]}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">access_ok</span><span class="p">,</span> <span class="n">access_alerts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one_has_access</span><span class="p">(</span><span class="n">students</span><span class="p">)</span>
        <span class="n">is_staff</span> <span class="o">=</span> <span class="nb">all</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">course_instance</span><span class="o">.</span><span class="n">is_course_staff</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">user</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">students</span><span class="p">)</span>
        <span class="c1"># pylint: disable-next=consider-using-ternary</span>
        <span class="n">ok</span> <span class="o">=</span> <span class="p">(</span><span class="n">access_ok</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">alerts</span><span class="p">[</span><span class="s1">&#39;error_messages&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">alerts</span><span class="p">[</span><span class="s1">&#39;warning_messages&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="n">is_staff</span>
        <span class="c1"># Combine alerts dict with access_alerts dict</span>
        <span class="n">all_alerts</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">key</span><span class="p">:</span> <span class="n">alerts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="p">[])</span> <span class="o">+</span> <span class="n">access_alerts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="p">[])</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">alerts</span><span class="p">)</span> <span class="o">|</span> <span class="nb">set</span><span class="p">(</span><span class="n">access_alerts</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ok</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_alerts</span><span class="p">[</span><span class="s1">&#39;error_messages&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">all_alerts</span><span class="p">[</span><span class="s1">&#39;warning_messages&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">all_alerts</span><span class="p">[</span><span class="s1">&#39;info_messages&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">all_alerts</span><span class="p">[</span><span class="s1">&#39;error_messages&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;EXERCISE_ERROR_CANNOT_SUBMIT_UNKNOWN_REASON&#39;</span><span class="p">))</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">SUBMIT_STATUS</span><span class="o">.</span><span class="n">INVALID</span><span class="p">,</span> <span class="n">all_alerts</span><span class="p">,</span> <span class="n">students</span>

        <span class="n">submit_limit_ok</span><span class="p">,</span> <span class="n">submit_limit_alerts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one_has_submissions</span><span class="p">(</span><span class="n">students</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">submit_limit_ok</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_staff</span><span class="p">:</span>
            <span class="c1"># access_alerts are not needed here</span>
            <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SUBMIT_STATUS</span><span class="o">.</span><span class="n">AMOUNT_EXCEEDED</span><span class="p">,</span>
                    <span class="n">submit_limit_alerts</span><span class="p">,</span>
                    <span class="n">students</span><span class="p">)</span>

        <span class="c1"># Combine all_alerts dict with submit_limit_alerts dict</span>
        <span class="n">all_alerts</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">key</span><span class="p">:</span> <span class="n">all_alerts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="p">[])</span> <span class="o">+</span> <span class="n">submit_limit_alerts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="p">[])</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">all_alerts</span><span class="p">)</span> <span class="o">|</span> <span class="nb">set</span><span class="p">(</span><span class="n">submit_limit_alerts</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">SUBMIT_STATUS</span><span class="o">.</span><span class="n">ALLOWED</span><span class="p">,</span> <span class="n">all_alerts</span><span class="p">,</span> <span class="n">students</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_detect_group_changes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">profile</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="n">submission</span><span class="p">):</span>
        <span class="n">submitters</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">submission</span><span class="o">.</span><span class="n">submitters</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">group</span><span class="p">:</span>
            <span class="k">return</span> <span class="ow">not</span> <span class="n">group</span><span class="o">.</span><span class="n">equals</span><span class="p">(</span><span class="n">submitters</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">submitters</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">submitters</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">profile</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_detect_submissions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">profile</span><span class="p">,</span> <span class="n">group</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">group</span><span class="p">:</span>
            <span class="k">return</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">((</span>
                <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_submissions_for_student</span><span class="p">(</span><span class="n">p</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">group</span><span class="o">.</span><span class="n">members</span><span class="o">.</span><span class="n">all</span><span class="p">()</span> <span class="k">if</span> <span class="n">p</span> <span class="o">!=</span> <span class="n">profile</span>
            <span class="p">))</span>
        <span class="k">return</span> <span class="kc">False</span>

<div class="viewcode-block" id="BaseExercise.get_total_submitter_count">
<a class="viewcode-back" href="../../exercise.html#exercise.exercise_models.BaseExercise.get_total_submitter_count">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_total_submitter_count</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">UserProfile</span><span class="o">.</span><span class="n">objects</span> \
            <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">submissions__exercise</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span> \
            <span class="o">.</span><span class="n">distinct</span><span class="p">()</span><span class="o">.</span><span class="n">count</span><span class="p">()</span></div>


<div class="viewcode-block" id="BaseExercise.get_load_url">
<a class="viewcode-back" href="../../exercise.html#exercise.exercise_models.BaseExercise.get_load_url">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_load_url</span><span class="p">(</span> <span class="c1"># pylint: disable=too-many-arguments</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">language</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="n">request</span><span class="p">:</span> <span class="n">HttpRequest</span><span class="p">,</span>
            <span class="n">students</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">UserProfile</span><span class="p">],</span>
            <span class="n">url_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;exercise&quot;</span><span class="p">,</span>
            <span class="n">ordinal</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_authenticated</span><span class="p">:</span>
                <span class="n">user</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span>
                <span class="k">if</span> <span class="n">ordinal</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">submission_count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_submissions_for_student</span><span class="p">(</span>
                        <span class="n">user</span><span class="o">.</span><span class="n">userprofile</span><span class="p">,</span> <span class="n">exclude_errors</span><span class="o">=</span><span class="kc">True</span>
                    <span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
                    <span class="n">ordinal</span> <span class="o">=</span> <span class="n">submission_count</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">user</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">ordinal</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="c1"># Make grader async URL for the currently authenticated user.</span>
            <span class="c1"># The async handler will handle group selection at submission time.</span>
            <span class="n">submission_url</span> <span class="o">=</span> <span class="n">update_url_params</span><span class="p">(</span>
                <span class="n">api_reverse</span><span class="p">(</span><span class="s2">&quot;exercise-grader&quot;</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span>
                    <span class="s1">&#39;exercise_id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span>
                <span class="p">}),</span>
                <span class="n">get_graderauth_exercise_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_service_url</span><span class="p">(</span>
                <span class="n">language</span><span class="p">,</span> <span class="n">students</span><span class="p">,</span>
                <span class="n">ordinal</span><span class="p">,</span> <span class="n">url_name</span><span class="p">,</span> <span class="n">submission_url</span><span class="p">,</span> <span class="n">lti_launch_id</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;lti-launch-id&quot;</span><span class="p">),</span>
                <span class="n">lti_session_id</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">COOKIES</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;lti1p3-session-id&quot;</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_load_url</span><span class="p">(</span><span class="n">language</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">students</span><span class="p">,</span> <span class="n">url_name</span><span class="p">,</span> <span class="n">ordinal</span><span class="p">)</span></div>


<div class="viewcode-block" id="BaseExercise.grade">
<a class="viewcode-back" href="../../exercise.html#exercise.exercise_models.BaseExercise.grade">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">grade</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">submission</span><span class="p">,</span> <span class="n">request</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">no_penalties</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">url_name</span><span class="o">=</span><span class="s2">&quot;exercise&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Loads the exercise feedback page.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get the language from the submission</span>
        <span class="n">language</span> <span class="o">=</span> <span class="n">submission</span><span class="o">.</span><span class="n">lang</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">course_module</span><span class="o">.</span><span class="n">course_instance</span><span class="o">.</span><span class="n">default_language</span>

        <span class="n">submission_url</span> <span class="o">=</span> <span class="n">update_url_params</span><span class="p">(</span>
            <span class="n">api_reverse</span><span class="p">(</span><span class="s2">&quot;submission-grader&quot;</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;submission_id&#39;</span><span class="p">:</span> <span class="n">submission</span><span class="o">.</span><span class="n">id</span>
            <span class="p">}),</span>
            <span class="n">get_graderauth_submission_params</span><span class="p">(</span><span class="n">submission</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="n">url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_service_url</span><span class="p">(</span>
            <span class="n">language</span><span class="p">,</span> <span class="n">submission</span><span class="o">.</span><span class="n">submitters</span><span class="o">.</span><span class="n">all</span><span class="p">(),</span>
            <span class="n">submission</span><span class="o">.</span><span class="n">ordinal_number</span><span class="p">(),</span> <span class="n">url_name</span><span class="p">,</span> <span class="n">submission_url</span>
        <span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">load_feedback_page</span><span class="p">(</span>
                <span class="n">request</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">submission</span><span class="p">,</span> <span class="n">no_penalties</span><span class="o">=</span><span class="n">no_penalties</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
            <span class="n">page</span> <span class="o">=</span> <span class="n">ExercisePage</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Unable to grade the submission. </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">error</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span>
            <span class="n">page</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">page</span></div>


<div class="viewcode-block" id="BaseExercise.modify_post_parameters">
<a class="viewcode-back" href="../../exercise.html#exercise.exercise_models.BaseExercise.modify_post_parameters">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">modify_post_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">files</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">students</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">url</span><span class="p">):</span> <span class="c1"># pylint: disable=too-many-arguments</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Allows to modify submission POST parameters before they are sent to</span>
<span class="sd">        the grader. Extending classes may implement this function.</span>
<span class="sd">        &quot;&quot;&quot;</span></div>


    <span class="c1"># pylint: disable-next=too-many-arguments</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_build_service_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">language</span><span class="p">,</span> <span class="n">students</span><span class="p">,</span> <span class="n">ordinal_number</span><span class="p">,</span> <span class="n">url_name</span><span class="p">,</span> <span class="n">submission_url</span><span class="p">,</span>
                           <span class="n">lti_launch_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lti_session_id</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generates complete URL with added parameters to the exercise service.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">uid_str</span> <span class="o">=</span> <span class="s1">&#39;-&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">profile</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span> <span class="k">for</span> <span class="n">profile</span> <span class="ow">in</span> <span class="n">students</span><span class="p">))</span> <span class="k">if</span> <span class="n">students</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;max_points&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_points</span><span class="p">,</span>
            <span class="s2">&quot;max_submissions&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_submissions</span><span class="p">,</span>
            <span class="s2">&quot;submission_url&quot;</span><span class="p">:</span> <span class="n">build_aplus_url</span><span class="p">(</span><span class="n">submission_url</span><span class="p">),</span>
            <span class="s2">&quot;post_url&quot;</span><span class="p">:</span> <span class="n">build_aplus_url</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_url</span><span class="p">(</span><span class="n">url_name</span><span class="p">)),</span> <span class="n">user_url</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
            <span class="s2">&quot;uid&quot;</span><span class="p">:</span> <span class="n">uid_str</span><span class="p">,</span>
            <span class="s2">&quot;ordinal_number&quot;</span><span class="p">:</span> <span class="n">ordinal_number</span><span class="p">,</span>
            <span class="s2">&quot;lang&quot;</span><span class="p">:</span> <span class="n">language</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="n">lti_launch_id</span><span class="p">:</span>
            <span class="n">params</span><span class="p">[</span><span class="s2">&quot;lti_launch_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lti_launch_id</span>
        <span class="k">if</span> <span class="n">lti_session_id</span><span class="p">:</span>
            <span class="n">params</span><span class="p">[</span><span class="s2">&quot;lti_session_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lti_session_id</span>
        <span class="k">return</span> <span class="n">update_url_params</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_service_url</span><span class="p">(</span><span class="n">language</span><span class="p">),</span> <span class="n">params</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">can_regrade</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Can this exercise be regraded in the assessment service, i.e.,</span>
<span class="sd">        can previous submissions be uploaded again for grading?&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">True</span>

<div class="viewcode-block" id="BaseExercise.can_show_model_solutions_to_student">
<a class="viewcode-back" href="../../exercise.html#exercise.exercise_models.BaseExercise.can_show_model_solutions_to_student">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">can_show_model_solutions_to_student</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">student</span><span class="p">:</span> <span class="n">User</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">course_instance</span><span class="o">.</span><span class="n">is_course_staff</span><span class="p">(</span><span class="n">student</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">course_instance</span><span class="o">.</span><span class="n">is_on_lifesupport</span><span class="p">()</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">course_instance</span><span class="o">.</span><span class="n">is_archived</span><span class="p">():</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">student</span><span class="o">.</span><span class="n">is_authenticated</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="kn">from</span><span class="w"> </span><span class="nn">.reveal_states</span><span class="w"> </span><span class="kn">import</span> <span class="n">ExerciseRevealState</span> <span class="c1"># pylint: disable=import-outside-toplevel</span>
        <span class="n">state</span> <span class="o">=</span> <span class="n">ExerciseRevealState</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">student</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">active_model_solutions_reveal_rule</span><span class="o">.</span><span class="n">is_revealed</span><span class="p">(</span><span class="n">state</span><span class="p">)</span></div>


<div class="viewcode-block" id="BaseExercise.get_submission_draft">
<a class="viewcode-back" href="../../exercise.html#exercise.exercise_models.BaseExercise.get_submission_draft">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_submission_draft</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_profile</span><span class="p">:</span> <span class="n">UserProfile</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="s1">&#39;SubmissionDraft&#39;</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the active submission draft for the user, if it exists.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">user_profile</span><span class="o">.</span><span class="n">submission_drafts</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">exercise</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
            <span class="n">active</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span></div>


<div class="viewcode-block" id="BaseExercise.set_submission_draft">
<a class="viewcode-back" href="../../exercise.html#exercise.exercise_models.BaseExercise.set_submission_draft">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_submission_draft</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_profile</span><span class="p">:</span> <span class="n">UserProfile</span><span class="p">,</span> <span class="n">submission_data</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates a submission draft for the user, or updates an existing one.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">user_profile</span><span class="o">.</span><span class="n">submission_drafts</span><span class="o">.</span><span class="n">update_or_create</span><span class="p">(</span>
            <span class="n">exercise</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
            <span class="n">defaults</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;active&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s1">&#39;submission_data&#39;</span><span class="p">:</span> <span class="n">submission_data</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="BaseExercise.unset_submission_draft">
<a class="viewcode-back" href="../../exercise.html#exercise.exercise_models.BaseExercise.unset_submission_draft">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">unset_submission_draft</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_profile</span><span class="p">:</span> <span class="n">UserProfile</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Deactivates the active submission draft for the user, if it exists.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">user_profile</span><span class="o">.</span><span class="n">submission_drafts</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">exercise</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
            <span class="n">active</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">active</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="LTIExercise">
<a class="viewcode-back" href="../../exercise.html#exercise.exercise_models.LTIExercise">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">LTIExercise</span><span class="p">(</span><span class="n">BaseExercise</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Exercise launched by LTI or optionally amending A+ protocol with LTI data.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">lti_service</span> <span class="o">=</span> <span class="n">DefaultForeignKey</span><span class="p">(</span><span class="n">LTIService</span><span class="p">,</span>
        <span class="n">verbose_name</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;LABEL_LTI_SERVICE&#39;</span><span class="p">),</span>
        <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">CASCADE</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">context_id</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span>
        <span class="n">verbose_name</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;LABEL_CONTEXT_ID&#39;</span><span class="p">),</span>
        <span class="n">max_length</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span>
        <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">help_text</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;LTI_EXERCISE_CONTEXT_ID_HELPTEXT&#39;</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="n">resource_link_id</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span>
        <span class="n">verbose_name</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;LABEL_RESOURCE_LINK_ID&#39;</span><span class="p">),</span>
        <span class="n">max_length</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span>
        <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">help_text</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;LTI_EXERCISE_RESOURCE_LINK_ID_HELPTEXT&#39;</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="n">resource_link_title</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span>
        <span class="n">verbose_name</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;LABEL_RESOURCE_LINK_TITLE&#39;</span><span class="p">),</span>
        <span class="n">max_length</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span>
        <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">help_text</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;LTI_EXERCISE_RESOURCE_LINK_TITLE_HELPTEXT&#39;</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="n">aplus_get_and_post</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">(</span>
        <span class="n">verbose_name</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;LABEL_APLUS_GET_AND_POST&#39;</span><span class="p">),</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">help_text</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;LTI_EXERCISE_APLUS_GET_AND_POST_HELPTEXT&#39;</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="n">open_in_iframe</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">(</span>
        <span class="n">verbose_name</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;LABEL_OPEN_IN_IFRAME&#39;</span><span class="p">),</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">help_text</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;LTI_EXERCISE_OPEN_IN_IFRAME_HELPTEXT&#39;</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="k">class</span><span class="w"> </span><span class="nc">Meta</span><span class="p">:</span>
        <span class="n">verbose_name</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;MODEL_NAME_LTI_EXERCISE&#39;</span><span class="p">)</span>
        <span class="n">verbose_name_plural</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;MODEL_NAME_LTI_EXERCISE_PLURAL&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="LTIExercise.clean">
<a class="viewcode-back" href="../../exercise.html#exercise.exercise_models.LTIExercise.clean">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">clean</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Validates the model before saving (standard method used in Django admin).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">clean</span><span class="p">()</span>
        <span class="c1"># If service_url is defined and is an absolute URL, it must be in the</span>
        <span class="c1"># same domain as the LTI service.</span>
        <span class="c1"># Relative URLs are joined to the URL of the LTI service.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">service_url</span><span class="p">:</span>
            <span class="n">uri</span> <span class="o">=</span> <span class="n">urlsplit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">service_url</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">uri</span><span class="o">.</span><span class="n">netloc</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">uri</span><span class="o">.</span><span class="n">netloc</span> <span class="o">!=</span> <span class="n">urlsplit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lti_service</span><span class="o">.</span><span class="n">url</span><span class="p">)</span><span class="o">.</span><span class="n">netloc</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">({</span>
                        <span class="s1">&#39;service_url&#39;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;LTI_EXERCISE_ERROR_SERVICE_URL_DOMAIN_MUST_MATCH_LTI_SERVICE&#39;</span><span class="p">),</span>
                    <span class="p">})</span>
                <span class="c1"># Save only the URL path in the database without the domain</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">service_url</span> <span class="o">=</span> <span class="n">uri</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span><span class="n">scheme</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">netloc</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">geturl</span><span class="p">()</span></div>


<div class="viewcode-block" id="LTIExercise.load">
<a class="viewcode-back" href="../../exercise.html#exercise.exercise_models.LTIExercise.load">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">load</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">request</span><span class="p">:</span> <span class="n">HttpRequest</span><span class="p">,</span>
            <span class="n">students</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">UserProfile</span><span class="p">],</span>
            <span class="n">url_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;exercise&quot;</span><span class="p">,</span>
            <span class="n">ordinal</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ExercisePage</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">lti_service</span><span class="o">.</span><span class="n">enabled</span><span class="p">:</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;LTI_EXERCISE_ERROR_EXTERNAL_LTI_SERVICE_DISABLED&#39;</span><span class="p">))</span>
            <span class="k">raise</span> <span class="n">PermissionDenied</span><span class="p">(</span><span class="s2">&quot;The LTI service is disabled.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">aplus_get_and_post</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">students</span><span class="p">,</span> <span class="n">url_name</span><span class="o">=</span><span class="n">url_name</span><span class="p">,</span> <span class="n">ordinal</span><span class="o">=</span><span class="n">ordinal</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">students</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ExercisePage</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="n">language</span> <span class="o">=</span> <span class="n">get_language</span><span class="p">()</span>
        <span class="n">url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_service_url</span><span class="p">(</span><span class="n">language</span><span class="p">)</span>
        <span class="n">lti</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_lti</span><span class="p">(</span><span class="n">students</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">user</span><span class="p">,</span> <span class="n">students</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span>

        <span class="c1"># Render launch button.</span>
        <span class="n">page</span> <span class="o">=</span> <span class="n">ExercisePage</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">page</span><span class="o">.</span><span class="n">content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">content</span>
        <span class="n">template</span> <span class="o">=</span> <span class="n">loader</span><span class="o">.</span><span class="n">get_template</span><span class="p">(</span><span class="s1">&#39;external_services/_launch.html&#39;</span><span class="p">)</span>
        <span class="n">page</span><span class="o">.</span><span class="n">content</span> <span class="o">+=</span> <span class="n">template</span><span class="o">.</span><span class="n">render</span><span class="p">({</span>
            <span class="s1">&#39;service&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">lti_service</span><span class="p">,</span>
            <span class="s1">&#39;service_label&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">lti_service</span><span class="o">.</span><span class="n">menu_label</span><span class="p">,</span>
            <span class="s1">&#39;url&#39;</span><span class="p">:</span> <span class="n">url</span><span class="p">,</span>
            <span class="s1">&#39;parameters&#39;</span><span class="p">:</span> <span class="n">lti</span><span class="o">.</span><span class="n">sign_post_parameters</span><span class="p">(</span><span class="n">url</span><span class="p">),</span>
            <span class="s1">&#39;parameters_hash&#39;</span><span class="p">:</span> <span class="n">lti</span><span class="o">.</span><span class="n">get_checksum_of_parameters</span><span class="p">(</span><span class="n">only_user_and_course_level_params</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
            <span class="s1">&#39;exercise&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="p">,</span>
            <span class="s1">&#39;is_course_staff&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">course_instance</span><span class="o">.</span><span class="n">is_course_staff</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">),</span>
            <span class="s1">&#39;site&#39;</span><span class="p">:</span> <span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">url</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[:</span><span class="mi">3</span><span class="p">]),</span>
        <span class="p">})</span>
        <span class="k">return</span> <span class="n">page</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_get_lti</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">students</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">add</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">CustomStudentInfoLTIRequest</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lti_service</span><span class="p">,</span>
                <span class="n">user</span><span class="p">,</span>
                <span class="n">students</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">course_instance</span><span class="p">,</span>
                <span class="n">request</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">resource_link_title</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">lti_service</span><span class="o">.</span><span class="n">menu_label</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">context_id</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">resource_link_id</span> <span class="ow">or</span> <span class="s2">&quot;aplusexercise</span><span class="si">{:d}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">),</span>
                <span class="n">add</span><span class="p">,</span>
                <span class="n">exercise</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="n">PermissionDenied</span><span class="p">:</span> <span class="c1"># pylint: disable=try-except-raise</span>
            <span class="k">raise</span>

<div class="viewcode-block" id="LTIExercise.get_load_url">
<a class="viewcode-back" href="../../exercise.html#exercise.exercise_models.LTIExercise.get_load_url">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_load_url</span><span class="p">(</span> <span class="c1"># pylint: disable=too-many-arguments</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">language</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="n">request</span><span class="p">:</span> <span class="n">HttpRequest</span><span class="p">,</span>
            <span class="n">students</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">UserProfile</span><span class="p">],</span>
            <span class="n">url_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;exercise&quot;</span><span class="p">,</span>
            <span class="n">ordinal</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">url</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_load_url</span><span class="p">(</span><span class="n">language</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">students</span><span class="p">,</span> <span class="n">url_name</span><span class="p">,</span> <span class="n">ordinal</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lti_service</span> <span class="ow">and</span> <span class="n">students</span><span class="p">:</span>
            <span class="n">lti</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_lti</span><span class="p">(</span><span class="n">students</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">user</span><span class="p">,</span> <span class="p">[],</span> <span class="n">request</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">lti</span><span class="o">.</span><span class="n">sign_get_query</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">url</span></div>


<div class="viewcode-block" id="LTIExercise.modify_post_parameters">
<a class="viewcode-back" href="../../exercise.html#exercise.exercise_models.LTIExercise.modify_post_parameters">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">modify_post_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">files</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">students</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">url</span><span class="p">):</span> <span class="c1"># pylint: disable=too-many-arguments</span>
        <span class="n">literals</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span><span class="n">val</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="n">lti</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_lti</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">students</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">add</span><span class="o">=</span><span class="n">literals</span><span class="p">)</span>
        <span class="n">data</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">lti</span><span class="o">.</span><span class="n">sign_post_parameters</span><span class="p">(</span><span class="n">url</span><span class="p">))</span></div>


<div class="viewcode-block" id="LTIExercise.get_service_url">
<a class="viewcode-back" href="../../exercise.html#exercise.exercise_models.LTIExercise.get_service_url">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_service_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">language</span><span class="p">):</span>
        <span class="n">url</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_service_url</span><span class="p">(</span><span class="n">language</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">url</span> <span class="ow">and</span> <span class="n">url</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;//&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;://&#39;</span> <span class="ow">in</span> <span class="n">url</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">url</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">lti_service</span><span class="o">.</span><span class="n">get_final_url</span><span class="p">(</span><span class="n">url</span><span class="p">)</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">can_regrade</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># the LTI protocol does not support regrading in the A+ way</span>
        <span class="c1"># (A+ would upload a submission to the service and expect it to be graded)</span>
        <span class="k">return</span> <span class="kc">False</span></div>



<span class="c1"># Note: One option would have been to create a common LTIExerciseBase class between</span>
<span class="c1"># legacy LTI and LTI 1.3, but the two protocols are fairly different, and the migrations</span>
<span class="c1"># from existing DB would have become somewhat complicated, so decided to go with</span>
<span class="c1"># separate classes, despite the price of having a bit of redundant code.</span>
<div class="viewcode-block" id="LTI1p3Exercise">
<a class="viewcode-back" href="../../exercise.html#exercise.exercise_models.LTI1p3Exercise">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">LTI1p3Exercise</span><span class="p">(</span><span class="n">BaseExercise</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Exercise hosted by external LTI 1.3 Tool.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">lti_service</span> <span class="o">=</span> <span class="n">DefaultForeignKey</span><span class="p">(</span><span class="n">LTI1p3Service</span><span class="p">,</span>
        <span class="n">verbose_name</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;LABEL_LTI_SERVICE&#39;</span><span class="p">),</span>
        <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">CASCADE</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">custom</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">(</span>
        <span class="n">verbose_name</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;LABEL_LTI_CUSTOM_PARAMETERS&#39;</span><span class="p">),</span>
        <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">help_text</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;LTI_CUSTOM_PARAMETERS_HELPTEXT&#39;</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="n">open_in_iframe</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">(</span>
        <span class="n">verbose_name</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;LABEL_OPEN_IN_IFRAME&#39;</span><span class="p">),</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">help_text</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;LTI_EXERCISE_OPEN_IN_IFRAME_HELPTEXT&#39;</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="k">class</span><span class="w"> </span><span class="nc">Meta</span><span class="p">:</span>
        <span class="n">verbose_name</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;MODEL_NAME_LTI1P3_EXERCISE&#39;</span><span class="p">)</span>
        <span class="n">verbose_name_plural</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;MODEL_NAME_LTI1P3_EXERCISE_PLURAL&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="LTI1p3Exercise.load">
<a class="viewcode-back" href="../../exercise.html#exercise.exercise_models.LTI1p3Exercise.load">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">load</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">request</span><span class="p">:</span> <span class="n">HttpRequest</span><span class="p">,</span>
            <span class="n">students</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">UserProfile</span><span class="p">],</span>
            <span class="n">url_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;exercise&quot;</span><span class="p">,</span>
            <span class="n">ordinal</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ExercisePage</span><span class="p">:</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">external_services.lti1p3</span><span class="w"> </span><span class="kn">import</span> <span class="n">prepare_lti1p3_initiate_login</span> <span class="c1"># pylint: disable=import-outside-toplevel</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">lti_service</span><span class="o">.</span><span class="n">enabled</span><span class="p">:</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;LTI_EXERCISE_ERROR_EXTERNAL_LTI_SERVICE_DISABLED&#39;</span><span class="p">))</span>
            <span class="k">raise</span> <span class="n">PermissionDenied</span><span class="p">(</span><span class="s2">&quot;The LTI service is disabled.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">students</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ExercisePage</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="n">parameters</span> <span class="o">=</span> <span class="n">prepare_lti1p3_initiate_login</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lti_service</span><span class="p">,</span> <span class="n">students</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">user</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">course_instance</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>

        <span class="c1"># Render launch button.</span>
        <span class="n">page</span> <span class="o">=</span> <span class="n">ExercisePage</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">page</span><span class="o">.</span><span class="n">content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">content</span>
        <span class="n">template</span> <span class="o">=</span> <span class="n">loader</span><span class="o">.</span><span class="n">get_template</span><span class="p">(</span><span class="s1">&#39;external_services/_launch.html&#39;</span><span class="p">)</span>
        <span class="n">page</span><span class="o">.</span><span class="n">content</span> <span class="o">+=</span> <span class="n">template</span><span class="o">.</span><span class="n">render</span><span class="p">({</span>
            <span class="s1">&#39;service&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">lti_service</span><span class="p">,</span>
            <span class="s1">&#39;service_label&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">lti_service</span><span class="o">.</span><span class="n">menu_label</span><span class="p">,</span>
            <span class="s1">&#39;url&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">lti_service</span><span class="o">.</span><span class="n">login_url</span><span class="p">,</span>
            <span class="s1">&#39;parameters&#39;</span><span class="p">:</span> <span class="n">parameters</span><span class="p">,</span>
            <span class="s1">&#39;exercise&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="p">,</span>
            <span class="s1">&#39;is_course_staff&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">course_instance</span><span class="o">.</span><span class="n">is_course_staff</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">),</span>
            <span class="s1">&#39;site&#39;</span><span class="p">:</span> <span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lti_service</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[:</span><span class="mi">3</span><span class="p">]),</span>
        <span class="p">})</span>
        <span class="k">return</span> <span class="n">page</span></div>


<div class="viewcode-block" id="LTI1p3Exercise.get_resource_link_id">
<a class="viewcode-back" href="../../exercise.html#exercise.exercise_models.LTI1p3Exercise.get_resource_link_id">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_resource_link_id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">course_module</span><span class="o">.</span><span class="n">course_instance</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">can_regrade</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span></div>



<div class="viewcode-block" id="StaticExercise">
<a class="viewcode-back" href="../../exercise.html#exercise.exercise_models.StaticExercise">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">StaticExercise</span><span class="p">(</span><span class="n">BaseExercise</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Static exercises are used for storing submissions on the server, but not automatically</span>
<span class="sd">    assessing them. Static exercises may be retrieved by other services through the API.</span>

<span class="sd">    Chapters should be used for non submittable content.</span>

<span class="sd">    Should be deprecated as a contradiction to A+ ideology.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">exercise_page_content</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">(</span>
        <span class="n">verbose_name</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;LABEL_EXERCISE_PAGE_CONTENT&#39;</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="n">submission_page_content</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">(</span>
        <span class="n">verbose_name</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;LABEL_SUBMISSION_PAGE_CONTENT&#39;</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="k">class</span><span class="w"> </span><span class="nc">Meta</span><span class="p">:</span>
        <span class="n">verbose_name</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;MODEL_NAME_STATIC_EXERCISE&#39;</span><span class="p">)</span>
        <span class="n">verbose_name_plural</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;MODEL_NAME_STATICE_EXERCISE_PLURAL&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="StaticExercise.load">
<a class="viewcode-back" href="../../exercise.html#exercise.exercise_models.StaticExercise.load">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">load</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">request</span><span class="p">:</span> <span class="n">HttpRequest</span><span class="p">,</span>
            <span class="n">students</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">UserProfile</span><span class="p">],</span>
            <span class="n">url_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;exercise&quot;</span><span class="p">,</span>
            <span class="n">ordinal</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ExercisePage</span><span class="p">:</span>
        <span class="n">page</span> <span class="o">=</span> <span class="n">ExercisePage</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">page</span><span class="o">.</span><span class="n">content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exercise_page_content</span>
        <span class="k">return</span> <span class="n">page</span></div>


<div class="viewcode-block" id="StaticExercise.grade">
<a class="viewcode-back" href="../../exercise.html#exercise.exercise_models.StaticExercise.grade">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">grade</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">submission</span><span class="p">,</span> <span class="n">request</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">no_penalties</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">url_name</span><span class="o">=</span><span class="s2">&quot;exercise&quot;</span><span class="p">):</span>
        <span class="n">page</span> <span class="o">=</span> <span class="n">ExercisePage</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">page</span><span class="o">.</span><span class="n">content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">submission_page_content</span>
        <span class="n">page</span><span class="o">.</span><span class="n">is_accepted</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="n">page</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_is_empty</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exercise_page_content</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">can_regrade</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span></div>



<div class="viewcode-block" id="build_upload_dir">
<a class="viewcode-back" href="../../exercise.html#exercise.exercise_models.build_upload_dir">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">build_upload_dir</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns the path to a directory where the attachment file should be saved.</span>
<span class="sd">    This is called every time a new ExerciseWithAttachment model is created.</span>

<span class="sd">    @param instance: the ExerciseWithAttachment object</span>
<span class="sd">    @param filename: the actual name of the submitted file</span>
<span class="sd">    @return: a path where the file should be stored, relative to MEDIA_ROOT directory</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="s2">&quot;course_instance_</span><span class="si">{:d}</span><span class="s2">/exercise_attachment_</span><span class="si">{:d}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">instance</span><span class="o">.</span><span class="n">course_instance</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
        <span class="n">instance</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
        <span class="n">safe_file_name</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="p">)</span></div>



<div class="viewcode-block" id="ExerciseWithAttachment">
<a class="viewcode-back" href="../../exercise.html#exercise.exercise_models.ExerciseWithAttachment">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">ExerciseWithAttachment</span><span class="p">(</span><span class="n">BaseExercise</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ExerciseWithAttachment is an exercise type where the exercise instructions</span>
<span class="sd">    are stored locally and the exercise will be graded by sending an additional</span>
<span class="sd">    attachment to the grader together with other POST data. The exercise page</span>
<span class="sd">    will contain a submission form for the files the user should submit if the</span>
<span class="sd">    files to be submitted are defined. Otherwise the instructions must contain</span>
<span class="sd">    the submission form.</span>

<span class="sd">    Could be deprecated as a contradiction to A+ purist ideology.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">files_to_submit</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span>
        <span class="n">verbose_name</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;LABEL_FILES_TO_SUBMIT&#39;</span><span class="p">),</span>
        <span class="n">max_length</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
        <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">help_text</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;EXERCISE_WITH_ATTACHMENT_FILES_TO_SUBMIT_HELPTEXT&#39;</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="n">attachment</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">FileField</span><span class="p">(</span>
        <span class="n">verbose_name</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;LABEL_ATTACHMENT&#39;</span><span class="p">),</span>
        <span class="n">upload_to</span><span class="o">=</span><span class="n">build_upload_dir</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">class</span><span class="w"> </span><span class="nc">Meta</span><span class="p">:</span>
        <span class="n">verbose_name</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;MODEL_NAME_EXERCISE_WITH_ATTACHMENT&#39;</span><span class="p">)</span>
        <span class="n">verbose_name_plural</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;MODEL_NAME_EXERCISE_WITH_ATTACHMENT_PLURAL&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="ExerciseWithAttachment.get_files_to_submit">
<a class="viewcode-back" href="../../exercise.html#exercise.exercise_models.ExerciseWithAttachment.get_files_to_submit">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_files_to_submit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a list of the file names that user should submit with this exercise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">files_to_submit</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="n">files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">files_to_submit</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;|&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">filename</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">files</span><span class="p">]</span></div>


<div class="viewcode-block" id="ExerciseWithAttachment.load">
<a class="viewcode-back" href="../../exercise.html#exercise.exercise_models.ExerciseWithAttachment.load">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">load</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">request</span><span class="p">:</span> <span class="n">HttpRequest</span><span class="p">,</span>
            <span class="n">students</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">UserProfile</span><span class="p">],</span>
            <span class="n">url_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;exercise&quot;</span><span class="p">,</span>
            <span class="n">ordinal</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ExercisePage</span><span class="p">:</span>
        <span class="n">page</span> <span class="o">=</span> <span class="n">ExercisePage</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">page</span><span class="o">.</span><span class="n">content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">content</span>

        <span class="c1"># Adds the submission form to the content if there are files to be</span>
        <span class="c1"># submitted. A template is used to avoid hard-coded HTML here.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_files_to_submit</span><span class="p">():</span>
            <span class="n">template</span> <span class="o">=</span> <span class="n">loader</span><span class="o">.</span><span class="n">get_template</span><span class="p">(</span><span class="s1">&#39;exercise/model/_file_submit_form.html&#39;</span><span class="p">)</span>
            <span class="n">context</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;files&#39;</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_files_to_submit</span><span class="p">()}</span>
            <span class="n">page</span><span class="o">.</span><span class="n">content</span> <span class="o">+=</span> <span class="n">template</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">page</span></div>


<div class="viewcode-block" id="ExerciseWithAttachment.modify_post_parameters">
<a class="viewcode-back" href="../../exercise.html#exercise.exercise_models.ExerciseWithAttachment.modify_post_parameters">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">modify_post_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">files</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">students</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">url</span><span class="p">):</span> <span class="c1"># pylint: disable=too-many-arguments</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adds the attachment file to post parameters.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">files</span><span class="p">[</span><span class="s1">&#39;content_0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attachment</span><span class="o">.</span><span class="n">path</span><span class="p">),</span>
            <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attachment</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="c1"># pylint: disable=consider-using-with</span>
        <span class="p">)</span></div>
</div>



<span class="k">def</span><span class="w"> </span><span class="nf">_delete_file</span><span class="p">(</span><span class="n">sender</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span> <span class="c1"># pylint: disable=unused-argument</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Deletes exercise attachment file after the exercise in database is removed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">instance</span><span class="o">.</span><span class="n">attachment</span><span class="o">.</span><span class="n">path</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="c1"># The file doesn&#39;t exist in storage</span>
        <span class="k">pass</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">default_storage</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_clear_cache</span><span class="p">(</span><span class="n">sender</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span> <span class="c1"># pylint: disable=unused-argument</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Clears parent&#39;s cached html if any.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">instance</span><span class="o">.</span><span class="n">parent</span><span class="p">:</span>
        <span class="n">ExerciseCache</span><span class="o">.</span><span class="n">invalidate</span><span class="p">(</span><span class="n">instance</span><span class="o">.</span><span class="n">parent</span><span class="p">)</span>


<span class="n">post_delete</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">_delete_file</span><span class="p">,</span> <span class="n">ExerciseWithAttachment</span><span class="p">)</span>
<span class="n">post_save</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">_clear_cache</span><span class="p">,</span> <span class="n">LearningObject</span><span class="p">)</span>


<div class="viewcode-block" id="ExerciseTask">
<a class="viewcode-back" href="../../exercise.html#exercise.exercise_models.ExerciseTask">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">ExerciseTask</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Asynchronous background tasks related to exercises.</span>
<span class="sd">    The task queue is implemented with Celery.</span>
<span class="sd">    For the time being this means ongoing mass regrade runs.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">TASK_TYPE</span> <span class="o">=</span> <span class="n">Enum</span><span class="p">([</span>
        <span class="p">(</span><span class="s1">&#39;REGRADE&#39;</span><span class="p">,</span> <span class="s1">&#39;regrade&#39;</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;REGRADE&#39;</span><span class="p">)),</span>
    <span class="p">])</span>
    <span class="n">exercise</span> <span class="o">=</span> <span class="n">DefaultForeignKey</span><span class="p">(</span><span class="s1">&#39;BaseExercise&#39;</span><span class="p">,</span>
        <span class="n">verbose_name</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;LABEL_EXERCISE&#39;</span><span class="p">),</span>
        <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">CASCADE</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">task_type</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span>
        <span class="n">verbose_name</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;LABEL_TASK_TYPE&#39;</span><span class="p">),</span>
        <span class="n">max_length</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span>
        <span class="n">choices</span><span class="o">=</span><span class="n">TASK_TYPE</span><span class="o">.</span><span class="n">choices</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="n">TASK_TYPE</span><span class="o">.</span><span class="n">REGRADE</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">task_id</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span>
        <span class="n">verbose_name</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;LABEL_TASK_ID&#39;</span><span class="p">),</span>
        <span class="n">max_length</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span>
        <span class="n">blank</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">class</span><span class="w"> </span><span class="nc">Meta</span><span class="p">:</span>
        <span class="n">verbose_name</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;MODEL_NAME_EXERCISE_TASK&#39;</span><span class="p">)</span>
        <span class="n">verbose_name_plural</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;MODEL_NAME_EXERCISE_TASK_PLURAL&#39;</span><span class="p">)</span>
        <span class="n">constraints</span> <span class="o">=</span> <span class="p">[</span><span class="n">models</span><span class="o">.</span><span class="n">UniqueConstraint</span><span class="p">(</span><span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;exercise&#39;</span><span class="p">,</span> <span class="s1">&#39;task_type&#39;</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;one_task_type_per_exercise&#39;</span><span class="p">)]</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, A+ development team.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>