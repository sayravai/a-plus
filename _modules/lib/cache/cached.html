

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>lib.cache.cached &mdash; A+ 1.28 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=3011ec97"></script>
      <script src="../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            A+
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <!-- Local TOC -->
              <div class="local-toc"></div>
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">A+</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">lib.cache.cached</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for lib.cache.cached</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">annotations</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">abc</span><span class="w"> </span><span class="kn">import</span> <span class="n">ABC</span><span class="p">,</span> <span class="n">abstractmethod</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">InitVar</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">io</span><span class="w"> </span><span class="kn">import</span> <span class="n">BytesIO</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pickle</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">time</span><span class="w"> </span><span class="kn">import</span> <span class="n">time</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">Any</span><span class="p">,</span>
    <span class="n">Callable</span><span class="p">,</span>
    <span class="n">cast</span><span class="p">,</span>
    <span class="n">ClassVar</span><span class="p">,</span>
    <span class="n">Collection</span><span class="p">,</span>
    <span class="n">Dict</span><span class="p">,</span>
    <span class="n">get_args</span><span class="p">,</span>
    <span class="n">get_origin</span><span class="p">,</span>
    <span class="n">Iterable</span><span class="p">,</span>
    <span class="n">Iterator</span><span class="p">,</span>
    <span class="n">List</span><span class="p">,</span>
    <span class="n">Optional</span><span class="p">,</span>
    <span class="n">Sequence</span><span class="p">,</span>
    <span class="n">Set</span><span class="p">,</span>
    <span class="n">Tuple</span><span class="p">,</span>
    <span class="n">Type</span><span class="p">,</span>
    <span class="n">TYPE_CHECKING</span><span class="p">,</span>
    <span class="n">TypeVar</span><span class="p">,</span>
    <span class="n">Union</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">django.db.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">Model</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.db.models.signals</span><span class="w"> </span><span class="kn">import</span> <span class="n">ModelSignal</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">.transact</span><span class="w"> </span><span class="kn">import</span> <span class="n">CacheTransactionManager</span>


<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;aplus.cached2&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="DBDataManager">
<a class="viewcode-back" href="../../../lib.cache.html#lib.cache.cached.DBDataManager">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">DBDataManager</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
<div class="viewcode-block" id="DBDataManager.fetch">
<a class="viewcode-back" href="../../../lib.cache.html#lib.cache.cached.DBDataManager.fetch">[docs]</a>
    <span class="nd">@abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">fetch</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Fetch data from the database for the added cache entries&quot;&quot;&quot;</span></div>


<div class="viewcode-block" id="DBDataManager.add">
<a class="viewcode-back" href="../../../lib.cache.html#lib.cache.cached.DBDataManager.add">[docs]</a>
    <span class="nd">@abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">proxy</span><span class="p">:</span> <span class="n">CacheBase</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add cache object to be fetched data for&quot;&quot;&quot;</span></div>
</div>



<span class="c1"># generation time, expiry time, dependency params, object state</span>
<span class="n">CacheData</span> <span class="o">=</span> <span class="n">Union</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">],</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span> <span class="n">Any</span><span class="p">]]</span>
<span class="n">ProxyID</span> <span class="o">=</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="o">...</span><span class="p">]]</span>
<span class="n">CacheBaseT</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s2">&quot;CacheBaseT&quot;</span><span class="p">,</span> <span class="n">bound</span><span class="o">=</span><span class="s2">&quot;CacheBase&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="ProxyManager">
<a class="viewcode-back" href="../../../lib.cache.html#lib.cache.cached.ProxyManager">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">ProxyManager</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Handles creating and building cache objects while trying to minimize</span>
<span class="sd">    the number of cache operations.</span>

<span class="sd">    proxies contains a list of proxies managed by this manager.</span>
<span class="sd">    fetched_data holds on to the data fetched from the cache.</span>
<span class="sd">    new_keys contains cache keys that were added to the manager since the</span>
<span class="sd">    last cache get.</span>
<span class="sd">    nstates contains new items to be saved to the cache on .save().</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">gen_start</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">proxies</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">ProxyID</span><span class="p">,</span> <span class="n">CacheBase</span><span class="p">]</span>
    <span class="n">fetched_data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="n">CacheData</span><span class="p">]]</span>
    <span class="n">new_keys</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
    <span class="n">nstates</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">CacheData</span><span class="p">]</span>
    <span class="n">new_proxies</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">CacheBase</span><span class="p">]</span>
    <span class="n">db_managers</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">DBDataManager</span><span class="p">],</span> <span class="n">DBDataManager</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">proxies</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">CacheBase</span><span class="p">]</span> <span class="o">=</span> <span class="p">()):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gen_start</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fetched_data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">proxies</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nstates</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">new_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">new_proxies</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db_managers</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">proxies</span><span class="p">)</span>

<div class="viewcode-block" id="ProxyManager.fetch">
<a class="viewcode-back" href="../../../lib.cache.html#lib.cache.cached.ProxyManager.fetch">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">fetch</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span> <span class="c1"># noqa: MC0001</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_keys</span><span class="p">:</span>
            <span class="k">def</span><span class="w"> </span><span class="nf">fetch</span><span class="p">(</span><span class="n">keys</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">used</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]):</span>
                <span class="n">used</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span>
                <span class="n">items</span> <span class="o">=</span> <span class="n">CacheTransactionManager</span><span class="p">()</span><span class="o">.</span><span class="n">get_many</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span>
                <span class="n">items</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="n">CacheData</span><span class="p">]],</span> <span class="n">items</span><span class="p">)</span>
                <span class="n">dependencies</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">next_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
                <span class="c1"># Get all dependencies</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
                    <span class="n">item</span> <span class="o">=</span> <span class="n">items</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">item</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">items</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="k">continue</span>
                    <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">gen_start</span><span class="p">):</span>
                        <span class="n">items</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="k">continue</span>

                    <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
                        <span class="n">dependency_keys</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="k">for</span> <span class="n">key_prefix</span><span class="p">,</span> <span class="n">postfixes</span> <span class="ow">in</span> <span class="n">item</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                            <span class="n">dependency_keys</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key_prefix</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">postfix</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">postfix</span> <span class="ow">in</span> <span class="n">postfixes</span><span class="p">)</span>

                        <span class="n">dependencies</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">dependency_keys</span>
                        <span class="n">next_keys</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">dependency_keys</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">used</span> <span class="ow">and</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fetched_data</span><span class="p">)</span>

                <span class="c1"># Fetch dependencies</span>
                <span class="k">if</span> <span class="n">next_keys</span><span class="p">:</span>
                    <span class="n">fetch</span><span class="p">(</span><span class="n">next_keys</span><span class="p">,</span> <span class="n">used</span><span class="p">)</span>

                <span class="c1"># Check dependencies for validity</span>
                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">dkeys</span> <span class="ow">in</span> <span class="n">dependencies</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">g</span><span class="p">,</span><span class="o">*</span><span class="n">_</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">CacheData</span><span class="p">,</span> <span class="n">items</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
                    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">dkeys</span><span class="p">:</span>
                        <span class="n">dependency</span> <span class="o">=</span> <span class="n">items</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">fetched_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">dependency</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">dependency</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">g</span><span class="p">:</span>
                            <span class="n">items</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                            <span class="k">break</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">fetched_data</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">items</span><span class="p">)</span>

            <span class="c1"># Get data from cache and check dependencies</span>
            <span class="n">fetch</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">new_keys</span><span class="p">,</span> <span class="nb">set</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">new_keys</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_proxies</span><span class="p">:</span>
            <span class="c1"># Add proxies to db data manager</span>
            <span class="n">changed</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">proxy</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_proxies</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">bcls</span><span class="p">,</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">proxy</span><span class="o">.</span><span class="n">_keys_with_cls</span><span class="p">:</span>
                    <span class="n">dbcls</span> <span class="o">=</span> <span class="n">bcls</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;DBCLS&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">dbcls</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="k">if</span> <span class="n">dbcls</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_managers</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">db_managers</span><span class="p">[</span><span class="n">dbcls</span><span class="p">]</span> <span class="o">=</span> <span class="n">dbcls</span><span class="p">()</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fetched_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">db_managers</span><span class="p">[</span><span class="n">dbcls</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">proxy</span><span class="p">)</span>
                        <span class="n">changed</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">dbcls</span><span class="p">)</span>

            <span class="c1"># Fetch db data</span>
            <span class="k">for</span> <span class="n">dbcls</span> <span class="ow">in</span> <span class="n">changed</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">db_managers</span><span class="p">[</span><span class="n">dbcls</span><span class="p">]</span><span class="o">.</span><span class="n">fetch</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">new_proxies</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span></div>


<div class="viewcode-block" id="ProxyManager.update">
<a class="viewcode-back" href="../../../lib.cache.html#lib.cache.cached.ProxyManager.update">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">proxies</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">CacheBase</span><span class="p">]</span> <span class="o">=</span> <span class="p">())</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">proxies</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
            <span class="p">(</span><span class="n">proxy</span><span class="o">.</span><span class="n">KEY_PREFIX</span><span class="p">,</span> <span class="n">proxy</span><span class="o">.</span><span class="n">_params</span><span class="p">,</span> <span class="n">proxy</span><span class="o">.</span><span class="n">_modifiers</span><span class="p">):</span> <span class="n">proxy</span>
            <span class="k">for</span> <span class="n">proxy</span> <span class="ow">in</span> <span class="n">proxies</span>
        <span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">new_keys</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">key</span> <span class="k">for</span> <span class="n">proxy</span> <span class="ow">in</span> <span class="n">proxies</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">proxy</span><span class="o">.</span><span class="n">_keys</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">proxy</span> <span class="ow">in</span> <span class="n">proxies</span><span class="p">:</span>
            <span class="n">proxy</span><span class="o">.</span><span class="n">_manager</span> <span class="o">=</span> <span class="bp">self</span></div>


<div class="viewcode-block" id="ProxyManager.resolve">
<a class="viewcode-back" href="../../../lib.cache.html#lib.cache.cached.ProxyManager.resolve">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">resolve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">proxies</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">CacheBase</span><span class="p">],</span> <span class="n">depth</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Resolve given proxies. Depth is how many layers (child proxies) down should be resolved. Negative depth</span>
<span class="sd">        means to resolve the whole proxy tree.</span>

<span class="sd">        NOTE: Doesn&#39;t resolve the children of already resolved proxies no matter the depth value.&quot;&quot;&quot;</span>
        <span class="k">while</span> <span class="n">proxies</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fetch</span><span class="p">()</span>

            <span class="n">fetched</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fetched_data</span>
            <span class="n">nstates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nstates</span>
            <span class="n">db_managers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_managers</span>
            <span class="k">for</span> <span class="n">proxy</span> <span class="ow">in</span> <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="ow">not</span> <span class="n">x</span><span class="o">.</span><span class="n">_resolved</span><span class="p">,</span> <span class="n">proxies</span><span class="p">):</span>
                <span class="n">proxy</span><span class="o">.</span><span class="n">_build</span><span class="p">(</span><span class="n">fetched</span><span class="p">,</span> <span class="n">nstates</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">db_managers</span><span class="p">)</span>

            <span class="n">depth</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">depth</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">break</span>

            <span class="n">proxies</span> <span class="o">=</span> <span class="p">[</span><span class="n">child</span> <span class="k">for</span> <span class="n">proxy</span> <span class="ow">in</span> <span class="n">proxies</span> <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">proxy</span><span class="o">.</span><span class="n">get_child_proxies</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">child</span><span class="o">.</span><span class="n">_resolved</span><span class="p">]</span></div>


<div class="viewcode-block" id="ProxyManager.save">
<a class="viewcode-back" href="../../../lib.cache.html#lib.cache.cached.ProxyManager.save">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">stored_states</span> <span class="o">=</span> <span class="n">CacheTransactionManager</span><span class="p">()</span><span class="o">.</span><span class="n">get_many</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nstates</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">save_states</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">nstate</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nstates</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># stored_state is None or a (float (time), Optional[bytes])-tuple like values in self.nstates</span>
            <span class="n">stored_state</span> <span class="o">=</span> <span class="n">stored_states</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="n">stored_state</span> <span class="ow">is</span> <span class="kc">None</span>
                <span class="ow">or</span> <span class="n">stored_state</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">nstate</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="p">):</span>
                <span class="n">save_states</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">nstate</span>

        <span class="n">CacheTransactionManager</span><span class="p">()</span><span class="o">.</span><span class="n">set_many</span><span class="p">(</span><span class="n">save_states</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nstates</span> <span class="o">=</span> <span class="p">{}</span></div>


<div class="viewcode-block" id="ProxyManager.get_or_create_proxy">
<a class="viewcode-back" href="../../../lib.cache.html#lib.cache.cached.ProxyManager.get_or_create_proxy">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_or_create_proxy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">CacheBaseT</span><span class="p">],</span> <span class="o">*</span><span class="n">params</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">modifiers</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span><span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="p">())</span> <span class="o">-&gt;</span> <span class="n">CacheBaseT</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return proxy object corresponding to cls and params from precreated or create a new proxy object if</span>
<span class="sd">        not found otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">proxy_id</span> <span class="o">=</span> <span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">KEY_PREFIX</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">modifiers</span><span class="p">)</span>
        <span class="n">proxy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">proxies</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">proxy_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">proxy</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">proxy</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">proxy</span><span class="p">(</span><span class="o">*</span><span class="n">params</span><span class="p">,</span> <span class="n">modifiers</span><span class="o">=</span><span class="n">modifiers</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">proxies</span><span class="p">[</span><span class="n">proxy_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">proxy</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">new_keys</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">key</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">proxy</span><span class="o">.</span><span class="n">_keys</span> <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fetched_data</span><span class="p">)</span>
            <span class="n">proxy</span><span class="o">.</span><span class="n">_manager</span> <span class="o">=</span> <span class="bp">self</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">new_proxies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">proxy</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">proxy</span> <span class="c1"># type: ignore</span></div>
</div>



<div class="viewcode-block" id="resolve_proxies">
<a class="viewcode-back" href="../../../lib.cache.html#lib.cache.cached.resolve_proxies">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">resolve_proxies</span><span class="p">(</span><span class="n">proxies</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">CacheBase</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Resolve proxies and save any newly generated ones&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">proxies</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">manager</span> <span class="o">=</span> <span class="n">proxies</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">_manager</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="n">manager</span> <span class="o">=</span> <span class="n">ProxyManager</span><span class="p">(</span><span class="n">proxies</span><span class="p">)</span>
        <span class="n">manager</span><span class="o">.</span><span class="n">resolve</span><span class="p">(</span><span class="n">proxies</span><span class="p">)</span>
        <span class="n">manager</span><span class="o">.</span><span class="n">save</span><span class="p">()</span></div>



<div class="viewcode-block" id="Pickler">
<a class="viewcode-back" href="../../../lib.cache.html#lib.cache.cached.Pickler">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Pickler</span><span class="p">(</span><span class="n">pickle</span><span class="o">.</span><span class="n">Pickler</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Custom pickler that returns persistent ids for cache objects&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buf</span> <span class="o">=</span> <span class="n">BytesIO</span><span class="p">()</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buf</span><span class="p">)</span>

<div class="viewcode-block" id="Pickler.persistent_id">
<a class="viewcode-back" href="../../../lib.cache.html#lib.cache.cached.Pickler.persistent_id">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">persistent_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">CacheBase</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">_params</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">_modifiers</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="Pickler.getvalue">
<a class="viewcode-back" href="../../../lib.cache.html#lib.cache.cached.Pickler.getvalue">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">getvalue</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">buf</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span></div>
</div>



<div class="viewcode-block" id="Unpickler">
<a class="viewcode-back" href="../../../lib.cache.html#lib.cache.cached.Unpickler">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Unpickler</span><span class="p">(</span><span class="n">pickle</span><span class="o">.</span><span class="n">Unpickler</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Custom unpickler that resolves persistent ids for cache objects created by the above pickler</span>
<span class="sd">    using the given proxy manager. Cache objects with the same params and modifiers will be set to</span>
<span class="sd">    the same instance&quot;&quot;&quot;</span>
    <span class="n">precreated</span><span class="p">:</span> <span class="n">ProxyManager</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">precreated</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buf</span> <span class="o">=</span> <span class="n">BytesIO</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buf</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">precreated</span> <span class="o">=</span> <span class="n">precreated</span>

<div class="viewcode-block" id="Unpickler.persistent_load">
<a class="viewcode-back" href="../../../lib.cache.html#lib.cache.cached.Unpickler.persistent_load">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">persistent_load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pid</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">precreated</span><span class="o">.</span><span class="n">get_or_create_proxy</span><span class="p">(</span><span class="n">pid</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">*</span><span class="n">pid</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">modifiers</span><span class="o">=</span><span class="n">pid</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span></div>
</div>



<span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
    <span class="c1"># This makes NoCache[T] and Varies[T] look like T to type checkers</span>
    <span class="n">NoCache</span> <span class="o">=</span> <span class="n">ClassVar</span>
    <span class="n">Varies</span> <span class="o">=</span> <span class="n">ClassVar</span>
<span class="k">else</span><span class="p">:</span>
    <span class="c1"># NoCache[T] is swapped with T in annotations by CacheMeta</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Generic</span>
    <span class="n">CacheT</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s2">&quot;CacheT&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="NoCache">
<a class="viewcode-back" href="../../../lib.cache.html#lib.cache.cached.NoCache">[docs]</a>
    <span class="k">class</span><span class="w"> </span><span class="nc">NoCache</span><span class="p">(</span><span class="n">Generic</span><span class="p">[</span><span class="n">CacheT</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Do not add the field to the cache&quot;&quot;&quot;</span></div>

<div class="viewcode-block" id="Varies">
<a class="viewcode-back" href="../../../lib.cache.html#lib.cache.cached.Varies">[docs]</a>
    <span class="k">class</span><span class="w"> </span><span class="nc">Varies</span><span class="p">(</span><span class="n">Generic</span><span class="p">[</span><span class="n">CacheT</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add the field to the cache separately for each object in the inheritance tree&quot;&quot;&quot;</span></div>



<div class="viewcode-block" id="get_cache_fields">
<a class="viewcode-back" href="../../../lib.cache.html#lib.cache.cached.get_cache_fields">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_cache_fields</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">]]:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="s2">&quot;__dict__&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(),</span> <span class="p">()</span>

    <span class="k">if</span> <span class="s2">&quot;_cached_fields&quot;</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s2">&quot;_cached_fields&quot;</span><span class="p">],</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s2">&quot;_varying_fields&quot;</span><span class="p">]</span>

    <span class="n">nocache_fields</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">cached_fields</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">varying_fields</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="n">annotations</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;__annotations__&#39;</span><span class="p">,</span> <span class="p">{})</span>
    <span class="k">if</span> <span class="n">annotations</span><span class="p">:</span>
        <span class="n">m_globals</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__module__</span><span class="p">]</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">m_globals</span><span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="p">]</span> <span class="o">=</span> <span class="bp">cls</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">ty</span> <span class="ow">in</span> <span class="n">annotations</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># get_type_hints returns base class annotations as well but we dont want those.</span>
            <span class="c1"># That also causes issues when the baseclasses use types that aren&#39;t imported</span>
            <span class="c1"># in the current class&#39; module. Easier to just resolve the types ourselves.</span>
            <span class="c1"># This is how typing._eval_type resolves the type annotations</span>
            <span class="k">if</span> <span class="n">ty</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ty</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ty</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="c1"># pylint: disable-next=eval-used</span>
                <span class="n">ty</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">ty</span><span class="p">,</span> <span class="n">m_globals</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>

            <span class="n">origin</span> <span class="o">=</span> <span class="n">get_origin</span><span class="p">(</span><span class="n">ty</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">origin</span> <span class="ow">is</span> <span class="n">NoCache</span><span class="p">:</span>
                <span class="n">nocache_fields</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
                <span class="c1"># Remove NoCache from annotations</span>
                <span class="bp">cls</span><span class="o">.</span><span class="vm">__annotations__</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_args</span><span class="p">(</span><span class="n">ty</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">origin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">ClassVar</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ty</span><span class="p">,</span> <span class="n">InitVar</span><span class="p">):</span>
                <span class="c1"># Add non-NoCache and non-ClassVar to cached fields list</span>
                <span class="n">cached_fields</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">origin</span> <span class="ow">is</span> <span class="n">Varies</span><span class="p">:</span>
                    <span class="n">varying_fields</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>

    <span class="c1"># Add the cache fields from parents that aren&#39;t loaded separately</span>
    <span class="n">parents</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;_parents&quot;</span><span class="p">,</span> <span class="p">())</span>
    <span class="n">proto_bases</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;_proto_bases&quot;</span><span class="p">,</span> <span class="p">())</span>
    <span class="k">for</span> <span class="n">base</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__bases__</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">base</span> <span class="ow">in</span> <span class="n">proto_bases</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="n">cached</span><span class="p">,</span> <span class="n">varying</span> <span class="o">=</span> <span class="n">get_cache_fields</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>
        <span class="n">varying_fields</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">varying</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">base</span> <span class="ow">in</span> <span class="n">parents</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="n">cached_fields</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">cached</span><span class="p">)</span>

    <span class="n">cached_fields</span> <span class="o">-=</span> <span class="n">nocache_fields</span>
    <span class="n">varying_fields</span> <span class="o">-=</span> <span class="n">nocache_fields</span>
    <span class="n">cached_fields</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">varying_fields</span><span class="p">)</span>

    <span class="c1"># Would use a set but we need the order of the keys in cached_fields to always be the same for caching</span>
    <span class="c1"># to work correctly</span>
    <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">cached_fields</span><span class="p">)),</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">varying_fields</span><span class="p">)</span></div>



<span class="n">ParamGenerator</span> <span class="o">=</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Model</span><span class="p">],</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="o">...</span><span class="p">]]]</span>
<span class="n">ParamGeneratorWithKwargs</span> <span class="o">=</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">ParamGenerator</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="o">...</span><span class="p">]]</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_invalidator</span><span class="p">(</span><span class="bp">cls</span><span class="p">:</span> <span class="n">CacheMeta</span><span class="p">,</span> <span class="n">attrs_or_generator</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="o">...</span><span class="p">],</span> <span class="n">ParamGenerator</span><span class="p">,</span> <span class="n">ParamGeneratorWithKwargs</span><span class="p">]):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">attr_getter</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">attr</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">attr_getter</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">attr</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">attr</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
            <span class="k">return</span> <span class="n">instance</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attrs_or_generator</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">callable</span><span class="p">(</span><span class="n">attrs_or_generator</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span> <span class="c1"># attrs</span>
        <span class="c1"># pylint: disable-next=unused-argument</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">inner</span><span class="p">(</span><span class="n">sender</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="n">params</span> <span class="o">=</span> <span class="p">(</span><span class="n">attr_getter</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span> <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">attrs_or_generator</span><span class="p">)</span> <span class="c1"># type: ignore</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">invalidate</span><span class="p">(</span><span class="o">*</span><span class="n">params</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attrs_or_generator</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span> <span class="c1"># generator with kwargs</span>
        <span class="n">generator</span><span class="p">,</span> <span class="n">input_kwargs</span> <span class="o">=</span> <span class="n">attrs_or_generator</span>

        <span class="c1"># pylint: disable-next=unused-argument</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">inner</span><span class="p">(</span><span class="n">sender</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">input_kwargs</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">}</span>
            <span class="n">param_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">params</span> <span class="ow">in</span> <span class="n">generator</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span> <span class="c1"># type: ignore</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
                    <span class="n">params</span> <span class="o">=</span> <span class="p">(</span><span class="n">params</span><span class="p">,)</span>
                <span class="n">param_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">invalidate_many</span><span class="p">(</span><span class="n">param_list</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span> <span class="c1"># generator</span>
        <span class="c1"># pylint: disable-next=unused-argument</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">inner</span><span class="p">(</span><span class="n">sender</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="n">param_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">params</span> <span class="ow">in</span> <span class="n">attrs_or_generator</span><span class="p">(</span><span class="n">instance</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
                    <span class="n">params</span> <span class="o">=</span> <span class="p">(</span><span class="n">params</span><span class="p">,)</span>
                <span class="n">param_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">invalidate_many</span><span class="p">(</span><span class="n">param_list</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">inner</span>


<div class="viewcode-block" id="CacheMeta">
<a class="viewcode-back" href="../../../lib.cache.html#lib.cache.cached.CacheMeta">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">CacheMeta</span><span class="p">(</span><span class="nb">type</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A metaclass for CacheBase to set the _cached_fields attribute automatically for each subclass</span>

<span class="sd">    Class variables:</span>
<span class="sd">    - KEY_PREFIX: prefix used for the cache key</span>
<span class="sd">    - NUM_PARAMS: number of cache parameters (i.e. the parameters given to CacheBase.get())</span>
<span class="sd">    - INVALIDATORS: A list of (Model, List[ModelSignal], ParamAttrsOrGenerator). Used to</span>
<span class="sd">    determine which database models invalidate the cache. See basetypes.py and points.py for examples on use.</span>
<span class="sd">    - PARENTS: Can be used to override the parent items in cache. In essence, this can be used to</span>
<span class="sd">    manually determine which parent classes should be fetched separately and which should be included in the</span>
<span class="sd">    this class&#39; cache. (Classes in PARENTS will be fetched separately)</span>
<span class="sd">    - PROTO_BASES: Base classes that are to be handled as protocols: their fields are not included in the</span>
<span class="sd">    cache.</span>
<span class="sd">    - DBCLS: DBDataManager subclass to be used for fetching data from the database.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Use PARENTS: Tuple[CacheMeta, ...] to manually determine the parent classes</span>
    <span class="n">KEY_PREFIX</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">NUM_PARAMS</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">INVALIDATORS</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span>
        <span class="n">Tuple</span><span class="p">[</span>
            <span class="n">Type</span><span class="p">[</span><span class="n">Model</span><span class="p">],</span>
            <span class="n">List</span><span class="p">[</span><span class="n">ModelSignal</span><span class="p">],</span>
            <span class="n">Union</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="o">...</span><span class="p">],</span> <span class="n">ParamGenerator</span><span class="p">,</span> <span class="n">ParamGeneratorWithKwargs</span><span class="p">]</span>
        <span class="p">]</span>
    <span class="p">]</span>
    <span class="n">DBCLS</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">DBDataManager</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_cached_fields</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
    <span class="n">_varying_fields</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
    <span class="n">_all_cached_fields</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
    <span class="n">_parents</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">CacheBase</span><span class="p">],</span> <span class="o">...</span><span class="p">]</span>
    <span class="n">_proto_bases</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">type</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>

    <span class="c1"># pylint: disable-next=too-many-locals</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">namespace</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">ncls</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">namespace</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="n">cacheable_classvars</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;KEY_PREFIX&quot;</span><span class="p">,</span> <span class="s2">&quot;NUM_PARAMS&quot;</span><span class="p">,</span> <span class="s2">&quot;INVALIDATORS&quot;</span><span class="p">)</span>
        <span class="n">missing_classvars</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">cacheable_classvars</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ncls</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">]</span>
        <span class="n">is_cacheable</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">missing_classvars</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cacheable_classvars</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">is_cacheable</span> <span class="ow">and</span> <span class="n">missing_classvars</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Instances (classes) of CacheMeta must have all of </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cacheable_classvars</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot; or none of them. </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> is missing </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">missing_classvars</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>

        <span class="n">cache_meta_mro</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">CacheMeta</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">base</span> <span class="k">for</span> <span class="n">base</span> <span class="ow">in</span> <span class="n">ncls</span><span class="o">.</span><span class="vm">__mro__</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">CacheMeta</span><span class="p">)]</span>
        <span class="n">cached_mro</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">CacheMeta</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">base</span> <span class="k">for</span> <span class="n">base</span> <span class="ow">in</span> <span class="n">cache_meta_mro</span> <span class="k">if</span> <span class="s2">&quot;KEY_PREFIX&quot;</span> <span class="ow">in</span> <span class="n">base</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">]</span>

        <span class="n">ncls</span><span class="o">.</span><span class="n">_proto_bases</span> <span class="o">=</span> <span class="n">ncls</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;PROTO_BASES&quot;</span><span class="p">,</span> <span class="p">())</span>

        <span class="k">if</span> <span class="s2">&quot;PARENTS&quot;</span> <span class="ow">in</span> <span class="n">ncls</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">:</span>
            <span class="n">parents</span> <span class="o">=</span> <span class="n">ncls</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s2">&quot;PARENTS&quot;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">base</span> <span class="ow">in</span> <span class="n">parents</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">CacheMeta</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;KEY_PREFIX&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">base</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base</span><span class="si">}</span><span class="s2"> is not a valid cache parent of </span><span class="si">{</span><span class="n">ncls</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">base</span> <span class="ow">in</span> <span class="n">ncls</span><span class="o">.</span><span class="n">_proto_bases</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base</span><span class="si">}</span><span class="s2"> cannot be both in PROTO_BASES and PARENTS of </span><span class="si">{</span><span class="n">ncls</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">ncls</span><span class="o">.</span><span class="n">_parents</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="o">*</span><span class="n">parents</span><span class="p">,</span> <span class="n">ncls</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">skip</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">base</span> <span class="ow">in</span> <span class="n">ncls</span><span class="o">.</span><span class="vm">__bases__</span><span class="p">:</span>
                <span class="k">if</span> <span class="s2">&quot;_parents&quot;</span> <span class="ow">in</span> <span class="n">base</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">:</span>
                    <span class="n">base_parents</span> <span class="o">=</span> <span class="n">base</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s2">&quot;_parents&quot;</span><span class="p">]</span>
                    <span class="n">skip</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">base2</span> <span class="k">for</span> <span class="n">base2</span> <span class="ow">in</span> <span class="n">base</span><span class="o">.</span><span class="vm">__bases__</span> <span class="k">if</span> <span class="n">base2</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">base_parents</span><span class="p">)</span>

            <span class="n">parents</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">base</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">cached_mro</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">base</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">skip</span><span class="p">:</span>
                    <span class="n">parents</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>
            <span class="n">ncls</span><span class="o">.</span><span class="n">_parents</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">parents</span><span class="p">)</span>

        <span class="n">ncls</span><span class="o">.</span><span class="n">_cached_fields</span><span class="p">,</span> <span class="n">ncls</span><span class="o">.</span><span class="n">_varying_fields</span> <span class="o">=</span> <span class="n">get_cache_fields</span><span class="p">(</span><span class="n">ncls</span><span class="p">)</span>
        <span class="n">ncls</span><span class="o">.</span><span class="n">_all_cached_fields</span> <span class="o">=</span> <span class="p">{</span><span class="n">f</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">ncls</span><span class="o">.</span><span class="n">_parents</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">c</span><span class="o">.</span><span class="n">_cached_fields</span><span class="p">}</span>

        <span class="k">if</span> <span class="s2">&quot;INVALIDATORS&quot;</span> <span class="ow">in</span> <span class="n">ncls</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">model</span><span class="p">,</span> <span class="n">signals</span><span class="p">,</span> <span class="n">attrs</span> <span class="ow">in</span> <span class="n">ncls</span><span class="o">.</span><span class="n">INVALIDATORS</span><span class="p">:</span>
                <span class="n">invalidator</span> <span class="o">=</span> <span class="n">_invalidator</span><span class="p">(</span><span class="n">ncls</span><span class="p">,</span> <span class="n">attrs</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">signal</span> <span class="ow">in</span> <span class="n">signals</span><span class="p">:</span>
                    <span class="n">signal</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">invalidator</span><span class="p">,</span> <span class="n">sender</span><span class="o">=</span><span class="n">model</span><span class="p">,</span> <span class="n">weak</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ncls</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_key_postfix</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">params</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_keys_with_cls</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">CacheBase</span><span class="p">],</span> <span class="nb">str</span><span class="p">]]:</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_parents</span><span class="p">:</span>
            <span class="n">id_str</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">_get_key_postfix</span><span class="p">(</span><span class="n">params</span><span class="p">[:</span><span class="n">p</span><span class="o">.</span><span class="n">NUM_PARAMS</span><span class="p">])</span>
            <span class="n">cache_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">p</span><span class="o">.</span><span class="n">KEY_PREFIX</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">id_str</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">keys</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">p</span><span class="p">,</span> <span class="n">cache_key</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">keys</span>

<div class="viewcode-block" id="CacheMeta.parameter_ids">
<a class="viewcode-back" href="../../../lib.cache.html#lib.cache.cached.CacheMeta.parameter_ids">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">parameter_ids</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">models</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="o">...</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Turn the cache parameters used to generate the data into ids that can be used</span>
<span class="sd">        to identify the original objects&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span> <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">models</span><span class="p">)</span></div>


<div class="viewcode-block" id="CacheMeta.invalidate">
<a class="viewcode-back" href="../../../lib.cache.html#lib.cache.cached.CacheMeta.invalidate">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">invalidate</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">models</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">cache_key</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_get_keys_with_cls</span><span class="p">(</span><span class="o">*</span><span class="bp">cls</span><span class="o">.</span><span class="n">parameter_ids</span><span class="p">(</span><span class="o">*</span><span class="n">models</span><span class="p">))[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Invalidating cached data for </span><span class="si">%s</span><span class="s2">[</span><span class="si">%s</span><span class="s2">]&quot;</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">cache_key</span><span class="p">)</span>
        <span class="c1"># The cache is invalid, if the invalidate time is greater than the generation time</span>
        <span class="c1"># The time is needed in case the cache is being generated at the same time:</span>
        <span class="c1"># otherwise the cache could be generated using old data and then saved, even though</span>
        <span class="c1"># that data was invalidated</span>
        <span class="n">CacheTransactionManager</span><span class="p">()</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">cache_key</span><span class="p">,</span> <span class="p">(</span><span class="n">time</span><span class="p">(),</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span></div>


<div class="viewcode-block" id="CacheMeta.invalidate_many">
<a class="viewcode-back" href="../../../lib.cache.html#lib.cache.cached.CacheMeta.invalidate_many">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">invalidate_many</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">models_iterable</span><span class="p">:</span> <span class="n">Collection</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span><span class="o">...</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">models_iterable</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">params_iterable</span> <span class="o">=</span> <span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">parameter_ids</span><span class="p">(</span><span class="o">*</span><span class="n">models</span><span class="p">)</span> <span class="k">for</span> <span class="n">models</span> <span class="ow">in</span> <span class="n">models_iterable</span><span class="p">)</span>
        <span class="n">cache_keys</span> <span class="o">=</span> <span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">_get_keys_with_cls</span><span class="p">(</span><span class="o">*</span><span class="n">params</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">params</span> <span class="ow">in</span> <span class="n">params_iterable</span><span class="p">]</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Invalidating cached data for </span><span class="si">%s%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">cache_keys</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="p">(),</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">CacheTransactionManager</span><span class="p">()</span><span class="o">.</span><span class="n">set_many</span><span class="p">({</span> <span class="n">key</span><span class="p">:</span> <span class="n">t</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">cache_keys</span> <span class="p">})</span></div>
</div>



<span class="n">Dependencies</span> <span class="o">=</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="s2">&quot;CacheBase&quot;</span><span class="p">],</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span><span class="o">...</span><span class="p">]]]</span>
<span class="n">T</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="n">bound</span><span class="o">=</span><span class="s2">&quot;CacheBase&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="CacheBase">
<a class="viewcode-back" href="../../../lib.cache.html#lib.cache.cached.CacheBase">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">CacheBase</span><span class="p">(</span><span class="n">metaclass</span><span class="o">=</span><span class="n">CacheMeta</span><span class="p">):</span>
    <span class="n">_keys_with_cls</span><span class="p">:</span> <span class="n">NoCache</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">CacheBase</span><span class="p">],</span> <span class="nb">str</span><span class="p">]]]</span>
    <span class="n">_keys</span><span class="p">:</span> <span class="n">NoCache</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span>
    <span class="n">_resolved</span><span class="p">:</span> <span class="n">NoCache</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span>
    <span class="n">_params</span><span class="p">:</span> <span class="n">NoCache</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="o">...</span><span class="p">]]</span>
    <span class="n">_modifiers</span><span class="p">:</span> <span class="n">NoCache</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="o">...</span><span class="p">]]</span>
    <span class="n">_generated_on</span><span class="p">:</span> <span class="n">Varies</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span>
    <span class="n">_expires_on</span><span class="p">:</span> <span class="n">Varies</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]]</span>
    <span class="c1"># This might not exist if the object wasn&#39;t created through a ProxyManager</span>
    <span class="n">_manager</span><span class="p">:</span> <span class="n">NoCache</span><span class="p">[</span><span class="n">ProxyManager</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;CacheBase classes cannot be instantiated normally. Use .get(...) or .proxy(...) instead.&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="CacheBase.post_get">
<a class="viewcode-back" href="../../../lib.cache.html#lib.cache.cached.CacheBase.post_get">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">post_get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">precreated</span><span class="p">:</span> <span class="n">ProxyManager</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Called after the object was loaded from cache. This is called for each</span>
<span class="sd">        separately cached object in the inheritance tree.</span>

<span class="sd">        This is just a useful hook, and does not have to be implemented.</span>
<span class="sd">        &quot;&quot;&quot;</span></div>


<div class="viewcode-block" id="CacheBase.post_build">
<a class="viewcode-back" href="../../../lib.cache.html#lib.cache.cached.CacheBase.post_build">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">post_build</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">precreated</span><span class="p">:</span> <span class="n">ProxyManager</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Called after the whole object has been built (each object in the inheritance</span>
<span class="sd">        tree has been loaded from the cache or generated).</span>

<span class="sd">        This is just a useful hook, and does not have to be implemented.</span>
<span class="sd">        &quot;&quot;&quot;</span></div>


<div class="viewcode-block" id="CacheBase.is_valid">
<a class="viewcode-back" href="../../../lib.cache.html#lib.cache.cached.CacheBase.is_valid">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">is_valid</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="CacheBase.populate_children">
<a class="viewcode-back" href="../../../lib.cache.html#lib.cache.cached.CacheBase.populate_children">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">populate_children</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">children</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_child_proxies</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_manager</span><span class="o">.</span><span class="n">resolve</span><span class="p">(</span><span class="n">children</span><span class="p">)</span></div>


<div class="viewcode-block" id="CacheBase.get_child_proxies">
<a class="viewcode-back" href="../../../lib.cache.html#lib.cache.cached.CacheBase.get_child_proxies">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_child_proxies</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">CacheBase</span><span class="p">]:</span>
        <span class="k">return</span> <span class="p">[]</span></div>


<div class="viewcode-block" id="CacheBase.as_proxy">
<a class="viewcode-back" href="../../../lib.cache.html#lib.cache.cached.CacheBase.as_proxy">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">as_proxy</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">T</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">T</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">proxy</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_modifiers</span><span class="p">)</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">__getstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_modifiers</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">__setstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Any</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setproxy</span><span class="p">(</span><span class="o">*</span><span class="n">data</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_getstate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span>
        <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="n">state</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">_cached_fields</span><span class="p">]</span>
        <span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_setstate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Any</span><span class="p">):</span>
        <span class="bp">cls</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">=</span> <span class="bp">cls</span>
        <span class="n">objdict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span>
        <span class="n">objdict</span><span class="p">[</span><span class="s2">&quot;_resolved&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_cached_fields</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
            <span class="n">objdict</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolved</span> <span class="ow">and</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">_all_cached_fields</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Lazy resolving </span><span class="si">%r</span><span class="s2"> due to missing </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
            <span class="n">resolve_proxies</span><span class="p">([</span><span class="bp">self</span><span class="p">])</span>
            <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">_all_cached_fields</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Lazy resolving loop for </span><span class="si">%r</span><span class="s2"> due to missing </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

        <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> not found in </span><span class="si">{</span><span class="bp">self</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">out</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">(&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolved</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;generated_on=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_generated_on&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;resolved=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_resolved&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">return</span> <span class="n">out</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;, params=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_params&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">, modifiers=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_modifiers&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_setproxy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">modifiers</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_resolved</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_params</span> <span class="o">=</span> <span class="n">params</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_modifiers</span> <span class="o">=</span> <span class="n">modifiers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_keys_with_cls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">_get_keys_with_cls</span><span class="p">(</span><span class="o">*</span><span class="n">params</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_keys_with_cls</span><span class="p">]</span>

<div class="viewcode-block" id="CacheBase.proxy">
<a class="viewcode-back" href="../../../lib.cache.html#lib.cache.cached.CacheBase.proxy">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">proxy</span><span class="p">(</span><span class="bp">cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">T</span><span class="p">],</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span> <span class="n">modifiers</span><span class="o">=</span><span class="p">())</span> <span class="o">-&gt;</span> <span class="n">T</span><span class="p">:</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">_setproxy</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">modifiers</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">obj</span></div>


<div class="viewcode-block" id="CacheBase.get">
<a class="viewcode-back" href="../../../lib.cache.html#lib.cache.cached.CacheBase.get">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get</span><span class="p">(</span><span class="bp">cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">T</span><span class="p">],</span> <span class="o">*</span><span class="n">all_params</span><span class="p">,</span> <span class="n">prefetch_children</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">T</span><span class="p">:</span>
        <span class="n">params</span><span class="p">,</span> <span class="n">modifiers</span> <span class="o">=</span> <span class="n">all_params</span><span class="p">[:</span><span class="bp">cls</span><span class="o">.</span><span class="n">NUM_PARAMS</span><span class="p">],</span> <span class="n">all_params</span><span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">NUM_PARAMS</span><span class="p">:]</span>
        <span class="n">params</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">parameter_ids</span><span class="p">(</span><span class="o">*</span><span class="n">params</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_get</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">modifiers</span><span class="p">,</span> <span class="n">prefetch_children</span><span class="o">=</span><span class="n">prefetch_children</span><span class="p">)</span></div>


    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_get</span><span class="p">(</span>
            <span class="bp">cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">T</span><span class="p">],</span>
            <span class="n">params</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span><span class="o">...</span><span class="p">],</span>
            <span class="n">modifiers</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span><span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="p">(),</span>
            <span class="n">prefetch_children</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
            <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">T</span><span class="p">:</span>
        <span class="n">precreated</span> <span class="o">=</span> <span class="n">ProxyManager</span><span class="p">()</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">precreated</span><span class="o">.</span><span class="n">get_or_create_proxy</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span> <span class="n">modifiers</span><span class="o">=</span><span class="n">modifiers</span><span class="p">)</span>
        <span class="n">precreated</span><span class="o">.</span><span class="n">resolve</span><span class="p">([</span><span class="n">obj</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">prefetch_children</span><span class="p">:</span>
            <span class="n">children</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">get_child_proxies</span><span class="p">()</span>
            <span class="n">precreated</span><span class="o">.</span><span class="n">resolve</span><span class="p">(</span><span class="n">children</span><span class="p">)</span>

        <span class="n">precreated</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">obj</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_build</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">cache_data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="n">CacheData</span><span class="p">]],</span>
            <span class="n">new_cache_data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">CacheData</span><span class="p">],</span>
            <span class="n">precreated</span><span class="p">:</span> <span class="n">ProxyManager</span><span class="p">,</span>
            <span class="n">db_managers</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">DBDataManager</span><span class="p">],</span> <span class="n">DBDataManager</span><span class="p">],</span>
            <span class="p">):</span>
        <span class="n">ocls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span>
        <span class="n">base_cls</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Set _resolved to true here to make sure that _get_data doesn&#39;t accidentally trigger lazy resolving</span>
        <span class="c1"># or recursively try to resolve self again</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_resolved</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">for</span> <span class="n">base_cls</span><span class="p">,</span> <span class="n">cache_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_keys_with_cls</span><span class="p">:</span>
            <span class="c1"># Trick python to use the base_cls&#39; versions of methods instead of the original class&#39;.</span>
            <span class="c1"># This should ensure that _get_data (and _generate_data) work correctly even if self</span>
            <span class="c1"># is actually an instance of a different class.</span>
            <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">=</span> <span class="n">base_cls</span>

            <span class="n">attrs</span> <span class="o">=</span> <span class="n">cache_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cache_key</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">attrs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">attrs</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">attrs</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">if</span> <span class="n">attrs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">unpickler</span> <span class="o">=</span> <span class="n">Unpickler</span><span class="p">(</span><span class="n">precreated</span><span class="p">,</span> <span class="n">attrs</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_setstate</span><span class="p">(</span><span class="n">unpickler</span><span class="o">.</span><span class="n">load</span><span class="p">())</span>
                <span class="k">except</span> <span class="ne">TypeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;_setstate TypeError with </span><span class="si">%s</span><span class="s2">[</span><span class="si">%s</span><span class="s2">]: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">base_cls</span><span class="p">,</span> <span class="n">cache_key</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
                    <span class="n">attrs</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># Generate new cache data</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">post_get</span><span class="p">(</span><span class="n">precreated</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">attrs</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
                <span class="n">dependencies</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_data</span><span class="p">(</span><span class="n">precreated</span><span class="p">,</span> <span class="n">db_managers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">base_cls</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;DBCLS&quot;</span><span class="p">)))</span>
                <span class="n">dependencies</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="n">dcls</span><span class="o">.</span><span class="n">KEY_PREFIX</span><span class="p">:</span> <span class="p">[</span><span class="n">dcls</span><span class="o">.</span><span class="n">_get_key_postfix</span><span class="p">(</span><span class="n">params</span><span class="p">)</span> <span class="k">for</span> <span class="n">params</span> <span class="ow">in</span> <span class="n">paramss</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">dcls</span><span class="p">,</span><span class="n">paramss</span> <span class="ow">in</span> <span class="n">dependencies</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="p">}</span>
                <span class="n">pickler</span> <span class="o">=</span> <span class="n">Pickler</span><span class="p">()</span>
                <span class="n">pickler</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_getstate</span><span class="p">())</span>
                <span class="n">new_cache_data</span><span class="p">[</span><span class="n">cache_key</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_generated_on</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expires_on</span><span class="p">,</span> <span class="n">dependencies</span><span class="p">,</span> <span class="n">pickler</span><span class="o">.</span><span class="n">getvalue</span><span class="p">())</span>

        <span class="c1"># Do not reset the class back if _get_data/unpickler changed the type</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span> <span class="ow">is</span> <span class="n">base_cls</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">=</span> <span class="n">ocls</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">post_build</span><span class="p">(</span><span class="n">precreated</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_data</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">precreated</span><span class="p">:</span> <span class="n">ProxyManager</span><span class="p">,</span>
            <span class="n">prefetched_data</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">DBDataManager</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dependencies</span><span class="p">:</span>
        <span class="n">gen_start</span> <span class="o">=</span> <span class="n">precreated</span><span class="o">.</span><span class="n">gen_start</span>
        <span class="n">gen_start_dt</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">gen_start</span><span class="p">))</span>
        <span class="n">cache_name</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">[</span><span class="si">%s</span><span class="s2">]&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Generating cached data for </span><span class="si">%s</span><span class="s2"> with ts </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">cache_name</span><span class="p">,</span> <span class="n">gen_start_dt</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_expires_on</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">dependencies</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_data</span><span class="p">(</span><span class="n">precreated</span><span class="o">=</span><span class="n">precreated</span><span class="p">,</span> <span class="n">prefetched_data</span><span class="o">=</span><span class="n">prefetched_data</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;_generated_on&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_generated_on</span> <span class="o">=</span> <span class="n">gen_start</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_generated_on</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">gen_start</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generated_on</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dependencies</span> <span class="ow">or</span> <span class="p">{}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_generate_data</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">precreated</span><span class="p">:</span> <span class="n">ProxyManager</span><span class="p">,</span> <span class="n">prefetched_data</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">DBDataManager</span><span class="p">]</span>
            <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dependencies</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate the data for self. Use precreated to get/create/resolve any additional cache objects&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Subclass of CacheBase (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">) needs to implement _generate_data&quot;</span>
        <span class="p">)</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, A+ development team.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>